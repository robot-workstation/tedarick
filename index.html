
Şunu dedin:
sana 8 tane kod vericem ve sorumu sorana kadar sadece tamam yaz

ChatGPT:
Tamam.


Şunu dedin:
<!-- index.html (Tedarick-G) -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- ✅ favicon -->
  <link rel="icon" href="https://www.sescibaba.com/Data/EditorFiles/urun_resim/G.png">

  <!-- ✅ title -->
  <title>Tedarick - G</title>

  <style>
    :root{
      color-scheme:dark;
      --popW:min(560px, 92vw);
      --popMaxH:calc(100vh - 24px);
      --popGap:10px;
      --popM:12px;
      --guideDur:1200ms;
    }

    html,body{min-height:100%;overflow-x:hidden}

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:#0b0d12;
      color:#eaeef7;
      font-size:15px;
      overscroll-behavior-x:none;
      touch-action:pan-y;
      overflow-y:auto;
    }

    .layout{
      flex:1;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      overflow:visible;
    }

    .siteHeader{ padding:10px 8px 0; background:#0b0d12; }
    .siteTitle{
      text-align:center;
      font-size:26px;
      font-weight:1300;
      letter-spacing:5.2px;
      padding:6px 0 8px;
    }

    aside{
      border-bottom:1px solid #1f2430;
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      background:#0b0d12;
      overflow:visible;
    }

    .topRow{
      width:100%;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:stretch;
      justify-content:flex-start;
    }

    .rowSep{
      height:1px;
      background:#1f2430;
      opacity:.7;
      margin:6px 2px 2px;
      border-radius:999px;
    }

    .listTitleBar{
      text-align:center;
      font-weight:1300;
      font-size:18px;
      letter-spacing:.085em;
      opacity:0.95;
      line-height:1.25;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:44px;
      padding:0 6px;
    }

    section.maincol{
      display:flex;
      flex-direction:column;
      gap:8px;
      background:#0b0d12;
      padding:0 8px 10px;
    }

    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:stretch;
      justify-content:flex-start;
      flex:1 1 auto;
    }

    button,.file{
      background:#111827;
      color:#eaeef7;
      border:1px solid #2a3140;
      border-radius:10px;
      font-weight:900;
      font-size:14px;
      height:36px;
      box-sizing:border-box;
      display:flex;
      align-items:center;
      justify-content:center;
      line-height:1;
    }
    button{padding:0 12px;cursor:pointer}
    button:hover,.file:hover{background:#1f2a44;border-color:#6b7da6}
    button:disabled{opacity:.55;cursor:not-allowed}
    button:disabled:hover{background:#111827;border-color:#2a3140}

    @keyframes guidePulse {
      0%   { box-shadow:0 0 0 rgba(147,197,253,0); border-color:#2a3140; }
      55%  { box-shadow:0 0 18px rgba(147,197,253,.65); border-color:#93c5fd; }
      100% { box-shadow:0 0 0 rgba(147,197,253,0); border-color:#2a3140; }
    }
    .guidePulse{ animation:guidePulse var(--guideDur, 1200ms) ease-in-out infinite; }

    .file{
      position:relative;
      justify-content:flex-start;
      gap:8px;
      padding:0 10px;
      user-select:none;
      cursor:pointer;
      max-width:520px;
      align-self:stretch;
    }
    .file input{display:none}
    .fbtn{white-space:nowrap}
    .fname{
      font-weight:800;
      opacity:.92;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:170px
    }
    .fname.hide{display:none!important}

    .ddWrap{position:relative;display:inline-flex}
    .ddMenu{
      display:none;
      position:absolute;
      left:0;
      top:calc(100% + 6px);
      width:100%;
      background:#0f1320;
      border:1px solid #2a3140;
      border-radius:12px;
      padding:6px;
      z-index:25;
      box-shadow:0 12px 30px rgba(0,0,0,.45);
      max-width:min(520px, 92vw);
    }
    .ddMenu.show{display:block}
    .ddItem{
      width:100%;
      text-align:left;
      background:#0b0d12;
      border:1px solid #1f2430;
      border-radius:10px;
      padding:9px 10px;
      font-weight:1000;
      font-size:14px;
      color:#eaeef7;
      cursor:pointer;
      box-sizing:border-box;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:8px;
      margin:6px 0;
    }
    .ddItem:hover{background:#111827;border-color:#2a3140}
    .ddItem[aria-disabled="true"]{opacity:.8;cursor:default;}
    .ddEmpty{height:48px;border-radius:10px;}

    .ibox{
      height:36px;
      min-height:36px;
      box-sizing:border-box;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
      padding:0 10px;
      border:1px solid #1f2430;
      border-radius:10px;
      background:#0f1320;
      flex:0 0 auto;
      margin-left:auto;
      max-width:100%;
      overflow-x:auto;
      overflow-y:hidden;
      scrollbar-width:thin;
    }

    .chip{
      padding:3px 9px;
      border:1px solid #2a3140;
      border-radius:999px;
      background:#0b0d12;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:1000;
      font-size:14px;
      line-height:1.1
    }
    .chip.ok{color:#86efac}
    .chip.bad{color:#fca5a5}
    .chip.unk{color:#fcd34d}
    .chip.muted{opacity:.88;font-weight:900}

    .brandList{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:6px 10px;
      align-content:flex-start;
      overscroll-behavior-x:none;
      touch-action:pan-y;
      align-items:center;
    }

    .brand{
      display:inline-flex;
      align-items:center;
      padding:7px 10px;
      border:1px solid #1f2430;
      border-radius:12px;
      background:#0f1320;
      cursor:pointer;
      user-select:none;
      width:max-content;
      max-width:100%;
    }
    .brand:hover{border-color:#2a3140}
    .brand.sel{background:#1f2a44;border-color:#6b7da6}

    @keyframes brandGlow {
      0%   { box-shadow:0 0 0 rgba(147,197,253,0); border-color:#1f2430; }
      40%  { box-shadow:0 0 18px rgba(147,197,253,.55); border-color:#93c5fd; }
      100% { box-shadow:0 0 0 rgba(147,197,253,0); border-color:#1f2430; }
    }
    .brandList.glow .brand{
      animation:brandGlow 900ms ease-out;
    }

    .bRow{display:flex;gap:8px;align-items:center;min-width:0;width:100%}
    .bNm{
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      font-weight:1100;font-size:15px;line-height:1.2;max-width:70vw;
    }
    .bCt{white-space:nowrap;opacity:.9;font-size:11px}

    .panel{padding:0;display:flex;flex-direction:column;gap:6px;overflow:visible}
    .tableWrap{
      overflow-y:auto;
      overflow-x:hidden;
      border:1px solid #1f2430;
      border-radius:12px;
      background:#0f1320;
      overscroll-behavior-x:none;
      touch-action:pan-y;
    }

    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{border-bottom:1px solid #1f2430;padding:9px 6px;text-align:center;vertical-align:middle;font-size:14px;line-height:1.1}
    td{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    th{position:sticky;top:0;z-index:2;background:#0b0d12;font-weight:1100;white-space:nowrap;overflow:hidden;text-overflow:clip;padding:7px 6px}
    tbody tr:hover{background:#111827}
    .left{text-align:left!important}

    td.nameCell{overflow:visible;text-overflow:clip;position:relative;z-index:1}
    td.nameCell .nm{display:inline-block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:9999px;position:relative;z-index:3}
    td.eanCell{overflow:visible;text-overflow:clip}
    td.seqCell{font-weight:1100}
    td.statusBold{font-weight:1100}
    td.flagBad{ color:#fca5a5 !important; font-weight:1200 !important; }

    a{color:#93c5fd;text-decoration:none}
    a:hover{text-decoration:underline}

    @media (max-width:980px){.fname{max-width:130px}}

    .modal{
      position:fixed;inset:0;display:none;
      background:rgba(0,0,0,.55);
      z-index:60;
      padding:18px;
    }

    .modalInner{
      width:min(980px,100%);
      background:#0f1320;
      border:1px solid #2a3140;
      border-radius:14px;
      box-shadow:0 12px 40px rgba(0,0,0,.55);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:var(--popMaxH);
      overflow:auto;
    }
    .modalInner.small{ width:var(--popW); }

    .modalBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-start;
      align-items:flex-start;
    }

    .tsoftText{
      font-weight:900;
      font-size:14px;
      line-height:1.45;
      padding:10px 12px;
      border:1px solid #2a3140;
      border-radius:12px;
      background:#0b0d12;
      overflow:visible;
      position:relative;
    }

    .miniSep{
      height:1px;
      background:#1f2430;
      opacity:.75;
      border-radius:999px;
      margin:6px 0 8px;
    }

    .popInner{ position:relative; padding-top:54px; }
    .popPickWrap{
      position:absolute;
      left:10px;
      top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
      z-index:80;
    }
    .popPick, .popDismiss{
      height:32px;
      padding:0 10px;
      border-radius:10px;
      font-weight:1000;
      font-size:13px;
      border:1px solid #2a3140;
      background:#111827;
      color:#eaeef7;
    }
    .popPick:hover, .popDismiss:hover{background:#1f2a44;border-color:#6b7da6}

    .popLinkTitle{
      color:#eaeef7;
      text-decoration:none;
      font-weight:1100;
      font-size:15px;
      line-height:1.2;
      display:inline-block;
      white-space:nowrap;
      overflow:visible;
      text-overflow:clip;
      position:relative;
      z-index:60;
      pointer-events:auto;
    }
    .popLinkTitle:hover{ text-decoration:underline; }

    .tsoftFlex{
      display:flex;
      gap:12px;
      align-items:stretch;
      overflow:visible;
    }
    .tsoftLeft{ flex:1 1 auto; min-width:0; overflow:visible; }

    .tsoftRight{
      flex:0 0 230px;
      max-width:230px;
      display:flex;
      justify-content:flex-end;
      align-items:flex-end;
      align-self:stretch;
      padding-top:0;
      margin-left:auto;
      position:relative;
      z-index:10;
    }

    .tsoftThumb{
      width:230px;
      height:150px;
      border:1px solid #2a3140;
      border-radius:10px;
      background:#0f1320;
      overflow:hidden;
      cursor:pointer;
      display:block;
      padding:0;
    }
    .tsoftThumb img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }

    .imgOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.78);
      z-index:90;
      padding:18px;
    }
    .imgOverlay.show{ display:flex; }

    .imgOverlay .lbWrap{
      transform:scale(.86);
      opacity:0;
      transition:transform 220ms ease, opacity 220ms ease;
      will-change:transform,opacity;
    }
    .imgOverlay.show .lbWrap{
      transform:scale(1);
      opacity:1;
    }

    .imgOverlay img{
      width:auto;
      height:auto;
      max-width:75vw;
      max-height:75vh;
      border-radius:10px;
      border:1px solid #2a3140;
      background:#0b0d12;
      box-shadow:0 18px 60px rgba(0,0,0,.65);
      cursor:pointer;
    }

    .imgOverlay.closing .lbWrap{
      transform:scale(.88);
      opacity:0;
    }

    .pasteWrap{position:relative}
    .pasteHint{
      position:absolute;
      left:12px;
      top:10px;
      z-index:3;
      pointer-events:none;
      font-weight:1100;
      font-size:14px;
      opacity:.95;
      padding:4px 10px;
      border:1px solid #2a3140;
      border-radius:999px;
      background:rgba(11,13,18,.75);
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      backdrop-filter:blur(4px);
    }
    .modal textarea{
      width:100%;
      height:220px;
      resize:vertical;
      box-sizing:border-box;
      background:#0b0d12;
      color:#eaeef7;
      border:1px solid #2a3140;
      border-radius:12px;
      padding:10px;
      font-weight:800;
      font-size:14px
    }
    #depoSpin{
      position:absolute;
      left:calc(50% + 100px);
      top:50%;
      transform:translate(-50%,-50%) scale(1.875);
      width:min(180px, 60%);
      opacity:.95;
      pointer-events:none;
      z-index:2;
      filter:drop-shadow(0 10px 24px rgba(0,0,0,.45));
      border-radius:6px;
    }
  </style>
</head>

<body>
  <main class="layout">

    <header class="siteHeader">
      <div class="siteTitle">Tedarick-G</div>
    </header>

    <aside>
      <div class="topRow">
        <div class="controls" id="leftControls">

          <div class="ddWrap" id="supplierWrap">
            <button id="supplierBtn" class="file" type="button" aria-expanded="false" title="Tedarikçi seç">
              <span class="fbtn" id="supplierLabel">1) Tedarikçi: Compel</span>
            </button>

            <div class="ddMenu" id="supplierMenu" role="menu" aria-hidden="true">
              <button type="button" class="ddItem" id="supplierCompelItem">Compel</button>
              <button type="button" class="ddItem" id="supplierAkalinItem">Akalın</button>
              <button type="button" class="ddItem" id="supplierAddBtn">Tedarikçi ekle</button>
              <div class="ddEmpty"></div>
            </div>
          </div>

          <button id="brandHintBtn" class="file" type="button" title="Marka kutularını işaretle">
            <span class="fbtn">2) Marka Seç</span>
          </button>

          <label class="file" id="sescBox" title="T-Soft Stok (CSV)">
            <span class="fbtn">3) T-Soft Stok</span>
            <span class="fname hide" id="n2">Yükle</span>
            <input id="f2" type="file" accept=".csv,text/csv">
          </label>

          <button id="depoBtn" class="file" type="button" title="Aide Stok">
            <span class="fbtn">4) Aide Stok</span>
            <span class="fname hide" id="n4">Yükle</span>
          </button>

          <button id="go" title="Listele">Listele</button>
          <button id="dl1" disabled>CSV Çıktı</button>
        </div>

        <div class="ibox" id="infoBox">
          <span class="chip muted" id="brandStatus">Markalar yükleniyor…</span>
          <span class="chip ok" id="stChip" style="display:none"></span>
          <span class="chip" id="l1Chip">Compel:-</span>
          <span class="chip" id="l2Chip">T-Soft:-</span>
          <span class="chip" id="l4Chip">Aide:-</span>
          <span class="chip muted" id="sum">✓0 • ✕0</span>
        </div>
      </div>

      <div class="rowSep" aria-hidden="true"></div>
      <div class="brandList" id="brandList"></div>
    </aside>

    <section class="maincol">
      <section class="panel results">
        <div class="tableWrap"><table id="t1"></table></div>
      </section>

      <section class="panel unmatched" id="unmatchedSection" style="display:none">
        <div class="rowSep" aria-hidden="true"></div>
        <div class="listTitleBar" id="unmatchedTitle">Eşleşmeyen Ürünler Listesi</div>
        <div class="tableWrap"><table id="t2"></table></div>
      </section>
    </section>

  </main>

  <div class="imgOverlay" id="imgOverlay" aria-hidden="true">
    <div class="lbWrap">
      <img id="imgOverlayImg" alt="Önizleme">
    </div>
  </div>

  <div class="modal" id="tsoftModal" aria-hidden="true">
    <div class="modalInner small popInner" id="tsoftInner">
      <div class="popPickWrap">
        <button id="tsoftClose" class="popPick" type="button">products.csv Yükle</button>
        <button id="tsoftDismiss" class="popDismiss" type="button">Kapat</button>
      </div>

      <div class="tsoftText">
        <div class="tsoftFlex">
          <div class="tsoftLeft">
            <a
              class="popLinkTitle"
              href="https://sescibaba-com.tsoftpanel.com/frame/app-store/app.csvexport/products/export"
              target="_blank"
              rel="noopener"
              title="Yeni sekmede aç"
            >T-Soft &gt; Ürünler &gt; Excel Ürün Sihirbazı &gt; Exel Ürün Dışa Aktar</a>

            <div class="miniSep" aria-hidden="true"></div>

            <div class="tsoftCols">
              →Web Servis Kodu<br>
              →Ürün Adı<br>
              →Tedarikçi Ürün Kodu<br>
              →Barkod<br>
              →Stok<br>
              →Marka<br>
              →SEO Link
            </div>
          </div>

          <div class="tsoftRight" aria-label="Yardım görseli">
            <button class="tsoftThumb" id="tsoftThumb" type="button" title="Büyüt">
              <img
                id="tsoftThumbImg"
                src="https://www.sescibaba.com/Data/EditorFiles/urun_resim/Ekran-Resmi-2026-02-19-212136.png"
                alt="T-Soft dışa aktar ekran görüntüsü"
                loading="lazy"
              >
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="depoModal" aria-hidden="true">
    <div class="modalInner small" id="depoInner">
      <div class="modalBtns">
        <button id="depoLoad" type="button">Yükle</button>
        <button id="depoPasteBtn" type="button">Yapıştır</button>
        <button id="depoClear" type="button">Temizle</button>
        <button id="depoClose" type="button">Kapat</button>
      </div>

      <div class="pasteWrap">
        <div class="pasteHint">Buraya Yapıştır</div>
        <textarea id="depoPaste"></textarea>
        <img id="depoSpin" src="https://www.sescibaba.com/Data/EditorFiles/urun_resim/Aidestek.webp" alt="">
      </div>
    </div>
  </div>

  <datalist id="wsCodes"></datalist>
  <datalist id="supCodes"></datalist>

  <script type="module">
    (() => {
      const thumbBtn = document.getElementById('tsoftThumb');
      const thumbImg = document.getElementById('tsoftThumbImg');
      const overlay = document.getElementById('imgOverlay');
      const overlayImg = document.getElementById('imgOverlayImg');

      if (!thumbBtn || !thumbImg || !overlay || !overlayImg) return;

      let closingTimer = null;

      const open = () => {
        if (closingTimer) { clearTimeout(closingTimer); closingTimer = null; }
        overlay.classList.remove('closing');
        overlayImg.src = thumbImg.currentSrc || thumbImg.src;
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');
      };

      const close = () => {
        overlay.classList.add('closing');
        closingTimer = setTimeout(() => {
          overlay.classList.remove('show');
          overlay.classList.remove('closing');
          overlay.setAttribute('aria-hidden', 'true');
          overlayImg.removeAttribute('src');
          closingTimer = null;
        }, 220);
      };

      thumbBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); open(); });
      overlay.addEventListener('click', (e) => { e.preventDefault(); close(); });

      addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay.classList.contains('show')) close();
      });

      const modal = document.getElementById('tsoftModal');
      const dismiss = document.getElementById('tsoftDismiss');
      if (modal && dismiss) {
        dismiss.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          modal.style.display = 'none';
          modal.setAttribute('aria-hidden', 'true');
        });
      }
    })();
  </script>

  <script type="module" src="./js/app.js"></script>
</body>
</html>

ChatGPT:
Tamam.


Şunu dedin:
export const TR='tr-TR';
export const esc=s=>(s??'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
export const T=s=>(s??'').toString().trim();
export const D=s=>(s??'').toString().replace(/[^\d]/g,'').trim();
export const nowISO=()=>new Date().toISOString();

export function detectDelimiter(h){
  const c=['\t',';',',','|'];let best=c[0],m=-1;
  for(const d of c){const k=h.split(d).length-1;if(k>m){m=k;best=d}}
  return best
}

export function parseDelimited(text){
  const lines=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
  const first=lines.find(x=>x.trim())||'';const delim=detectDelimiter(first);
  const split=line=>{
    const out=[];let cur='',q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){if(q&&line[i+1]==='"'){cur+='"';i++}else q=!q}
      else if(!q&&ch===delim){out.push(cur);cur=''}
      else cur+=ch
    }
    out.push(cur);return out.map(v=>v.trim())
  };
  let hdr=null,rows=[];
  for(const line of lines){
    if(!line||!line.trim())continue;
    if(!hdr){hdr=split(line);continue}
    const vals=split(line),obj={};
    for(let i=0;i<hdr.length;i++)obj[hdr[i]]=vals[i]??'';
    rows.push(obj)
  }
  return{hdr:hdr||[],rows}
}

export const normHeader=h=>(h??'').toString().trim().toLocaleUpperCase(TR).replace(/\s+/g,' ');
export function pickColumn(rowObj,wanted){
  const map=new Map(Object.keys(rowObj).map(k=>[normHeader(k),k]));
  for(const w of wanted){const k=map.get(normHeader(w));if(k)return k}
  return null
}

export function downloadBlob(filename,blob){
  const url=URL.createObjectURL(blob),a=document.createElement('a');
  a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1200)
}

export function toCSV(rows,cols,delimiter=','){
  const q=v=>{
    v=(v??'').toString();
    return(v.includes('"')||v.includes('\n')||v.includes('\r')||v.includes(delimiter))?('"'+v.replace(/"/g,'""')+'"'):v
  };
  return cols.map(q).join(delimiter)+'\n'+rows.map(r=>cols.map(c=>q(r[c])).join(delimiter)).join('\n')
}

export async function readFileText(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result);
    fr.onerror=()=>rej(fr.error);
    fr.readAsText(file,'UTF-8')
  })
}

export function stockToNumber(raw,{source}={}){
  const s=(raw??'').toString().trim();if(!s)return 0;
  if(source==='products'&&s==='-')return 0;
  const up=s.toLocaleUpperCase(TR);
  if(source==='compel'){
    if(/(STOK\s*YOK|YOK|TÜKEND[İI]|TUKENDI|OUT\s*OF\s*STOCK|NONE|N\/A|NA)/i.test(up))return 0;
    if(/(VAR|STOKTA|MEVCUT|AVAILABLE|IN\s*STOCK|EVET|YES|TRUE)/i.test(up))return 1;
  }
  let t=s;
  if(t.includes('.')&&t.includes(','))t=t.replace(/\./g,'').replace(/,/g,'.');
  else t=t.replace(/,/g,'.');
  t=t.replace(/[^0-9.\-]/g,'');
  const n=parseFloat(t);
  return Number.isFinite(n)?n:0
}
export const inStock=(raw,opts)=>stockToNumber(raw,opts)>0;

ChatGPT:
Tamam.


Şunu dedin:
// js/render.js
import { esc } from './utils.js';
import { COLS } from './match.js';

const $ = id => document.getElementById(id);

const colGrp = w => <colgroup>${w.map(x => <col style="width:${x}%">).join('')}</colgroup>;

// ✅ 1. tablo başlık metinleri (görünen label’lar)
const HDR1 = {
  "Sıra No": "Sıra",
  "Marka": "Marka",
  "Ürün Adı (Compel)": "Compel Ürün Adı",
  "Ürün Adı (T-Soft)": "Tsoft Ürün Adı",
  "Ürün Kodu (Compel)": "Compel Ürün Kodu",
  "Ürün Kodu (T-Soft)": "T-Soft Ürün Kodu",
  "Stok (Compel)": "Compel",
  "Stok (Depo)": "Depo",
  "Stok (T-Soft)": "T-Soft",
  "Stok Durumu": "Stok Durumu",
  "EAN (Compel)": "Compel EAN",
  "EAN (T-Soft)": "T-Soft EAN",
  "EAN Durumu": "EAN Durumu"
};

const disp = c => HDR1[c] || c;

const fmtHdr = s => {
  s = (s ?? '').toString();
  const m = s.match(/^(.*?)(\s*\([^)]*\))\s*$/);
  if (!m) return esc(s);
  return <span class="hMain">${esc(m[1].trimEnd())}</span> <span class="hParen">${esc(m[2].trim())}</span>;
};

/* ✅ pulse css'ini JS ile inject (index.html değiştirmeyelim) */
let _pulseCssAdded = false;
function ensurePulseCss() {
  if (_pulseCssAdded) return;
  _pulseCssAdded = true;
  const st = document.createElement('style');
  st.textContent = 
@keyframes namePulse {
  0%   { text-shadow: 0 0 0 rgba(134,239,172,0); }
  55%  { text-shadow: 0 0 14px rgba(134,239,172,.75); }
  100% { text-shadow: 0 0 0 rgba(134,239,172,0); }
}
.namePulse {
  animation: namePulse 1000ms ease-in-out infinite;
  will-change: text-shadow;
}
;
  document.head.appendChild(st);
}
ensurePulseCss();

const cellName = (txt, href, pulse = false) => {
  const v = (txt ?? '').toString();
  const u = href || '';
  const cls = nm${pulse ? ' namePulse' : ''};
  return u
    ? <a class="${cls}" href="${esc(u)}" target="_blank" rel="noopener" title="${esc(v)}">${esc(v)}</a>
    : <span class="${cls}" title="${esc(v)}">${esc(v)}</span>;
};

let _raf = 0, _bound = false;
const sched = () => { if (_raf) cancelAnimationFrame(_raf); _raf = requestAnimationFrame(adjustLayout); };
const firstEl = td => td?.querySelector('.cellTxt,.nm,input,button,select,div') || null;

function fitHeaderText(tableId) {
  const t = $(tableId); if (!t) return;
  const ths = t.querySelectorAll('thead th');
  for (const th of ths) {
    const sp = th.querySelector('.hTxt'); if (!sp) continue;
    sp.style.transform = 'scaleX(1)';
    const avail = Math.max(10, th.clientWidth - 2);
    const need = sp.scrollWidth || 0;
    const s = need > avail ? (avail / need) : 1;
    sp.style.transform = scaleX(${s});
  }
}

function adjustLayout() {
  _raf = 0;
  fitHeaderText('t1'); fitHeaderText('t2');

  const applyNameFit = (tableId) => {
    const t = $(tableId); if (!t) return;
    const rows = t.querySelectorAll('tbody tr'), G = 6;
    for (const tr of rows) {
      const nameTds = tr.querySelectorAll('td.nameCell'); if (!nameTds.length) continue;
      for (let i = nameTds.length - 1; i >= 0; i--) {
        const td = nameTds[i], nm = td.querySelector('.nm'); if (!nm) continue;
        const next = td.nextElementSibling;
        const tdR = td.getBoundingClientRect(), nmR = nm.getBoundingClientRect();
        let maxRight = tdR.right - G;
        if (next) {
          const el = firstEl(next);
          if (el) { const r = el.getBoundingClientRect(); maxRight = Math.min(tdR.right + next.getBoundingClientRect().width, r.left - G); }
          else maxRight = next.getBoundingClientRect().right - G;
        }
        nm.style.maxWidth = Math.max(40, maxRight - nmR.left) + 'px';
      }
    }
  };

  applyNameFit('t1');
  applyNameFit('t2');

  if (!_bound) { _bound = true; addEventListener('resize', sched); }
}

export function createRenderer({ ui } = {}) {
  function render(R, Ux, depotReady) {
    /* =========================
       ✅ 1. Liste (t1)
       ========================= */
    const W1 = [4, 8, 14, 14, 7, 7, 6, 6, 6, 6, 8, 8, 6];

    const head = COLS.map(c => {
      const l = disp(c);
      return <th title="${esc(l)}"><span class="hTxt">${fmtHdr(l)}</span></th>;
    }).join('');

    const body = (R || []).map(r => <tr>${COLS.map((c, idx) => {
      const v = r[c] ?? '';
      if (c === "Ürün Adı (Compel)") return <td class="left nameCell">${cellName(v, r._clink || '')}</td>;
      if (c === "Ürün Adı (T-Soft)") return <td class="left nameCell">${cellName(v, r._seo || '')}</td>;

      const seq = idx === 0, sd = c === "Stok Durumu", ed = c === "EAN Durumu";
      const ean = c === "EAN (Compel)" || c === "EAN (T-Soft)";

      const isBad = (sd && String(v || '') === 'Hatalı') || (ed && String(v || '') === 'Eşleşmedi');
      const cls = [
        seq ? 'seqCell' : '',
        sd || ed ? 'statusBold' : '',
        ean ? 'eanCell' : '',
        isBad ? 'flagBad' : ''
      ].filter(Boolean).join(' ');

      const title = (c === "Stok (Depo)" && depotReady)
        ? ${v} (Depo Toplam: ${r._draw ?? '0'})
        : v;

      return <td class="${cls}" title="${esc(title)}"><span class="cellTxt">${esc(v)}</span></td>;
    }).join('')}</tr>).join('');

    $('t1').innerHTML = colGrp(W1) + <thead><tr>${head}</tr></thead><tbody>${body}</tbody>;

    /* =========================
       ✅ 2. Liste (t2 - Eşleşmeyenler)
       ========================= */
    const sec = $('unmatchedSection');
    const ut = $('unmatchedTitle');
    if (ut) ut.textContent = 'Compel, T-Soft ve Aide Eşleşmeyen Ürünler Listesi';

    const U = Array.isArray(Ux) ? Ux : [];

    if (!U.length) {
      if (sec) sec.style.display = 'none';
    } else {
      if (sec) sec.style.display = '';
      const UCOLS = ["Sıra", "Marka", "Compel Ürün Adı", "T-Soft Ürün Adı", "Depo Ürün Adı"];
      const W2 = [6, 12, 26, 28, 28];

      const head2 = UCOLS.map(c =>
        <th title="${esc(c)}"><span class="hTxt">${fmtHdr(c)}</span></th>
      ).join('');

      const body2 = U.map((r, i) => {
        const seq = r["Sıra"] ?? String(i + 1);
        const brand = r["Marka"] ?? '';

        const cNm = r["Compel Ürün Adı"] ?? '';
        const cLn = r._clink || '';
        const cPulse = !!r._pulseC;

        const tNm = r["T-Soft Ürün Adı"] ?? '';
        const tLn = r._seo || '';

        const dNm = r["Depo Ürün Adı"] ?? '';
        const dPulse = !!r._pulseD;

        const compelCell = cNm ? cellName(cNm, cLn, cPulse) : <span class="cellTxt">—</span>;
        const tsoftCell  = tNm ? cellName(tNm, tLn, false) : <span class="cellTxt">—</span>;
        const depoCell   = dNm
          ? <span class="cellTxt${dPulse ? ' namePulse' : ''}" title="${esc(dNm)}">${esc(dNm)}</span>
          : <span class="cellTxt">—</span>;

        return <tr id="u_${i}">
          <td class="seqCell" title="${esc(seq)}"><span class="cellTxt">${esc(seq)}</span></td>
          <td title="${esc(brand)}"><span class="cellTxt">${esc(brand)}</span></td>
          <td class="left nameCell">${compelCell}</td>
          <td class="left nameCell">${tsoftCell}</td>
          <td class="left">${depoCell}</td>
        </tr>;
      }).join('');

      $('t2').innerHTML = colGrp(W2) + <thead><tr>${head2}</tr></thead><tbody>${body2}</tbody>;
    }

    const matched = (R || []).filter(x => x._m).length;
    ui?.setChip?.('sum', ✓${matched} • ✕${(R || []).length - matched}, 'muted');

    const dl1 = $('dl1');
    if (dl1) dl1.disabled = !(R || []).length;

    sched();
  }

  return { render };
}

ChatGPT:
Tamam.


Şunu dedin:
// js/match.js
import { TR, T, D, nowISO, inStock } from './utils.js';

const $ = id => document.getElementById(id);

/* =========================
   ✅ Eşleştirme Modülü
   ========================= */

export const COLS = [
  "Sıra No", "Marka",
  "Ürün Adı (Compel)", "Ürün Adı (T-Soft)",
  "Ürün Kodu (Compel)", "Ürün Kodu (T-Soft)",
  "Stok (Compel)", "Stok (Depo)", "Stok (T-Soft)", "Stok Durumu",
  "EAN (Compel)", "EAN (T-Soft)", "EAN Durumu"
];

const ALIAS = new Map([
  ['ALLEN & HEATH', 'ALLEN HEATH'],
  ['MARANTZ PROFESSIONAL', 'MARANTZ'],
  ['RUPERT NEVE DESIGNS', 'RUPERT NEVE'],
  ['RØDE', 'RODE'],
  ['RØDE X', 'RODE']
]);

const bRaw = s => (s ?? '').toString().trim().toLocaleUpperCase(TR).replace(/\s+/g, ' ');
const B = s => ALIAS.get(bRaw(s)) || bRaw(s);
const Bx = s => bRaw(s);

export const normBrand = B;

const safeUrl = u => { u = T(u); if (!u || /^\s*javascript:/i.test(u)) return ''; return u; };
const SEO = 'https://www.sescibaba.com/';
const normSeo = raw => {
  let u = T(raw);
  if (!u || /^\s*javascript:/i.test(u)) return '';
  if (/^https?:\/\//i.test(u)) return u;
  if (/^www\./i.test(u)) return 'https://' + u;
  if (/^sescibaba\.com/i.test(u)) return 'https://' + u;
  return SEO + u.replace(/^\/+/, '');
};

const eans = v => {
  v = (v ?? '').toString().trim();
  if (!v) return [];
  return v.split(/[^0-9]+/g).map(D).filter(x => x.length >= 8);
};

export function createMatcher({ getDepotAgg, isDepotReady } = {}) {
  // data
  let L1 = [], L2 = [], L2all = [];
  let C1 = {}, C2 = {};

  // mapping + indexes
  let map = { meta: { version: 1, createdAt: nowISO(), updatedAt: nowISO() }, mappings: {} };
  let idxB = new Map(), idxW = new Map(), idxS = new Map();

  // results
  let R = [], U = [];
  let UT = []; // ✅ T-Soft tarafında (EAN + WS(KOD) ile Compel'e eşleşmeyenler)

  const key = (r, fn) => {
    const b = fn(r[C1.marka] || '');
    const code = T(r[C1.urunKodu] || '');
    const name = T(r[C1.urunAdi] || '');
    return b + '||' + (code || ('NAME:' + name));
  };
  const kNew = r => key(r, B);
  const kOld = r => key(r, Bx);

  function buildIdx() {
    idxB = new Map(); idxW = new Map(); idxS = new Map();

    for (const r of L2) {
      const bark = D(r[C2.barkod] || ''), ws = T(r[C2.ws] || ''), sup = T(r[C2.sup] || '');
      if (bark) { if (!idxB.has(bark)) idxB.set(bark, []); idxB.get(bark).push(r); }
      if (ws) idxW.set(ws, r);
      if (sup) idxS.set(sup, r);
    }

    // Eski datalist'ler (UI kaldırıldı ama sorun yok)
    const wsDl = $('wsCodes'), supDl = $('supCodes');
    if (wsDl) wsDl.innerHTML = '';
    if (supDl) supDl.innerHTML = '';
  }

  function byEan(r1) {
    const br1 = B(r1[C1.marka] || '');
    for (const e of eans(r1[C1.ean] || '')) {
      const arr = idxB.get(e);
      if (arr?.length) return arr.find(r2 => B(r2[C2.marka] || '') === br1) || arr[0];
    }
    return null;
  }

  function byCompelCodeWs(r1) {
    const code = T(r1[C1.urunKodu] || ''); if (!code) return null;
    const r2 = idxW.get(code) || null; if (!r2) return null;
    const b1 = B(r1[C1.marka] || ''), b2 = B(r2[C2.marka] || '');
    if (b1 && b2 && b1 !== b2) return null;
    return r2;
  }

  function byMap(r1) {
    const m = map.mappings || {}, ent = m[kNew(r1)] ?? m[kOld(r1)];
    if (!ent) return null;

    if (typeof ent === 'string') return idxW.get(ent) || idxS.get(ent) || null;

    const ws = T(ent.webServisKodu || ent.ws || ''), sup = T(ent.tedarikciUrunKodu || ent.supplier || '');
    return (ws && idxW.get(ws)) || (sup && idxS.get(sup)) || null;
  }

  const compelLbl = raw => {
    const s = (raw ?? '').toString().trim();
    if (!s) return '';
    return inStock(s, { source: 'compel' }) ? 'Stokta Var' : 'Stokta Yok';
  };
  const tsoftLbl = (raw, ok) => ok ? (inStock(raw, { source: 'products' }) ? 'Stokta Var' : 'Stokta Yok') : '';
  const depoLbl = (dNum) => {
    if (!isDepotReady?.()) return '—';
    return dNum > 0 ? 'Stokta Var' : 'Stokta Yok';
  };

  // ✅ Beklenen = (Compel VAR) OR (Depo > 0)
  const stokDur = (compelRaw, tsoftRaw, dNum, ok) => {
    if (!ok) return '—';
    const a = inStock(compelRaw, { source: 'compel' });
    const b = inStock(tsoftRaw, { source: 'products' });
    const exp = isDepotReady?.() ? (a || (dNum > 0)) : a;
    return b === exp ? 'Doğru' : 'Hatalı';
  };

  const eanDur = (aRaw, bRaw2, ok) => {
    if (!ok) return '—';
    const a = new Set(eans(aRaw || '')), b = eans(bRaw2 || '');
    if (!a.size || !b.length) return 'Eşleşmedi';
    for (const x of b) if (a.has(x)) return 'Eşleşti';
    return 'Eşleşmedi';
  };

  function outRow(r1, r2, how) {
    const s1raw = T(r1[C1.stok] || ''), s2raw = r2 ? T(r2[C2.stok] || '') : '';
    const sup = r2 ? T(r2[C2.sup] || '') : '', bark = r2 ? T(r2[C2.barkod] || '') : '';
    const seoAbs = r2 ? safeUrl(normSeo(r2[C2.seo] || '')) : '', clink = safeUrl(r1[C1.link] || '');

    const depAgg = getDepotAgg?.();
    const d = (r2 && depAgg) ? depAgg(sup) : { num: 0, raw: '' };

    return {
      "Sıra No": T(r1[C1.siraNo] || ''), "Marka": T(r1[C1.marka] || ''),
      "Ürün Adı (Compel)": T(r1[C1.urunAdi] || ''), "Ürün Adı (T-Soft)": r2 ? T(r2[C2.urunAdi] || '') : '',
      "Ürün Kodu (Compel)": T(r1[C1.urunKodu] || ''), "Ürün Kodu (T-Soft)": sup,

      "Stok (Compel)": compelLbl(s1raw),
      "Stok (Depo)": r2 ? depoLbl(d.num) : (isDepotReady?.() ? 'Stokta Yok' : '—'),
      "Stok (T-Soft)": tsoftLbl(s2raw, !!r2),
      "Stok Durumu": stokDur(s1raw, s2raw, d.num, !!r2),

      "EAN (Compel)": T(r1[C1.ean] || ''), "EAN (T-Soft)": bark, "EAN Durumu": eanDur(r1[C1.ean] || '', bark, !!r2),

      _s1raw: s1raw, _s2raw: s2raw,
      _dnum: d.num, _draw: d.raw,

      _m: !!r2, _how: r2 ? how : '', _k: kNew(r1), _bn: B(r1[C1.marka] || ''), _seo: seoAbs, _clink: clink
    };
  }

  function runMatch() {
    buildIdx();

    R = []; U = []; UT = [];

    // ✅ EAN veya WS(KOD) ile Compel'e eşleşmiş T-Soft kayıtlarını işaretle
    // (SUP/JSON/MANUAL eşleştirmeleri "eşleşmiş" sayılmayacak)
    const matchedTsoftKeys = new Set(); // brand||WS:xxx / brand||SUP:xxx

    const markMatchedTsoft = (r2) => {
      if (!r2) return;
      const brN = B(r2[C2.marka] || '');
      if (!brN) return;
      const ws = T(r2[C2.ws] || '');
      const sup = T(r2[C2.sup] || '');
      if (ws) matchedTsoftKeys.add(${brN}||WS:${ws});
      if (sup) matchedTsoftKeys.add(${brN}||SUP:${sup});
    };

    // 1) Compel -> T-Soft eşleştirme
    for (const r1 of L1) {
      let r2 = byEan(r1), how = r2 ? 'EAN' : '';
      if (!r2) { r2 = byCompelCodeWs(r1); if (r2) how = 'KOD'; }
      if (!r2) { r2 = byMap(r1); if (r2) how = 'JSON'; }

      // ✅ sadece EAN veya KOD eşleşmesi "eşleşmiş" sayılır (UT filtresi için)
      if (r2 && (how === 'EAN' || how === 'KOD')) markMatchedTsoft(r2);

      const row = outRow(r1, r2, how);
      R.push(row);
      if (!row._m) U.push(row); // Compel’de var, T-Soft’ta eşleşmedi
    }

    // 2) T-Soft tarafı (products.csv): Compel’e göre eşleşmeyenler
    // ✅ Kural: sadece (EAN veya WS/KOD) ile eşleşmiş olanlar listeden çıkar.
    // ✅ SUP (Tedarikçi Ürün Kodu) eşleşmesi / JSON / MANUAL => "eşleşmiş" sayılmayacak, UT'de kalabilir.
    const seen = new Set(); // brand||sup||name
    for (const r2 of L2) {
      const brN = B(r2[C2.marka] || '');
      if (!brN) continue;

      const nm = T(r2[C2.urunAdi] || '');
      if (!nm) continue;

      const ws = T(r2[C2.ws] || '');
      const sup = T(r2[C2.sup] || '');

      const wsHit = ws ? matchedTsoftKeys.has(${brN}||WS:${ws}) : false;
      const supHit = sup ? matchedTsoftKeys.has(${brN}||SUP:${sup}) : false;

      if (wsHit || supHit) continue; // ✅ EAN veya KOD ile eşleşmiş → UT'ye girmez

      const key = (brN + '||' + (sup || '—') + '||' + nm).toLocaleLowerCase(TR).replace(/\s+/g, ' ').trim();
      if (!key || seen.has(key)) continue;
      seen.add(key);

      const seoAbs = safeUrl(normSeo(r2[C2.seo] || ''));
      const brandDisp = T(r2[C2.marka] || '') || brN;

      UT.push({
        _type: 'tsoft',
        _bn: brN,
        "Marka": brandDisp,
        "T-Soft Ürün Adı": nm,
        _seo: seoAbs,
        _sup: sup,
        _ws: ws
      });
    }

    UT.sort((a, b) => {
      const ab = String(a["Marka"] || '').localeCompare(String(b["Marka"] || ''), 'tr', { sensitivity: 'base' });
      if (ab) return ab;
      return String(a["T-Soft Ürün Adı"] || '').localeCompare(String(b["T-Soft Ürün Adı"] || ''), 'tr', { sensitivity: 'base' });
    });

    return { R, U, UT };
  }

  function manualMatch(i, ws, sup) {
    // UI'da buton kaldırıldı ama fonksiyon dursun
    const r = U[i];
    if (!r) return false;

    const r2 = (ws && idxW.get(ws)) || (sup && idxS.get(sup)) || null;
    if (!r2) { alert('Ürün bulunamadı (marka filtresi sebebiyle de olabilir).'); return false; }

    const b1 = r._bn;
    const b2 = B(r2[C2.marka] || '');
    if (b1 && b2 && b1 !== b2) {
      const ok = confirm(Marka farklı:\n1) ${b1}\n2) ${b2}\nYine de eşleştirilsin mi?);
      if (!ok) return false;
    }

    map.mappings = map.mappings || {};
    map.mappings[r._k] = {
      webServisKodu: T(r2[C2.ws] || ''),
      tedarikciUrunKodu: T(r2[C2.sup] || ''),
      barkod: T(r2[C2.barkod] || ''),
      updatedAt: nowISO()
    };
    map.meta = map.meta || {};
    map.meta.updatedAt = nowISO();

    const idx = R.findIndex(x => x._k === r._k);
    if (idx >= 0) {
      const stub = {
        [C1.siraNo]: r["Sıra No"],
        [C1.marka]: r["Marka"],
        [C1.urunAdi]: r["Ürün Adı (Compel)"],
        [C1.urunKodu]: r["Ürün Kodu (Compel)"],
        [C1.stok]: r._s1raw || '',
        [C1.ean]: r["EAN (Compel)"],
        [C1.link]: r._clink || ''
      };
      R[idx] = outRow(stub, r2, 'MANUAL');
      R[idx]._k = r._k; R[idx]._bn = b1;
    }

    U.splice(i, 1);
    return true;
  }

  function resetAll() {
    L1 = []; L2 = []; L2all = [];
    C1 = {}; C2 = {};
    idxB = new Map(); idxW = new Map(); idxS = new Map();
    R = []; U = []; UT = [];
    map = { meta: { version: 1, createdAt: nowISO(), updatedAt: nowISO() }, mappings: {} };
  }

  function loadData({ l1, c1, l2, c2, l2All }) {
    L1 = l1 || [];
    L2 = l2 || [];
    L2all = l2All || [];
    C1 = c1 || {};
    C2 = c2 || {};
  }

  function getResults() { return { R, U, UT }; }
  function hasData() { return !!(L1?.length && L2?.length); }

  return {
    resetAll,
    loadData,
    runMatch,
    manualMatch,
    getResults,
    hasData
  };
}

ChatGPT:
Tamam.


Şunu dedin:
// js/depot.js
import { TR, T, parseDelimited, pickColumn } from './utils.js';

const $ = id => document.getElementById(id);

/* =========================
   ✅ Depo Modülü
   ========================= */

export function createDepot({ ui, onDepotLoaded, normBrand } = {}) {
  // state
  let L4 = [];
  let C4 = {};
  let idxD = new Map();
  let depotReady = false;

  // ✅ marka normalize -> [{code, alt, name}]
  let idxBR = new Map();
  let brandLabelByNorm = new Map();

  // dom
  const depoBtn = $('depoBtn');
  const depoModal = $('depoModal');
  const depoInner = $('depoInner');
  const depoPaste = $('depoPaste');
  const depoLoad = $('depoLoad');
  const depoPasteBtn = $('depoPasteBtn');
  const depoClose = $('depoClose');
  const depoClear = $('depoClear');
  const depoSpin = $('depoSpin');

  const depotCodeNorm = s =>
    (s ?? '').toString()
      .replace(/\u00A0/g, ' ')
      .trim()
      .replace(/\s+/g, ' ')
      .toLocaleUpperCase(TR);

  const depotCodeAlt = n => {
    if (!n) return '';
    if (!/^[0-9]+$/.test(n)) return '';
    return n.replace(/^0+(?=\d)/, '');
  };

  // ✅ Marka '-' satırlarını ignore (senin isteğin)
  const isBadBrand = (raw) => {
    const s = T(raw);
    return !s || s === '-' || s === '—' || s.toLocaleUpperCase(TR) === 'N/A';
  };

  const brandNormFn = (raw) => {
    const s = T(raw);
    if (!s || isBadBrand(s)) return '';
    if (typeof normBrand === 'function') return normBrand(s);
    return s.toLocaleUpperCase(TR).replace(/\s+/g, ' ').trim();
  };

  function depotStockNum(raw) {
    let s = (raw ?? '').toString().trim();
    if (!s) return 0;
    if (s.includes('.') && s.includes(',')) s = s.replace(/\./g, '').replace(/,/g, '.');
    else s = s.replace(/,/g, '.');
    s = s.replace(/[^0-9.\-]/g, '');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }

  function pickAideName(r) {
    // ✅ Aide CSV’de ürün adı=MODEL
    const model = C4.model ? T(r[C4.model] ?? '') : '';
    if (model) return model;

    // fallback’ler
    const urunAdi = C4.urunAdi ? T(r[C4.urunAdi] ?? '') : '';
    if (urunAdi) return urunAdi;

    const ac = C4.aciklama ? T(r[C4.aciklama] ?? '') : '';
    if (ac) return ac;

    return '';
  }

  function buildBrandRecordsIdx() {
    idxBR = new Map();
    brandLabelByNorm = new Map();
    if (!depotReady || !L4.length || !C4.stokKodu) return;

    const seen = new Map(); // brNorm -> Set(key)
    for (const r of L4) {
      const brRaw = T(C4.marka ? (r[C4.marka] ?? '') : (r["Marka"] ?? ''));
      if (isBadBrand(brRaw)) continue;

      const brNorm = brandNormFn(brRaw);
      if (!brNorm) continue;

      if (!brandLabelByNorm.has(brNorm)) brandLabelByNorm.set(brNorm, brRaw || brNorm);

      const rawCode = r[C4.stokKodu] ?? '';
      const code = depotCodeNorm(rawCode);
      if (!code) continue;

      const alt = depotCodeAlt(code);
      const name = pickAideName(r);
      if (!name) continue;

      if (!seen.has(brNorm)) seen.set(brNorm, new Set());
      const s = seen.get(brNorm);
      const k = (code + '||' + name).toLocaleLowerCase(TR).replace(/\s+/g, ' ').trim();
      if (k && s.has(k)) continue;
      if (k) s.add(k);

      if (!idxBR.has(brNorm)) idxBR.set(brNorm, []);
      idxBR.get(brNorm).push({ code, alt, name });
    }

    for (const [br, arr] of idxBR.entries()) {
      arr.sort((a, b) => String(a.name).localeCompare(String(b.name), 'tr', { sensitivity: 'base' }));
    }
  }

  function buildDepotIdx() {
    idxD = new Map();
    if (!depotReady || !L4.length || !C4.stokKodu) return;

    for (const r of L4) {
      const raw = r[C4.stokKodu] ?? '';
      const k = depotCodeNorm(raw);
      if (!k) continue;

      if (!idxD.has(k)) idxD.set(k, []);
      idxD.get(k).push(r);

      const alt = depotCodeAlt(k);
      if (alt && alt !== k) {
        if (!idxD.has(alt)) idxD.set(alt, []);
        idxD.get(alt).push(r);
      }
    }

    buildBrandRecordsIdx();
  }

  function depotAgg(code) {
    if (!depotReady) return { num: 0, raw: '' };
    const k = depotCodeNorm(code || '');
    if (!k) return { num: 0, raw: '0' };

    const alt = depotCodeAlt(k);
    const arr = idxD.get(k) || (alt ? idxD.get(alt) : null);
    if (!arr?.length) return { num: 0, raw: '0' };

    let sum = 0;
    for (const r of arr) sum += depotStockNum(r[C4.stok] ?? '');
    return { num: sum, raw: String(sum) };
  }

  /**
   * ✅ İSTENEN:
   * (Seçili/Compel markaları) Aide’de var ama T-Soft sup setinde yok =>
   * Depo Ürün Adı (MODEL) satır satır.
   * + ayrıca _dnum (toplam stok) döndürüyoruz (pulse için).
   */
  function unmatchedRows({ brandsNormSet, tsoftSupByBrand } = {}) {
    if (!depotReady) return [];
    const bnSet = (brandsNormSet instanceof Set) ? brandsNormSet : null;

    const out = [];
    const seen = new Set(); // br||name

    for (const [brNorm, arr] of idxBR.entries()) {
      if (bnSet && !bnSet.has(brNorm)) continue;

      const supSet = tsoftSupByBrand?.get?.(brNorm);
      const sset = (supSet instanceof Set) ? supSet : null;

      for (const it of arr) {
        const hit = sset ? (sset.has(it.code) || (it.alt ? sset.has(it.alt) : false)) : false;
        if (hit) continue;

        const brandDisp = brandLabelByNorm.get(brNorm) || brNorm;
        const nm = it.name || '';
        if (!nm) continue;

        const k = (brNorm + '||' + nm).toLocaleLowerCase(TR).replace(/\s+/g, ' ').trim();
        if (!k || seen.has(k)) continue;
        seen.add(k);

        const ag = depotAgg(it.code);
        out.push({
          _type: 'depo',
          _bn: brNorm,
          "Marka": brandDisp,
          "Depo Ürün Adı": nm,
          _dnum: ag?.num ?? 0
        });
      }
    }

    out.sort((a, b) => {
      const ab = String(a["Marka"] || '').localeCompare(String(b["Marka"] || ''), 'tr', { sensitivity: 'base' });
      if (ab) return ab;
      return String(a["Depo Ürün Adı"] || '').localeCompare(String(b["Depo Ürün Adı"] || ''), 'tr', { sensitivity: 'base' });
    });

    return out;
  }

  const syncDepoSpin = () => {
    if (!depoSpin) return;
    const has = (depoPaste?.value || '').trim().length > 0;
    depoSpin.style.display = has ? 'none' : 'block';
  };

  const setDepoUi = (loaded) => {
    const n4 = $('n4');
    if (n4) {
      n4.textContent = loaded ? 'Yüklendi' : 'Yükle';
      n4.title = loaded ? Depo yüklü (${L4.length}) : 'Yükle';
    }
    ui?.setChip?.('l4Chip', loaded ? Aide:${L4.length} : 'Aide:-');
  };

  // ✅ Popover konumlandırma
  const placePopover = () => {
    if (!depoBtn || !depoInner) return;
    depoInner.style.position = 'fixed';
    depoInner.style.left = '12px';
    depoInner.style.top = '12px';
    depoInner.style.visibility = 'hidden';

    requestAnimationFrame(() => {
      const a = depoBtn.getBoundingClientRect();
      const r = depoInner.getBoundingClientRect();
      const root = getComputedStyle(document.documentElement);
      const M = parseFloat(root.getPropertyValue('--popM')) || 12;
      const G = parseFloat(root.getPropertyValue('--popGap')) || 10;

      let left = a.left;
      left = Math.max(M, Math.min(left, window.innerWidth - r.width - M));

      let top = a.top - r.height - G;
      if (top < M) top = a.bottom + G;
      top = Math.max(M, Math.min(top, window.innerHeight - r.height - M));

      depoInner.style.left = left + 'px';
      depoInner.style.top = top + 'px';
      depoInner.style.visibility = 'visible';
    });
  };

  const showDepo = () => {
    if (!depoModal) return;
    depoModal.style.display = 'block';
    depoModal.setAttribute('aria-hidden', 'false');
    placePopover();
    syncDepoSpin();
    setTimeout(() => depoPaste?.focus(), 0);
  };

  const hideDepo = () => {
    if (!depoModal) return;
    depoModal.style.display = 'none';
    depoModal.setAttribute('aria-hidden', 'true');
    if (depoInner) {
      depoInner.style.position = '';
      depoInner.style.left = '';
      depoInner.style.top = '';
      depoInner.style.visibility = '';
    }
  };

  /* noisy paste parser */
  function depotFromNoisyPaste(text) {
    const FirmaDefault = "Sescibaba";
    const N = s => !s || /^(Tümü|Sesçibaba Logo|Şirketler|Siparişler|Onay Bekleyen|Sipariş Listesi|İade Listesi|Sesçibaba Stokları|Stok Listesi|Ara|Previous|Next|E-Commerce Management.*|Showing\b.*|Marka\s+Model\s+Stok\s+Kodu.*|\d+)$/.test(s);

    const out = [];
    const lines = (text || '').split(/\r\n|\r|\n/);

    for (let l of lines) {
      l = (l || '').replace(/\u00A0/g, " ").trim();
      if (N(l)) continue;

      if (!l.includes("\t")) continue;

      const a = l.split("\t").map(x => x.trim()).filter(Boolean);
      if (a.length < 6) continue;

      let m = '', mo = '', k = '', ac = '', s = '', w = '', f = FirmaDefault;

      if (a.length === 6) {
        m = a[0]; mo = a[1]; k = a[2]; ac = a[3]; s = a[4]; w = a[5];
      } else {
        m = a[0];
        f = a.at(-1) || FirmaDefault;
        w = a.at(-2) || '';
        s = a.at(-3) || '';
        const mid = a.slice(1, -3);
        if (mid.length < 3) continue;
        mo = mid.slice(0, -2).join(" ");
        k = mid.at(-2) || '';
        ac = mid.at(-1) || '';
      }

      const stokStr = String(s ?? '').trim();
      if (!stokStr || !/^-?\d+(?:[.,]\d+)?$/.test(stokStr)) continue;

      out.push({
        "Marka": m,
        "Model": mo,
        "Stok Kodu": k,
        "Açıklama": ac,
        "Stok": stokStr,
        "Ambar": w,
        "Firma": f
      });
    }

    return out;
  }

  function loadDepotFromText(text) {
    const raw = (text ?? '').toString();
    if (!raw.trim()) return alert('Depo verisi boş.');

    let ok = false;
    try {
      const p = parseDelimited(raw);
      const rows = p?.rows || [];
      if (rows.length) {
        const sample = rows[0];
        const stokKodu = pickColumn(sample, ['Stok Kodu', 'StokKodu', 'STOK KODU', 'Stock Code']);
        const stok = pickColumn(sample, ['Stok', 'Miktar', 'Qty', 'Quantity']);
        if (stokKodu && stok) {
          L4 = rows;
          C4 = {
            stokKodu,
            stok,
            ambar: pickColumn(sample, ['Ambar', 'Depo', 'Warehouse']),
            firma: pickColumn(sample, ['Firma', 'Şirket', 'Company']),
            marka: pickColumn(sample, ['Marka', 'MARKA', 'Brand', 'BRAND']),
            model: pickColumn(sample, ['Model', 'MODEL']),
            urunAdi: pickColumn(sample, ['Ürün Adı', 'Urun Adi', 'Ürün Adi', 'Product Name', 'Product']),
            aciklama: pickColumn(sample, ['Açıklama', 'Aciklama', 'Description'])
          };
          ok = true;
        }
      }
    } catch {
      ok = false;
    }

    if (!ok) {
      const r2 = depotFromNoisyPaste(raw);
      if (!r2.length) return alert('Depo verisi çözümlenemedi. (Tablolu kopya bekleniyordu.)');
      L4 = r2;
      C4 = {
        stokKodu: 'Stok Kodu',
        stok: 'Stok',
        ambar: 'Ambar',
        firma: 'Firma',
        marka: 'Marka',
        model: 'Model',
        aciklama: 'Açıklama'
      };
      ok = true;
    }

    depotReady = true;
    buildDepotIdx();
    setDepoUi(true);
    ui?.setStatus?.('Depo yüklendi', 'ok');

    onDepotLoaded?.();
  }

  function reset() {
    depotReady = false;
    L4 = [];
    C4 = {};
    idxD = new Map();
    idxBR = new Map();
    brandLabelByNorm = new Map();
    if (depoPaste) depoPaste.value = '';
    syncDepoSpin();
    setDepoUi(false);
  }

  // events
  if (depoBtn) depoBtn.onclick = showDepo;
  if (depoClose) depoClose.onclick = hideDepo;

  if (depoPasteBtn) depoPasteBtn.onclick = async () => {
    try {
      if (!navigator.clipboard?.readText) {
        alert('Panoya erişilemiyor. Sayfayı HTTPS üzerinden açın ve izin verin.');
        return;
      }
      depoPasteBtn.disabled = true;
      const txt = await navigator.clipboard.readText();
      if (!txt?.trim()) {
        alert('Panoda yapıştırılacak metin yok.');
        return;
      }
      if (depoPaste) depoPaste.value = txt;
      syncDepoSpin();
      depoPaste?.focus();
    } catch (e) {
      console.error(e);
      alert('Pano okunamadı. Tarayıcı izinlerini kontrol edin.');
    } finally {
      if (depoPasteBtn) depoPasteBtn.disabled = false;
    }
  };

  if (depoPaste) {
    depoPaste.addEventListener('input', syncDepoSpin);
    depoPaste.addEventListener('paste', () => setTimeout(syncDepoSpin, 0));
  }

  if (depoClear) depoClear.onclick = () => {
    if (depoPaste) depoPaste.value = '';
    syncDepoSpin();
    depoPaste?.focus();
  };

  if (depoLoad) depoLoad.onclick = () => {
    loadDepotFromText(depoPaste?.value || '');
    hideDepo();
  };

  addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && depoModal?.style.display !== 'none') hideDepo();
  });

  addEventListener('resize', () => {
    if (depoModal?.style.display === 'block') placePopover();
  });
  addEventListener('scroll', () => {
    if (depoModal?.style.display === 'block') placePopover();
  }, true);

  // init ui
  setDepoUi(false);
  syncDepoSpin();

  return {
    reset,
    isReady: () => depotReady,
    agg: depotAgg,
    count: () => L4.length,
    unmatchedRows
  };
}

ChatGPT:
Tamam.


Şunu dedin:
// js/app.js
import { TR, esc, parseDelimited, pickColumn, downloadBlob, toCSV, readFileText, T } from './utils.js';
import { loadBrands, scanCompel } from './api.js';
import { createMatcher, normBrand, COLS } from './match.js';
import { createDepot } from './depot.js';
import { createRenderer } from './render.js';

const $ = id => document.getElementById(id);

const API_BASE = "https://robot-workstation.tvkapora.workers.dev";

/* =========================
   Supplier state
   ========================= */
const SUPPLIERS = { COMPEL: 'Compel', AKALIN: 'Akalın' };
let ACTIVE_SUPPLIER = SUPPLIERS.COMPEL;
let COMPEL_BRANDS_CACHE = null;

// ✅ Compel marka seti (normalize) — Depo eşleşmeyenleri filtrelemek için
let COMPEL_BRANDS_NORM = new Set();

const AKALIN_BRAND_NAMES = [
  "Acoustic Energy","AIAIAI","AMS-Neve","Antelope Audio","Apple","ART","Artiphon","Artnovion","Asparion","ATC-Loudspeakers",
  "Audient","Audio-Technica","Audix","Auratone","Avid","Barefoot","Bricasti-Design","Celemony","Centrance","CME",
  "Dangerous-Music","DD-HiFi","Digital-Audio-Denmark","Dj-techtools","Direct-Sound","Doto-Design","Drawmer","DreamWave","Earthworks-Audio","Elektron-Music-Machines",
  "Elysia","Embodme","Empirical-Labs","Erica-Synths","ESI-Audio","Eve-Audio","Eventide-Audio","Fatman-by-TL-Audio","Flock-Audio","Focusrite",
  "Freqport","Gainlab-Audio","Gator-Frameworks","Grace-Design","Hifiman","Hori","Icon-Pro-Audio","IK-Multimedia","IsoAcoustics","Konig-Meyer",
  "Koss","Lake-People","Lynx-Studio-Technology","M-Live","Magma","Manley-Laboratories","Melbourne-Instruments","Microtech-Gefell","Midiplus","Millennia-Music-Media",
  "Modal-Electronics","Mogami","Mojave-Audio","Monster-Audio","Monster-Cable","Moondrop","MOTU","MXL-Microphones","Mytek-Audio","Native-Instruments",
  "Neo-Created-by-OYAIDE-Elec","Neumann","Neutrik","Noble-Audio","Odisei-Music","Phase","Polyend","Primacoustic","ProCab","PSI-Audio",
  "Radial-Engineering","Relacart","Reloop","Reloop-HiFi","Rhodes","Royer-Labs","Sendy-Audio","Signex","Sivga-Audio","Slate-Digital",
  "Smithson-Martin","Soma-Synths","Sonnet","Specialwaves","Spectrasonics","Steven-Slate-Audio","Studiologic-by-Fatar","Synchro-Arts","Tantrum-Audio","Teenage-Engineering",
  "Telefunken-Elektroakustik","Thermionic-Culture","Topping-Audio","Topping-Professional","Triton-Audio","Truthear","Tube-Tech","Udo-Audio","Ultimate-Support","Waldorf",
  "Waves"
];

/* =========================
   Guided pulse (2->3->4->5)
   ========================= */
let guideStep = 'brand'; // brand -> tsoft -> aide -> list -> done

const GUIDE_DUR = {
  brand: 1500,
  tsoft: 1250,
  aide: 1050,
  list: 900
};

const clearGuidePulse = () => {
  const ids = ['brandHintBtn', 'sescBox', 'depoBtn', 'go'];
  for (const id of ids) {
    const el = $(id);
    if (!el) continue;
    el.classList.remove('guidePulse');
    el.style.removeProperty('--guideDur');
  }
};

const setGuideStep = (s) => {
  guideStep = s || 'done';
  updateGuideUI();
};

const updateGuideUI = () => {
  clearGuidePulse();
  if (ACTIVE_SUPPLIER === SUPPLIERS.AKALIN) return;
  if (guideStep === 'done') return;

  const dur = GUIDE_DUR[guideStep] || 1200;
  const apply = (el) => {
    if (!el) return;
    el.style.setProperty('--guideDur', ${dur}ms);
    el.classList.add('guidePulse');
  };

  if (guideStep === 'brand') apply($('brandHintBtn'));
  else if (guideStep === 'tsoft') apply($('sescBox'));
  else if (guideStep === 'aide') apply($('depoBtn'));
  else if (guideStep === 'list') apply($('go'));
};

/* =========================
   UI helpers
   ========================= */
const setChip = (id, t, cls = '') => {
  const e = $(id);
  if (!e) return;
  const txt = String(t ?? '');
  e.textContent = txt;
  e.title = txt;
  e.className = 'chip' + (cls ?  ${cls} : '');
};

const setStatus = (t, k = 'ok') => {
  const st = $('stChip');
  if (!st) return;

  const msg = String(t ?? '').trim();
  if (!msg || msg.toLocaleLowerCase(TR) === 'hazır') {
    st.style.display = 'none';
    st.textContent = '';
    st.title = '';
    st.className = 'chip ok';
    return;
  }

  st.style.display = '';
  setChip('stChip', msg, k);
};

const ui = { setChip, setStatus };

const INFO_HIDE_IDS = ['brandStatus', 'l1Chip', 'l2Chip', 'l4Chip', 'sum'];

/* =========================
   Brand + selection state
   ========================= */
let BRANDS = [];
let SELECTED = new Set();
let brandPrefix = 'Hazır';

/* ✅ Depo karşılaştırması için:
   Compel'e SADECE (EAN veya WS/KOD) ile eşleşmiş T-Soft kayıtlarının sup kodları (marka bazlı) */
let TSOFT_OK_SUP_BY_BRAND = new Map();

const codeNorm = (s) =>
  (s ?? '').toString()
    .replace(/\u00A0/g, ' ')
    .trim()
    .replace(/\s+/g, ' ')
    .toLocaleUpperCase(TR);

const codeAlt = (n) => {
  const k = codeNorm(n);
  if (!k) return '';
  if (!/^[0-9]+$/.test(k)) return '';
  return k.replace(/^0+(?=\d)/, '');
};

/* ✅ brand chip */
const updateBrandChip = () => {
  const el = $('brandStatus');
  if (!el) return;
  if (ACTIVE_SUPPLIER === SUPPLIERS.AKALIN) return;

  const total = BRANDS?.length ?? 0;
  const sel = SELECTED?.size ?? 0;
  el.textContent = ${brandPrefix} • Marka: ${total}/${sel};
  el.title = el.textContent;
};

/* =========================
   Liste başlığı
   ========================= */
let listTitleEl = null;
let listSepEl = null;
let lastListedTitle = '';
let hasEverListed = false;

const joinTrList = (arr) => {
  const a = (arr || []).filter(Boolean);
  if (!a.length) return '';
  if (a.length === 1) return a[0];
  if (a.length === 2) return ${a[0]} ve ${a[1]};
  return ${a.slice(0, -1).join(', ')} ve ${a[a.length - 1]};
};

const getSupplierName = () => {
  const t = ($('supplierLabel')?.textContent || $('supplierBtn')?.textContent || '').trim();
  const m = t.match(/:\s*(.+)\s*$/);
  if (m) return (m[1] || '').trim() || '—';
  return t.replace(/^1\)\s*/i, '').replace(/^Tedarikçi\s*/i, '').trim() || '—';
};

const getSelectedBrandNames = () => {
  const out = [];
  for (const id of SELECTED) {
    const b = BRANDS.find(x => x.id === id);
    if (b?.name) out.push(String(b.name));
  }
  out.sort((a, b) => a.localeCompare(b, 'tr', { sensitivity: 'base' }));
  return out;
};

const buildListTitle = () => {
  const sup = getSupplierName();
  const brands = getSelectedBrandNames();
  if (!brands.length) return Tedarikçi ${sup} için marka seçilmedi.;

  const brTxt = joinTrList(brands);
  const suffix = brands.length === 1 ? 'markasında' : 'markalarında';
  return Tedarikçi ${sup} için ${brTxt} ${suffix} yapılan T-Soft ve Aide karşılaştırma listesi;
};

const ensureListHeader = () => {
  const maincol = document.querySelector('section.maincol');
  if (!maincol || listTitleEl) return;

  const sep = document.createElement('div');
  sep.className = 'rowSep';
  sep.setAttribute('aria-hidden', 'true');

  listTitleEl = document.createElement('div');
  listTitleEl.id = 'listTitle';
  listTitleEl.className = 'listTitleBar';

  const first = maincol.firstElementChild;
  maincol.insertBefore(sep, first);
  maincol.insertBefore(listTitleEl, first);

  listSepEl = sep;

  listTitleEl.style.display = 'none';
  listSepEl.style.display = 'none';
};

const setListTitleVisible = (show) => {
  ensureListHeader();
  if (listTitleEl) listTitleEl.style.display = show ? '' : 'none';
  if (listSepEl) listSepEl.style.display = show ? '' : 'none';
};

const lockListTitleFromCurrentSelection = () => {
  ensureListHeader();
  lastListedTitle = buildListTitle();
  if (listTitleEl) listTitleEl.textContent = lastListedTitle;
};

/* =========================
   Supplier UI
   ========================= */
let goMode = 'list'; // 'list' | 'clear'

const setGoMode = (mode) => {
  goMode = mode;
  const goBtn = $('go');
  if (!goBtn) return;
  if (mode === 'clear') {
    goBtn.textContent = 'Temizle';
    goBtn.title = 'Temizle';
  } else {
    goBtn.textContent = 'Listele';
    goBtn.title = 'Listele';
  }
};

const clearOnlyLists = () => {
  const t1 = $('t1'), t2 = $('t2');
  if (t1) t1.innerHTML = '';
  if (t2) t2.innerHTML = '';
  const sec = $('unmatchedSection');
  if (sec) sec.style.display = 'none';

  setListTitleVisible(false);

  const dl1 = $('dl1');
  if (dl1) dl1.disabled = true;

  setChip('sum', '✓0 • ✕0', 'muted');
};

const applySupplierUi = () => {
  const goBtn = $('go');
  if (goBtn) {
    if (ACTIVE_SUPPLIER === SUPPLIERS.AKALIN) {
      goBtn.classList.add('wip');
      goBtn.title = 'Yapım Aşamasında';
    } else {
      goBtn.classList.remove('wip');
    }
  }

  if (ACTIVE_SUPPLIER === SUPPLIERS.AKALIN) {
    for (const id of INFO_HIDE_IDS) {
      const el = $(id);
      if (el) el.style.display = 'none';
    }
    setStatus('Tedarikçi Akalın entegre edilmedi. Lütfen farklı bir tedarikçi seçin.', 'bad');
  } else {
    for (const id of INFO_HIDE_IDS) {
      const el = $(id);
      if (el) el.style.display = '';
    }
    setStatus('Hazır', 'ok');
    updateBrandChip();
  }

  updateGuideUI();
};

/* =========================
   T-Soft popover
   ========================= */
(() => {
  const box = $('sescBox');
  const inp = $('f2');
  const modal = $('tsoftModal');
  const inner = $('tsoftInner');
  const pickBtn = $('tsoftClose');
  const dismissBtn = $('tsoftDismiss');
  if (!box || !inp || !modal || !inner || !pickBtn || !dismissBtn) return;

  let allowPickerOnce = false;
  const isOpen = () => modal.style.display === 'block';

  const placePopover = () => {
    inner.style.position = 'fixed';
    inner.style.left = '12px';
    inner.style.top = '12px';
    inner.style.visibility = 'hidden';

    requestAnimationFrame(() => {
      const a = box.getBoundingClientRect();
      const r = inner.getBoundingClientRect();
      const root = getComputedStyle(document.documentElement);
      const M = parseFloat(root.getPropertyValue('--popM')) || 12;
      const G = parseFloat(root.getPropertyValue('--popGap')) || 10;

      let left = a.left;
      left = Math.max(M, Math.min(left, window.innerWidth - r.width - M));

      let top = a.top - r.height - G;
      if (top < M) top = a.bottom + G;
      top = Math.max(M, Math.min(top, window.innerHeight - r.height - M));

      inner.style.left = left + 'px';
      inner.style.top = top + 'px';
      inner.style.visibility = 'visible';
    });
  };

  const show = () => {
    modal.style.display = 'block';
    modal.setAttribute('aria-hidden', 'false');
    placePopover();
    setTimeout(() => pickBtn.focus(), 0);
  };

  const hide = () => {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    inner.style.position = '';
    inner.style.left = '';
    inner.style.top = '';
    inner.style.visibility = '';
  };

  const openPicker = () => {
    allowPickerOnce = true;
    hide();
    requestAnimationFrame(() => {
      try { inp.click(); }
      finally { setTimeout(() => { allowPickerOnce = false; }, 0); }
    });
  };

  box.addEventListener('click', (e) => {
    if (inp.disabled) return;
    if (allowPickerOnce) { allowPickerOnce = false; return; }
    e.preventDefault();
    e.stopPropagation();
    show();
  }, true);

  pickBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    openPicker();
  });

  dismissBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    hide();
  });

  addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    if (!isOpen()) return;
    e.preventDefault();
    e.stopPropagation();
    openPicker();
  });

  addEventListener('resize', () => { if (isOpen()) placePopover(); });
  addEventListener('scroll', () => { if (isOpen()) placePopover(); }, true);
})();

/* =========================
   Supplier Dropdown
   ========================= */
(() => {
  const wrap = $('supplierWrap');
  const btn = $('supplierBtn');
  const menu = $('supplierMenu');
  const addBtn = $('supplierAddBtn');
  const itemCompel = $('supplierCompelItem');
  const itemAkalin = $('supplierAkalinItem');

  if (!wrap || !btn || !menu || !itemCompel || !itemAkalin) return;

  const open = () => {
    menu.classList.add('show');
    menu.setAttribute('aria-hidden', 'false');
    btn.setAttribute('aria-expanded', 'true');
  };
  const close = () => {
    menu.classList.remove('show');
    menu.setAttribute('aria-hidden', 'true');
    btn.setAttribute('aria-expanded', 'false');
  };
  const toggle = () => (menu.classList.contains('show') ? close() : open());

  const paintMenu = () => {
    const mk = (el, name) => {
      const sel = (ACTIVE_SUPPLIER === name);
      el.setAttribute('aria-disabled', sel ? 'true' : 'false');
      el.textContent = sel ? ${name} (seçili) : name;
    };
    mk(itemCompel, SUPPLIERS.COMPEL);
    mk(itemAkalin, SUPPLIERS.AKALIN);
  };

  const setSupplier = async (name) => {
    if (!name || name === ACTIVE_SUPPLIER) { close(); return; }

    ACTIVE_SUPPLIER = name;
    const lab = $('supplierLabel');
    if (lab) lab.textContent = 1) Tedarikçi: ${name};

    if (name === SUPPLIERS.AKALIN) {
      brandPrefix = 'Akalın';
      BRANDS = AKALIN_BRAND_NAMES.map((nm, i) => ({
        id: i + 1,
        slug: String(nm).toLocaleLowerCase(TR).replace(/\s+/g, '-'),
        name: nm,
        count: '—'
      }));
    } else {
      brandPrefix = 'Hazır';
      if (COMPEL_BRANDS_CACHE?.length) {
        BRANDS = COMPEL_BRANDS_CACHE;
      } else {
        await initBrands();
      }
    }

    resetAll();
    paintMenu();
    close();
  };

  btn.addEventListener('click', (e) => {
    e.preventDefault();
    paintMenu();
    toggle();
  });

  itemCompel.addEventListener('click', (e) => {
    e.preventDefault();
    if (itemCompel.getAttribute('aria-disabled') === 'true') return;
    void setSupplier(SUPPLIERS.COMPEL);
  });

  itemAkalin.addEventListener('click', (e) => {
    e.preventDefault();
    if (itemAkalin.getAttribute('aria-disabled') === 'true') return;
    void setSupplier(SUPPLIERS.AKALIN);
  });

  addBtn?.addEventListener('click', (e) => { e.preventDefault(); close(); });

  document.addEventListener('click', (e) => { if (!wrap.contains(e.target)) close(); });
  addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });

  paintMenu();
})();

/* =========================
   Marka seçimi UI
   ========================= */
const renderBrands = () => {
  const list = $('brandList');
  if (!list) return;
  list.innerHTML = '';

  const sorted = [...BRANDS].sort((a, b) =>
    String(a.name || '').localeCompare(String(b.name || ''), 'tr', { sensitivity: 'base' })
  );

  sorted.forEach((b) => {
    const d = document.createElement('div');
    d.className = 'brand' + (SELECTED.has(b.id) ? ' sel' : '');
    d.tabIndex = 0;
    d.dataset.id = String(b.id);

    d.innerHTML = 
      <div class="bRow">
        <span class="bNm" title="${esc(b.name)}">${esc(b.name)}</span>
        <span class="bCt">(${esc(b.count)})</span>
      </div>
    ;
    list.appendChild(d);
  });

  updateBrandChip();

  if (!hasEverListed) {
    if (SELECTED.size > 0) setGuideStep('tsoft');
    else setGuideStep('brand');
  }

  applySupplierUi();
};

const toggleBrand = (id, el) => {
  if (SELECTED.has(id)) { SELECTED.delete(id); el.classList.remove('sel'); }
  else { SELECTED.add(id); el.classList.add('sel'); }

  updateBrandChip();

  if (!hasEverListed) {
    if (SELECTED.size > 0) setGuideStep('tsoft');
    else setGuideStep('brand');
  }

  applySupplierUi();
};

$('brandList')?.addEventListener('click', (e) => {
  const el = e.target.closest('.brand');
  if (!el) return;
  const id = Number(el.dataset.id);
  if (!Number.isFinite(id)) return;
  toggleBrand(id, el);
});

$('brandList')?.addEventListener('keydown', (e) => {
  if (e.key !== 'Enter' && e.key !== ' ') return;
  const el = e.target.closest('.brand');
  if (!el) return;
  e.preventDefault();
  const id = Number(el.dataset.id);
  if (!Number.isFinite(id)) return;
  toggleBrand(id, el);
});

const pulseBrands = () => {
  const list = $('brandList');
  if (!list) return;
  list.classList.remove('glow');
  void list.offsetWidth;
  list.classList.add('glow');
  setTimeout(() => list.classList.remove('glow'), 950);
};
$('brandHintBtn')?.addEventListener('click', pulseBrands);

async function initBrands() {
  brandPrefix = 'Hazır';
  const brandEl = $('brandStatus');
  if (brandEl) {
    brandEl.textContent = 'Markalar yükleniyor…';
    brandEl.title = brandEl.textContent;
  }

  try {
    const data = await loadBrands(API_BASE);
    COMPEL_BRANDS_CACHE = data;

    if (ACTIVE_SUPPLIER === SUPPLIERS.COMPEL) {
      BRANDS = data;
    }
  } catch (e) {
    console.error(e);
    if (ACTIVE_SUPPLIER === SUPPLIERS.COMPEL) {
      const brandEl2 = $('brandStatus');
      if (brandEl2) {
        brandEl2.textContent = 'Markalar yüklenemedi (API).';
        brandEl2.title = brandEl2.textContent;
      }
    }
  } finally {
    renderBrands();
    applySupplierUi();
  }
}

/* =========================
   Depo + Matcher + Renderer
   ========================= */
const depot = createDepot({
  ui,
  normBrand,
  onDepotLoaded: () => {
    if (matcher.hasData()) {
      matcher.runMatch();
      refresh();
    }

    if (!hasEverListed) {
      if (guideStep === 'aide' && depot.isReady()) setGuideStep('list');
    }

    applySupplierUi();
  }
});

const matcher = createMatcher({
  getDepotAgg: () => depot.agg,
  isDepotReady: () => depot.isReady()
});

const renderer = createRenderer({ ui });

/* ✅ Depo karşılaştırması için:
   TSOFT_OK_SUP_BY_BRAND = sadece Compel'e (EAN veya WS/KOD) ile eşleşmiş T-Soft sup kodları */
function rebuildTsoftOkSupByBrand() {
  TSOFT_OK_SUP_BY_BRAND = new Map();

  const { R } = matcher.getResults();
  for (const row of (R || [])) {
    if (!row?._m) continue;

    // sadece EAN veya WS (KOD) eşleşmesi
    if (row._how !== 'EAN' && row._how !== 'KOD') continue;

    const br = row._bn || normBrand(row["Marka"] || '');
    const sup = T(row["Ürün Kodu (T-Soft)"] || ''); // outRow'da sup buraya yazılıyor
    if (!br || !sup) continue;

    if (!TSOFT_OK_SUP_BY_BRAND.has(br)) TSOFT_OK_SUP_BY_BRAND.set(br, new Set());
    const set = TSOFT_OK_SUP_BY_BRAND.get(br);

    const k = codeNorm(sup);
    if (k) set.add(k);
    const a = codeAlt(k);
    if (a && a !== k) set.add(a);
  }
}

/* ✅ Eşleşmeyenler tablosu:
   aynı MARKA içinde (Compel / T-Soft / Depo) sütunlarını satır satır "zip"le */
function buildUnifiedUnmatched({ Uc, Ut, Ud }) {
  const g = new Map(); // brNorm -> { brandDisp, c:[], t:[], d:[] }

  const getGrp = (brNorm, brandDisp) => {
    const k = String(brNorm || '').trim();
    if (!k) return null;
    if (!g.has(k)) g.set(k, { brNorm: k, brandDisp: brandDisp || k, c: [], t: [], d: [] });
    const grp = g.get(k);
    if (brandDisp && (!grp.brandDisp || grp.brandDisp === grp.brNorm)) grp.brandDisp = brandDisp;
    return grp;
  };

  // 1) Compel unmatched
  for (const r of (Uc || [])) {
    const bDisp = String(r["Marka"] || '').trim();
    const bNorm = normBrand(bDisp || r._bn || '');
    const grp = getGrp(bNorm, bDisp);
    if (!grp) continue;
    const nm = String(r["Ürün Adı (Compel)"] || '').trim();
    if (!nm) continue;
    grp.c.push({
      name: nm,
      link: r._clink || ''
    });
  }

  // 2) T-Soft unmatched
  for (const r of (Ut || [])) {
    const bDisp = String(r["Marka"] || '').trim();
    const bNorm = normBrand(r._bn || bDisp || '');
    const grp = getGrp(bNorm, bDisp);
    if (!grp) continue;
    const nm = String(r["T-Soft Ürün Adı"] || '').trim();
    if (!nm) continue;
    grp.t.push({
      name: nm,
      link: r._seo || ''
    });
  }

  // 3) Depo unmatched
  for (const r of (Ud || [])) {
    const bDisp = String(r["Marka"] || '').trim();
    const bNorm = normBrand(r._bn || bDisp || '');
    const grp = getGrp(bNorm, bDisp);
    if (!grp) continue;
    const nm = String(r["Depo Ürün Adı"] || '').trim();
    if (!nm) continue;
    grp.d.push({ name: nm });
  }

  // Sort brands (alphabetic) + each list
  const brandArr = [...g.values()].sort((a, b) =>
    String(a.brandDisp || '').localeCompare(String(b.brandDisp || ''), 'tr', { sensitivity: 'base' })
  );

  for (const grp of brandArr) {
    grp.c.sort((a, b) => String(a.name).localeCompare(String(b.name), 'tr', { sensitivity: 'base' }));
    grp.t.sort((a, b) => String(a.name).localeCompare(String(b.name), 'tr', { sensitivity: 'base' }));
    grp.d.sort((a, b) => String(a.name).localeCompare(String(b.name), 'tr', { sensitivity: 'base' }));
  }

  // Zip rows
  const out = [];
  for (const grp of brandArr) {
    const n = Math.max(grp.c.length, grp.t.length, grp.d.length);
    for (let i = 0; i < n; i++) {
      const c = grp.c[i] || null;
      const t = grp.t[i] || null;
      const d = grp.d[i] || null;

      out.push({
        "Sıra": "", // aşağıda 1..N doldurulacak
        "Marka": grp.brandDisp || grp.brNorm,
        "Compel Ürün Adı": c ? c.name : "",
        "T-Soft Ürün Adı": t ? t.name : "",
        "Depo Ürün Adı": d ? d.name : "",
        _clink: c?.link || "",
        _seo: t?.link || ""
      });
    }
  }

  // Sıra 1..N
  for (let i = 0; i < out.length; i++) out[i]["Sıra"] = String(i + 1);
  return out;
}

function refresh() {
  rebuildTsoftOkSupByBrand();

  const { R, U, UT } = matcher.getResults();

  const Ud = depot.isReady()
    ? depot.unmatchedRows({
        brandsNormSet: COMPEL_BRANDS_NORM,
        tsoftSupByBrand: TSOFT_OK_SUP_BY_BRAND
      })
    : [];

  const Ux = buildUnifiedUnmatched({ Uc: U, Ut: UT, Ud });

  renderer.render(R, Ux, depot.isReady());
  applySupplierUi();
}

/* =========================
   T-Soft file label
   ========================= */
const bind = (inId, outId, empty) => {
  const inp = $(inId), out = $(outId); if (!inp || !out) return;
  const upd = () => {
    const f = inp.files?.[0];
    if (!f) { out.textContent = empty; out.title = empty; }
    else { out.textContent = 'Seçildi'; out.title = f.name; }

    if (!hasEverListed) {
      if (SELECTED.size === 0) setGuideStep('brand');
      else if (!f) setGuideStep('tsoft');
      else if (guideStep === 'tsoft') setGuideStep('aide');
      else if (guideStep === 'brand') setGuideStep('tsoft');
    }

    applySupplierUi();
  };
  inp.addEventListener('change', upd); upd();
};
bind('f2', 'n2', 'Yükle');

/* =========================
   Scan state
   ========================= */
let abortCtrl = null;
const goBtn = $('go');

const setScanState = (on) => {
  if (goBtn) goBtn.disabled = on;
  $('f2') && ($('f2').disabled = on);
  $('depoBtn') && ($('depoBtn').disabled = on);
};

/* =========================
   Generate (Listele)
   ========================= */
async function generate() {
  const file = $('f2')?.files?.[0];
  if (!file) { alert('Lütfen T-Soft Stok CSV seç.'); return false; }

  setStatus('Okunuyor…', 'unk');
  setChip('l1Chip', 'Compel:—');
  setChip('l2Chip', 'T-Soft:—');

  abortCtrl = new AbortController();
  setScanState(true);

  try {
    clearOnlyLists();
    matcher.resetAll();

    // reset maps/sets
    TSOFT_OK_SUP_BY_BRAND = new Map();
    COMPEL_BRANDS_NORM = new Set();

    const selectedBrands = BRANDS.filter(x => SELECTED.has(x.id));

    if (selectedBrands.length === BRANDS.length) {
      const ok = confirm('Tüm markaları taramak üzeresiniz. Emin misiniz?');
      if (!ok) throw new Error('İptal edildi.');
    }

    const t2Promise = readFileText(file);

    let seq = 0;
    const chosen = selectedBrands.map(b => ({ id: b.id, slug: b.slug, name: b.name, count: b.count }));

    const scanPromise = (async () => {
      const rows = [];
      await scanCompel(API_BASE, chosen, {
        signal: abortCtrl.signal,
        onMessage: (m) => {
          if (!m) return;

          if (m.type === 'brandStart' || m.type === 'page') {
            setStatus(Taranıyor: ${m.brand || ''} (${m.page || 0}/${m.pages || 0}), 'unk');
          } else if (m.type === 'product') {
            const p = m.data || {};
            seq++;
            rows.push({
              "Sıra No": String(seq),
              "Marka": String(p.brand || ''),
              "Ürün Adı": String(p.title || 'Ürün'),
              "Ürün Kodu": String(p.productCode || ''),
              "Stok": String(p.stock || ''),
              "EAN": String(p.ean || ''),
              "Link": String(p.url || '')
            });

            if (seq % 250 === 0) setChip('l1Chip', Compel:${rows.length});
          }
        }
      });
      return rows;
    })();

    const [t2txt, L1] = await Promise.all([t2Promise, scanPromise]);
    setChip('l1Chip', Compel:${L1.length});

    const p2 = parseDelimited(t2txt);
    if (!p2.rows.length) { alert('T-Soft CSV boş görünüyor.'); return false; }

    const s2 = p2.rows[0];

    const C1 = {
      siraNo: "Sıra No",
      marka: "Marka",
      urunAdi: "Ürün Adı",
      urunKodu: "Ürün Kodu",
      stok: "Stok",
      ean: "EAN",
      link: "Link"
    };

    const C2 = {
      ws: pickColumn(s2, ['Web Servis Kodu', 'WebServis Kodu', 'WebServisKodu']),
      urunAdi: pickColumn(s2, ['Ürün Adı', 'Urun Adi', 'Ürün Adi']),
      sup: pickColumn(s2, ['Tedarikçi Ürün Kodu', 'Tedarikci Urun Kodu', 'Tedarikçi Urun Kodu']),
      barkod: pickColumn(s2, ['Barkod', 'BARKOD']),
      stok: pickColumn(s2, ['Stok']),
      marka: pickColumn(s2, ['Marka']),
      seo: pickColumn(s2, ['SEO Link', 'Seo Link', 'SEO', 'Seo'])
    };

    const miss = ['ws','sup','barkod','stok','marka','urunAdi','seo'].filter(k => !C2[k]);
    if (miss.length) {
      setStatus('Sütun eksik', 'bad');
      console.warn('L2 missing', miss);
      alert('T-Soft CSV sütunları eksik. Konsola bak.');
      return false;
    }

    const L2all = p2.rows;

    // ✅ Compel markaları (normalize set)
    COMPEL_BRANDS_NORM = new Set(L1.map(r => normBrand(r[C1.marka] || '')).filter(Boolean));

    // ✅ L2: sadece Compel markalarıyla eşleşen markalar
    const L2 = L2all.filter(r => COMPEL_BRANDS_NORM.has(normBrand(r[C2.marka] || '')));

    matcher.loadData({ l1: L1, c1: C1, l2: L2, c2: C2, l2All: L2all });
    matcher.runMatch();
    refresh();

    setStatus('Hazır', 'ok');
    setChip('l2Chip', T-Soft:${L2.length}/${L2all.length});

    lockListTitleFromCurrentSelection();
    setListTitleVisible(true);

    return true;
  } catch (e) {
    console.error(e);
    setStatus(String(e?.message || 'Hata (konsol)'), 'bad');
    alert(e?.message || String(e));
    return false;
  } finally {
    abortCtrl = null;
    setScanState(false);
    applySupplierUi();
  }
}

/* =========================
   CSV output
   ========================= */
$('dl1')?.addEventListener('click', () => {
  const { R } = matcher.getResults();
  const clean = (R || []).map(r => Object.fromEntries(COLS.map(c => [c, r[c]])));
  downloadBlob('sonuc-eslestirme.csv', new Blob([toCSV(clean, COLS)], { type: 'text/csv;charset=utf-8' }));
});

/* =========================
   Tam reset
   ========================= */
function resetAll() {
  try { abortCtrl?.abort?.(); } catch {}
  abortCtrl = null;
  setScanState(false);

  hasEverListed = false;
  setGoMode('list');

  lastListedTitle = '';
  setListTitleVisible(false);

  SELECTED.clear();
  renderBrands();

  const f2 = $('f2');
  if (f2) f2.value = '';
  const n2 = $('n2');
  if (n2) { n2.textContent = 'Yükle'; n2.title = 'Yükle'; }

  const wsDl = $('wsCodes'), supDl = $('supCodes');
  if (wsDl) wsDl.innerHTML = '';
  if (supDl) supDl.innerHTML = '';

  TSOFT_OK_SUP_BY_BRAND = new Map();
  COMPEL_BRANDS_NORM = new Set();

  depot.reset();
  matcher.resetAll();

  clearOnlyLists();

  setChip('l1Chip', 'Compel:-');
  setChip('l2Chip', 'T-Soft:-');
  setChip('l4Chip', 'Aide:-');
  setChip('sum', '✓0 • ✕0', 'muted');

  setGuideStep('brand');
  applySupplierUi();
}

/* =========================
   Listele / Temizle davranışı
   ========================= */
async function handleGo() {
  if (ACTIVE_SUPPLIER === SUPPLIERS.AKALIN) { applySupplierUi(); return; }

  if (goMode === 'clear') {
    resetAll();
    return;
  }

  if (!hasEverListed && guideStep === 'list') setGuideStep('done');

  if (!hasEverListed && !SELECTED.size) {
    alert('Lütfen bir marka seçin');
    return;
  }

  const file = $('f2')?.files?.[0];
  if (!file) {
    alert('Lütfen T-Soft Stok CSV seç.');
    return;
  }

  if (!SELECTED.size) {
    clearOnlyLists();
    setGoMode('clear');
    return;
  }

  const ok = await generate();
  if (ok) {
    hasEverListed = true;
    setGoMode('list');
    setGuideStep('done');
  }
}

if (goBtn) goBtn.onclick = handleGo;

/* =========================
   İlk yük
   ========================= */
ensureListHeader();
setGoMode('list');
setGuideStep('brand');
initBrands();
applySupplierUi();

ChatGPT:
Tamam.


Şunu dedin:
// Worker API çağrıları (brands + scan stream)
export async function loadBrands(API_BASE) {
  const res = await fetch(${API_BASE}/api/brands, { cache: 'no-store' });
  if (!res.ok) throw new Error(API /api/brands hata: ${res.status});
  return await res.json();
}

// scan endpoint'i NDJSON (satır satır JSON) stream döndürüyor
export async function scanCompel(API_BASE, chosenBrands, { signal, onMessage } = {}) {
  const res = await fetch(${API_BASE}/api/scan, {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ brands: chosenBrands }),
    signal
  });

  if (!res.ok) {
    const t = await res.text().catch(() => '');
    throw new Error(API /api/scan hata: ${res.status}\n${t});
  }

  const rd = res.body?.getReader?.();
  if (!rd) throw new Error('Stream yok (reader alınamadı).');

  const dec = new TextDecoder();
  let buf = '';

  while (true) {
    const { value, done } = await rd.read();
    if (done) break;

    buf += dec.decode(value, { stream: true });

    let i;
    while ((i = buf.indexOf('\n')) >= 0) {
      const line = buf.slice(0, i).trim();
      buf = buf.slice(i + 1);
      if (!line) continue;

      let msg = null;
      try { msg = JSON.parse(line); } catch { continue; }
      if (onMessage) onMessage(msg);
    }
  }
}

ChatGPT:
Tamam.


Şunu dedin:
sen dünyanın en iyi yazılımcısısın. "Tedarikçi Compel için Arturia markasında yapılan T-Soft ve Aide karşılaştırma listesi" başlığı altındaki "T-Soft Ürün Adı" başlıklı sütunun altında listelenen ürün adlarının oarada olması için gereken kriterler ne ? (çok uzun cevap yazma)

ChatGPT:

36s boyunca düşündüm
“T-Soft Ürün Adı” sütununda bir adın görünmesi için, o satırdaki Compel ürünüyle T-Soft (products.csv) tarafında bir kayıt eşleşmiş olmalı. Eşleşme kriterleri:

EAN eşleşmesi: Compel’deki EAN’lerden biri, T-Soft’taki Barkod ile aynıysa (en güçlü kriter).

KOD eşleşmesi: Compel Ürün Kodu = T-Soft Web Servis Kodu ise (marka da uyuşmalı).

(Varsa) JSON/manuel mapping: Daha önce kaydedilmiş bir eşleştirme varsa o da kullanılır.

Bunlardan hiçbiri yoksa o satırda T-Soft Ürün Adı boş kalır. Ayrıca liste “Arturia” için üretildiğinden T-Soft tarafında da Arturia markalı kayıtlar dikkate alınır.


Şunu dedin:
peki "Compel, T-Soft ve Aide Eşleşmeyen Ürünler Listesi" başlığı altındaki "T-Soft Ürün Adı" başlıklı sütunun altında listelenen ürün adlarının oarada olması için gereken kriterler ne ?

ChatGPT:
“O listede” T-Soft Ürün Adı altında görünenler, products.csv içinden gelip Compel’e göre “eşleşmemiş” sayılan T-Soft kayıtlarıdır. Kriterler:

T-Soft kaydının Markası, taranan/filtrelenen Compel markaları içinde olmalı (örn. Arturia).

T-Soft Ürün Adı boş olmamalı.

Bu T-Soft kaydı, Compel tarafında hiçbir ürünle EAN ile veya KOD ile (Compel Ürün Kodu = T-Soft Web Servis Kodu) eşleşmiş olmamalı.

Not: SUP/JSON/MANUAL eşleşmeleri “eşleşmiş” sayılmadığı için bu listeye düşebilir.

Aynı marka içinde aynı (sup + ürün adı) tekrarları tekilleştirilir.


Şunu dedin:
"Not: SUP/JSON/MANUAL eşleşmeleri “eşleşmiş” sayılmadığı için bu listeye düşebilir.

Aynı marka içinde aynı (sup + ürün adı) tekrarları tekilleştirilir." burada ne demek istedin çünkü listede eşleşmiş ürünler de görünüyor da

ChatGPT:

30s boyunca düşündüm
Haklısın—benim “SUP/JSON/MANUAL” notum şu anlama geliyor:

1) “Eşleşmiş ürünler UT listesinde niye görünüyor?”
Bu “Compel, T-Soft ve Aide Eşleşmeyen…” listesindeki T-Soft Ürün Adı (UT), sadece şu iki tip eşleşmeyi “eşleşmiş” sayıp listeden düşürüyor:

EAN ile eşleşenler

KOD ile eşleşenler (Compel Ürün Kodu = T-Soft Web Servis Kodu)

Bunun dışındaki eşleştirmeler:

JSON mapping ile bulunan (byMap),

MANUAL eşleştirme,

veya “SUP üzerinden bir şekilde eşleştiğini düşündüğün” durumlar

UT filtresinde eşleşmiş kabul edilmediği için T-Soft tarafında hala “eşleşmeyen” gibi görünebilir.
Yani ana tabloda “eşleşmiş” görmen, UT’nin onu mutlaka düşüreceği anlamına gelmiyor (UT’nin kriteri daha dar).

2) “Aynı (sup + ürün adı) tekrarları tekilleştirilir” ne demek?
UT listesine eklerken aynı marka içinde aynı T-Soft kaydı tekrar gelmesin diye:

Marka + (Tedarikçi Ürün Kodu / sup) + Ürün Adı aynıysa, sadece bir kez gösteriyor.
(sup boşsa “—” gibi düşün.)

İstersen “eşleşmiş görünüp UT’ye düşen” bir örnek satırın _how değerini söylersen, hangi yüzden düştüğünü direkt gösterebilirim.


Şunu dedin:
ut ne kısaca ?

ChatGPT:
UT, match.js içinde kullanılan bir liste adı:
T-Soft tarafındaki (products.csv) “Compel’e göre eşleşmeyen” ürünlerin listesi.

Yani: T-Soft’ta var ama Compel’de EAN veya KOD ile eşleşmiş sayılmayanlar bu listeye giriyor.


Şunu dedin:
sup ne demek kısaca
bir de _how değeri nasıl verebilirim kısaca ve basitce

ChatGPT:
sup: T-Soft CSV’deki “Tedarikçi Ürün Kodu” sütunu. (Kod gibi düşünebilirsin; match.js içinde C2.sup)

_how: Bir satırın Compel→T-Soft hangi yöntemle eşleştiğini tutan alan. Değerleri genelde: EAN, KOD, JSON, MANUAL (eşleşmediyse boş).

_how değerini en basit şöyle görebilirsin:

Tarayıcıda F12 → Console aç

Şunu yaz:

matcher.getResults().R.slice(0,20).map(r => [r["Ürün Adı (Compel)"], r["Ürün Adı (T-Soft)"], r._how])
İstersen belirli bir ürün adına göre filtre:

matcher.getResults().R.filter(r => (r["Ürün Adı (T-Soft)"]||"").includes("ARAMA")).map(r => [r["Ürün Adı (T-Soft)"], r._how])
"ARAMA" yerine ürün adından bir parça yazman yeterli.


Şunu dedin:
tamamdır ben yanlış anlamışım öyle bişey yokmuş. diğer soruma geçiyorum hazır mısın

ChatGPT:
Hazırım.


Şunu dedin:
"Compel, T-Soft ve Aide Eşleşmeyen Ürünler Listesi" başlığı altındaki "Depo Ürün Adı" başlıklı sütunun altında listelenen ürün adlarının orada olması için gereken kriterler ne ? sade şekilde çok uzatmadan yaz

ChatGPT:
“Depo Ürün Adı” altında görünenler, Aide (depo) verisinden gelen ve şu şartları sağlayan ürünlerdir:

Depo (Aide) verisi yüklenmiş olmalı.

Depo satırında geçerli Marka olmalı (boş / “-” / “—” / “N/A” değil).

Depo satırında Stok Kodu olmalı.

Depo satırında ürün adı olarak MODEL (yoksa diğer fallback alanlar) dolu olmalı.

Bu ürünün markası, Compel taramasında çıkan markalar içinde olmalı.

Ve en önemlisi: aynı marka içinde, bu ürünün Stok Kodu (gerekirse başındaki 0’lar atılmış haliyle de) T-Soft’ta Compel’e EAN veya KOD ile eşleşmiş ürünlerin “Tedarikçi Ürün Kodu (sup)” listesinde yoksa burada listelenir.

Aynı marka içinde aynı ürün adı tekrar ederse tekilleştirilir.


Şunu dedin:
Neyin listelenmesini istediğimi söyleyeyim. sen bütün bu kriterleri benim isteğime göre  dikkatlice revize et. "Depo Ürün Adı" sütunu başlığı altında;
Compel'den gelen datadaki seçili Marka'nın marka bilgisini, Aide verisindeki "Marka" sütunu altına denk gelen listedeki markalarla eşleşen, ürünler arasından T-Soft csv'si içindeki "Tedarikçi Ürün Kodu" alanındaki hiçbir ürünle eşleşmeyen ürünlerin Aide verisindeki "Model" sütunundaki ürün adları.

aşağıda örnek teşkil etmesi için aide datasının ilk kısmını yapıştırdım;

Marka sütunu altındakiler: "-, - ve ABLETON"
Model sütunu altındakiler: "ENTEGRA V3 ONLINE 2026, MB PRO 14-CORE SPACE BLACK ve Live V12 Standart (89152)"

"Sesçibaba Logo
Siparişler
13
Stok Listesi
Ara
Marka	Model	Stok Kodu	Açıklama	Stok	Ambar	Firma
Ara
Ara
Ara
Ara
Ara
Ara
-	ENTEGRA V3 ONLINE 2026	260.01.0008	//	1	Ankara	Sescibaba
-	MB PRO 14-CORE SPACE BLACK	255.01.0009	//	1	Ankara	Sescibaba
ABLETON	Live V12 Standart (89152)	ABL0021	ABLETON Live V12 Standart (89152) // 083-89152	0	sescibaba	Sescibaba"

senin dünyanın en iyi yazılımcısı olduğunu hatırlatarak, düzenlenicek dosyanın düzenlenmiş kodunun tamamını ilet düzenlenmicek ve düzenlenicek dosyaları en başta belirt.

ChatGPT:

2m 47s boyunca düşündüm
Düzenlenecek dosyalar
js/app.js

js/depot.js

Düzenlenmeyecek dosyalar
index.html

js/utils.js

js/render.js

js/match.js

js/api.js

Aşağıdaki revizyonla “Depo Ürün Adı” şunu listeleyecek:
Seçili/Compel’den gelen markayla Aide “Marka”sı eşleşen ürünler arasından, Aide “Stok Kodu”su T-Soft CSV’deki “Tedarikçi Ürün Kodu (sup)” alanında hiç yoksa, Aide “Model” değeri.

// js/depot.js
import { TR, T, parseDelimited, pickColumn } from './utils.js';

const $ = id => document.getElementById(id);

/* =========================
   ✅ Depo Modülü
   ========================= */

export function createDepot({ ui, onDepotLoaded, normBrand } = {}) {
  // state
  let L4 = [];
  let C4 = {};
  let idxD = new Map();
  let depotReady = false;

  // ✅ marka normalize -> [{code, alt, name}]
  let idxBR = new Map();
  let brandLabelByNorm = new Map();

  // dom
  const depoBtn = $('depoBtn');
  const depoModal = $('depoModal');
  const depoInner = $('depoInner');
  const depoPaste = $('depoPaste');
  const depoLoad = $('depoLoad');
  const depoPasteBtn = $('depoPasteBtn');
  const depoClose = $('depoClose');
  const depoClear = $('depoClear');
  const depoSpin = $('depoSpin');

  const depotCodeNorm = s =>
    (s ?? '').toString()
      .replace(/\u00A0/g, ' ')
      .trim()
      .replace(/\s+/g, ' ')
      .toLocaleUpperCase(TR);

  const depotCodeAlt = n => {
    if (!n) return '';
    if (!/^[0-9]+$/.test(n)) return '';
    return n.replace(/^0+(?=\d)/, '');
  };

  // ✅ Marka '-' satırlarını ignore
  const isBadBrand = (raw) => {
    const s = T(raw);
    return !s || s === '-' || s === '—' || s.toLocaleUpperCase(TR) === 'N/A';
  };

  const brandNormFn = (raw) => {
    const s = T(raw);
    if (!s || isBadBrand(s)) return '';
    if (typeof normBrand === 'function') return normBrand(s);
    return s.toLocaleUpperCase(TR).replace(/\s+/g, ' ').trim();
  };

  function depotStockNum(raw) {
    let s = (raw ?? '').toString().trim();
    if (!s) return 0;
    if (s.includes('.') && s.includes(',')) s = s.replace(/\./g, '').replace(/,/g, '.');
    else s = s.replace(/,/g, '.');
    s = s.replace(/[^0-9.\-]/g, '');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }

  function pickAideName(r) {
    // ✅ Aide CSV’de ürün adı=MODEL
    const model = C4.model ? T(r[C4.model] ?? '') : '';
    if (model) return model;

    // fallback’ler
    const urunAdi = C4.urunAdi ? T(r[C4.urunAdi] ?? '') : '';
    if (urunAdi) return urunAdi;

    const ac = C4.aciklama ? T(r[C4.aciklama] ?? '') : '';
    if (ac) return ac;

    return '';
  }

  function buildBrandRecordsIdx() {
    idxBR = new Map();
    brandLabelByNorm = new Map();
    if (!depotReady || !L4.length || !C4.stokKodu) return;

    const seen = new Map(); // brNorm -> Set(key)
    for (const r of L4) {
      const brRaw = T(C4.marka ? (r[C4.marka] ?? '') : (r["Marka"] ?? ''));
      if (isBadBrand(brRaw)) continue;

      const brNorm = brandNormFn(brRaw);
      if (!brNorm) continue;

      if (!brandLabelByNorm.has(brNorm)) brandLabelByNorm.set(brNorm, brRaw || brNorm);

      const rawCode = r[C4.stokKodu] ?? '';
      const code = depotCodeNorm(rawCode);
      if (!code) continue;

      const alt = depotCodeAlt(code);
      const name = pickAideName(r);
      if (!name) continue;

      if (!seen.has(brNorm)) seen.set(brNorm, new Set());
      const s = seen.get(brNorm);
      const k = (code + '||' + name).toLocaleLowerCase(TR).replace(/\s+/g, ' ').trim();
      if (k && s.has(k)) continue;
      if (k) s.add(k);

      if (!idxBR.has(brNorm)) idxBR.set(brNorm, []);
      idxBR.get(brNorm).push({ code, alt, name });
    }

    for (const [br, arr] of idxBR.entries()) {
      arr.sort((a, b) => String(a.name).localeCompare(String(b.name), 'tr', { sensitivity: 'base' }));
    }
  }

  function buildDepotIdx() {
    idxD = new Map();
    if (!depotReady || !L4.length || !C4.stokKodu) return;

    for (const r of L4) {
      const raw = r[C4.stokKodu] ?? '';
      const k = depotCodeNorm(raw);
      if (!k) continue;

      if (!idxD.has(k)) idxD.set(k, []);
      idxD.get(k).push(r);

      const alt = depotCodeAlt(k);
      if (alt && alt !== k) {
        if (!idxD.has(alt)) idxD.set(alt, []);
        idxD.get(alt).push(r);
      }
    }

    buildBrandRecordsIdx();
  }

  function depotAgg(code) {
    if (!depotReady) return { num: 0, raw: '' };
    const k = depotCodeNorm(code || '');
    if (!k) return { num: 0, raw: '0' };

    const alt = depotCodeAlt(k);
    const arr = idxD.get(k) || (alt ? idxD.get(alt) : null);
    if (!arr?.length) return { num: 0, raw: '0' };

    let sum = 0;
    for (const r of arr) sum += depotStockNum(r[C4.stok] ?? '');
    return { num: sum, raw: String(sum) };
  }

  /**
   * ✅ REVİZE KURAL (senin istediğin):
   * - Compel/Seçili markalarla eşleşen Aide markaları içinden,
   * - Aide "Stok Kodu" (ve sayısalsa baştaki 0'ları atılmış hali) T-Soft CSV'deki
   *   "Tedarikçi Ürün Kodu" (sup) alanında HİÇ YOKSA,
   * - Aide "Model" adı "Depo Ürün Adı" olarak listelenir.
   *
   * Not: stok miktarına bakmıyoruz (0 da olabilir).
   */
  function unmatchedRows({ brandsNormSet, tsoftSupByBrand } = {}) {
    if (!depotReady) return [];
    const bnSet = (brandsNormSet instanceof Set) ? brandsNormSet : null;

    const out = [];
    const seen = new Set(); // br||name

    for (const [brNorm, arr] of idxBR.entries()) {
      if (bnSet && !bnSet.has(brNorm)) continue;

      // ✅ bu marka için T-Soft'taki TÜM sup kodları seti
      const supSet = tsoftSupByBrand?.get?.(brNorm);
      const sset = (supSet instanceof Set) ? supSet : null;

      for (const it of arr) {
        // ✅ Aide stok kodu, T-Soft sup listesinde VARSA => listeleme
        const hit = sset ? (sset.has(it.code) || (it.alt ? sset.has(it.alt) : false)) : false;
        if (hit) continue;

        const brandDisp = brandLabelByNorm.get(brNorm) || brNorm;
        const nm = it.name || '';
        if (!nm) continue;

        const k = (brNorm + '||' + nm).toLocaleLowerCase(TR).replace(/\s+/g, ' ').trim();
        if (!k || seen.has(k)) continue;
        seen.add(k);

        const ag = depotAgg(it.code);
        out.push({
          _type: 'depo',
          _bn: brNorm,
          "Marka": brandDisp,
          "Depo Ürün Adı": nm,
          _dnum: ag?.num ?? 0
        });
      }
    }

    out.sort((a, b) => {
      const ab = String(a["Marka"] || '').localeCompare(String(b["Marka"] || ''), 'tr', { sensitivity: 'base' });
      if (ab) return ab;
      return String(a["Depo Ürün Adı"] || '').localeCompare(String(b["Depo Ürün Adı"] || ''), 'tr', { sensitivity: 'base' });
    });

    return out;
  }

  const syncDepoSpin = () => {
    if (!depoSpin) return;
    const has = (depoPaste?.value || '').trim().length > 0;
    depoSpin.style.display = has ? 'none' : 'block';
  };

  const setDepoUi = (loaded) => {
    const n4 = $('n4');
    if (n4) {
      n4.textContent = loaded ? 'Yüklendi' : 'Yükle';
      n4.title = loaded ? `Depo yüklü (${L4.length})` : 'Yükle';
    }
    ui?.setChip?.('l4Chip', loaded ? `Aide:${L4.length}` : 'Aide:-');
  };

  // ✅ Popover konumlandırma
  const placePopover = () => {
    if (!depoBtn || !depoInner) return;
    depoInner.style.position = 'fixed';
    depoInner.style.left = '12px';
    depoInner.style.top = '12px';
    depoInner.style.visibility = 'hidden';

    requestAnimationFrame(() => {
      const a = depoBtn.getBoundingClientRect();
      const r = depoInner.getBoundingClientRect();
      const root = getComputedStyle(document.documentElement);
      const M = parseFloat(root.getPropertyValue('--popM')) || 12;
      const G = parseFloat(root.getPropertyValue('--popGap')) || 10;

      let left = a.left;
      left = Math.max(M, Math.min(left, window.innerWidth - r.width - M));

      let top = a.top - r.height - G;
      if (top < M) top = a.bottom + G;
      top = Math.max(M, Math.min(top, window.innerHeight - r.height - M));

      depoInner.style.left = left + 'px';
      depoInner.style.top = top + 'px';
      depoInner.style.visibility = 'visible';
    });
  };

  const showDepo = () => {
    if (!depoModal) return;
    depoModal.style.display = 'block';
    depoModal.setAttribute('aria-hidden', 'false');
    placePopover();
    syncDepoSpin();
    setTimeout(() => depoPaste?.focus(), 0);
  };

  const hideDepo = () => {
    if (!depoModal) return;
    depoModal.style.display = 'none';
    depoModal.setAttribute('aria-hidden', 'true');
    if (depoInner) {
      depoInner.style.position = '';
      depoInner.style.left = '';
      depoInner.style.top = '';
      depoInner.style.visibility = '';
    }
  };

  /* noisy paste parser */
  function depotFromNoisyPaste(text) {
    const FirmaDefault = "Sescibaba";
    const N = s => !s || /^(Tümü|Sesçibaba Logo|Şirketler|Siparişler|Onay Bekleyen|Sipariş Listesi|İade Listesi|Sesçibaba Stokları|Stok Listesi|Ara|Previous|Next|E-Commerce Management.*|Showing\b.*|Marka\s+Model\s+Stok\s+Kodu.*|\d+)$/.test(s);

    const out = [];
    const lines = (text || '').split(/\r\n|\r|\n/);

    for (let l of lines) {
      l = (l || '').replace(/\u00A0/g, " ").trim();
      if (N(l)) continue;

      if (!l.includes("\t")) continue;

      const a = l.split("\t").map(x => x.trim()).filter(Boolean);
      if (a.length < 6) continue;

      let m = '', mo = '', k = '', ac = '', s = '', w = '', f = FirmaDefault;

      if (a.length === 6) {
        m = a[0]; mo = a[1]; k = a[2]; ac = a[3]; s = a[4]; w = a[5];
      } else {
        m = a[0];
        f = a.at(-1) || FirmaDefault;
        w = a.at(-2) || '';
        s = a.at(-3) || '';
        const mid = a.slice(1, -3);
        if (mid.length < 3) continue;
        mo = mid.slice(0, -2).join(" ");
        k = mid.at(-2) || '';
        ac = mid.at(-1) || '';
      }

      const stokStr = String(s ?? '').trim();
      if (!stokStr || !/^-?\d+(?:[.,]\d+)?$/.test(stokStr)) continue;

      out.push({
        "Marka": m,
        "Model": mo,
        "Stok Kodu": k,
        "Açıklama": ac,
        "Stok": stokStr,
        "Ambar": w,
        "Firma": f
      });
    }

    return out;
  }

  function loadDepotFromText(text) {
    const raw = (text ?? '').toString();
    if (!raw.trim()) return alert('Depo verisi boş.');

    let ok = false;
    try {
      const p = parseDelimited(raw);
      const rows = p?.rows || [];
      if (rows.length) {
        const sample = rows[0];
        const stokKodu = pickColumn(sample, ['Stok Kodu', 'StokKodu', 'STOK KODU', 'Stock Code']);
        const stok = pickColumn(sample, ['Stok', 'Miktar', 'Qty', 'Quantity']);
        if (stokKodu && stok) {
          L4 = rows;
          C4 = {
            stokKodu,
            stok,
            ambar: pickColumn(sample, ['Ambar', 'Depo', 'Warehouse']),
            firma: pickColumn(sample, ['Firma', 'Şirket', 'Company']),
            marka: pickColumn(sample, ['Marka', 'MARKA', 'Brand', 'BRAND']),
            model: pickColumn(sample, ['Model', 'MODEL']),
            urunAdi: pickColumn(sample, ['Ürün Adı', 'Urun Adi', 'Ürün Adi', 'Product Name', 'Product']),
            aciklama: pickColumn(sample, ['Açıklama', 'Aciklama', 'Description'])
          };
          ok = true;
        }
      }
    } catch {
      ok = false;
    }

    if (!ok) {
      const r2 = depotFromNoisyPaste(raw);
      if (!r2.length) return alert('Depo verisi çözümlenemedi. (Tablolu kopya bekleniyordu.)');
      L4 = r2;
      C4 = {
        stokKodu: 'Stok Kodu',
        stok: 'Stok',
        ambar: 'Ambar',
        firma: 'Firma',
        marka: 'Marka',
        model: 'Model',
        aciklama: 'Açıklama'
      };
      ok = true;
    }

    depotReady = true;
    buildDepotIdx();
    setDepoUi(true);
    ui?.setStatus?.('Depo yüklendi', 'ok');

    onDepotLoaded?.();
  }

  function reset() {
    depotReady = false;
    L4 = [];
    C4 = {};
    idxD = new Map();
    idxBR = new Map();
    brandLabelByNorm = new Map();
    if (depoPaste) depoPaste.value = '';
    syncDepoSpin();
    setDepoUi(false);
  }

  // events
  if (depoBtn) depoBtn.onclick = showDepo;
  if (depoClose) depoClose.onclick = hideDepo;

  if (depoPasteBtn) depoPasteBtn.onclick = async () => {
    try {
      if (!navigator.clipboard?.readText) {
        alert('Panoya erişilemiyor. Sayfayı HTTPS üzerinden açın ve izin verin.');
        return;
      }
      depoPasteBtn.disabled = true;
      const txt = await navigator.clipboard.readText();
      if (!txt?.trim()) {
        alert('Panoda yapıştırılacak metin yok.');
        return;
      }
      if (depoPaste) depoPaste.value = txt;
      syncDepoSpin();
      depoPaste?.focus();
    } catch (e) {
      console.error(e);
      alert('Pano okunamadı. Tarayıcı izinlerini kontrol edin.');
    } finally {
      if (depoPasteBtn) depoPasteBtn.disabled = false;
    }
  };

  if (depoPaste) {
    depoPaste.addEventListener('input', syncDepoSpin);
    depoPaste.addEventListener('paste', () => setTimeout(syncDepoSpin, 0));
  }

  if (depoClear) depoClear.onclick = () => {
    if (depoPaste) depoPaste.value = '';
    syncDepoSpin();
    depoPaste?.focus();
  };

  if (depoLoad) depoLoad.onclick = () => {
    loadDepotFromText(depoPaste?.value || '');
    hideDepo();
  };

  addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && depoModal?.style.display !== 'none') hideDepo();
  });

  addEventListener('resize', () => {
    if (depoModal?.style.display === 'block') placePopover();
  });
  addEventListener('scroll', () => {
    if (depoModal?.style.display === 'block') placePopover();
  }, true);

  // init ui
  setDepoUi(false);
  syncDepoSpin();

  return {
    reset,
    isReady: () => depotReady,
    agg: depotAgg,
    count: () => L4.length,
    unmatchedRows
  };
}
// js/app.js
import { TR, esc, parseDelimited, pickColumn, downloadBlob, toCSV, readFileText, T } from './utils.js';
import { loadBrands, scanCompel } from './api.js';
import { createMatcher, normBrand, COLS } from './match.js';
import { createDepot } from './depot.js';
import { createRenderer } from './render.js';

const $ = id => document.getElementById(id);

const API_BASE = "https://robot-workstation.tvkapora.workers.dev";

/* =========================
   Supplier state
   ========================= */
const SUPPLIERS = { COMPEL: 'Compel', AKALIN: 'Akalın' };
let ACTIVE_SUPPLIER = SUPPLIERS.COMPEL;
let COMPEL_BRANDS_CACHE = null;

// ✅ Compel marka seti (normalize) — Depo eşleşmeyenleri filtrelemek için
let COMPEL_BRANDS_NORM = new Set();

const AKALIN_BRAND_NAMES = [
  "Acoustic Energy","AIAIAI","AMS-Neve","Antelope Audio","Apple","ART","Artiphon","Artnovion","Asparion","ATC-Loudspeakers",
  "Audient","Audio-Technica","Audix","Auratone","Avid","Barefoot","Bricasti-Design","Celemony","Centrance","CME",
  "Dangerous-Music","DD-HiFi","Digital-Audio-Denmark","Dj-techtools","Direct-Sound","Doto-Design","Drawmer","DreamWave","Earthworks-Audio","Elektron-Music-Machines",
  "Elysia","Embodme","Empirical-Labs","Erica-Synths","ESI-Audio","Eve-Audio","Eventide-Audio","Fatman-by-TL-Audio","Flock-Audio","Focusrite",
  "Freqport","Gainlab-Audio","Gator-Frameworks","Grace-Design","Hifiman","Hori","Icon-Pro-Audio","IK-Multimedia","IsoAcoustics","Konig-Meyer",
  "Koss","Lake-People","Lynx-Studio-Technology","M-Live","Magma","Manley-Laboratories","Melbourne-Instruments","Microtech-Gefell","Midiplus","Millennia-Music-Media",
  "Modal-Electronics","Mogami","Mojave-Audio","Monster-Audio","Monster-Cable","Moondrop","MOTU","MXL-Microphones","Mytek-Audio","Native-Instruments",
  "Neo-Created-by-OYAIDE-Elec","Neumann","Neutrik","Noble-Audio","Odisei-Music","Phase","Polyend","Primacoustic","ProCab","PSI-Audio",
  "Radial-Engineering","Relacart","Reloop","Reloop-HiFi","Rhodes","Royer-Labs","Sendy-Audio","Signex","Sivga-Audio","Slate-Digital",
  "Smithson-Martin","Soma-Synths","Sonnet","Specialwaves","Spectrasonics","Steven-Slate-Audio","Studiologic-by-Fatar","Synchro-Arts","Tantrum-Audio","Teenage-Engineering",
  "Telefunken-Elektroakustik","Thermionic-Culture","Topping-Audio","Topping-Professional","Triton-Audio","Truthear","Tube-Tech","Udo-Audio","Ultimate-Support","Waldorf",
  "Waves"
];

/* =========================
   Guided pulse (2->3->4->5)
   ========================= */
let guideStep = 'brand'; // brand -> tsoft -> aide -> list -> done

const GUIDE_DUR = {
  brand: 1500,
  tsoft: 1250,
  aide: 1050,
  list: 900
};

const clearGuidePulse = () => {
  const ids = ['brandHintBtn', 'sescBox', 'depoBtn', 'go'];
  for (const id of ids) {
    const el = $(id);
    if (!el) continue;
    el.classList.remove('guidePulse');
    el.style.removeProperty('--guideDur');
  }
};

const setGuideStep = (s) => {
  guideStep = s || 'done';
  updateGuideUI();
};

const updateGuideUI = () => {
  clearGuidePulse();
  if (ACTIVE_SUPPLIER === SUPPLIERS.AKALIN) return;
  if (guideStep === 'done') return;

  const dur = GUIDE_DUR[guideStep] || 1200;
  const apply = (el) => {
    if (!el) return;
    el.style.setProperty('--guideDur', `${dur}ms`);
    el.classList.add('guidePulse');
  };

  if (guideStep === 'brand') apply($('brandHintBtn'));
  else if (guideStep === 'tsoft') apply($('sescBox'));
  else if (guideStep === 'aide') apply($('depoBtn'));
  else if (guideStep === 'list') apply($('go'));
};

/* =========================
   UI helpers
   ========================= */
const setChip = (id, t, cls = '') => {
  const e = $(id);
  if (!e) return;
  const txt = String(t ?? '');
  e.textContent = txt;
  e.title = txt;
  e.className = 'chip' + (cls ? ` ${cls}` : '');
};

const setStatus = (t, k = 'ok') => {
  const st = $('stChip');
  if (!st) return;

  const msg = String(t ?? '').trim();
  if (!msg || msg.toLocaleLowerCase(TR) === 'hazır') {
    st.style.display = 'none';
    st.textContent = '';
    st.title = '';
    st.className = 'chip ok';
    return;
  }

  st.style.display = '';
  setChip('stChip', msg, k);
};

const ui = { setChip, setStatus };

const INFO_HIDE_IDS = ['brandStatus', 'l1Chip', 'l2Chip', 'l4Chip', 'sum'];

/* =========================
   Brand + selection state
   ========================= */
let BRANDS = [];
let SELECTED = new Set();
let brandPrefix = 'Hazır';

/* ✅ Depo karşılaştırması için:
   Seçili/Compel markalarındaki T-Soft CSV’nin TÜM "Tedarikçi Ürün Kodu" (sup) seti (marka bazlı) */
let TSOFT_SUP_BY_BRAND = new Map();

// ✅ T-Soft'un son yüklenen L2/C2 bilgisi (sup setini kurmak için)
let TSOFT_L2 = [];
let TSOFT_C2 = null;

const codeNorm = (s) =>
  (s ?? '').toString()
    .replace(/\u00A0/g, ' ')
    .trim()
    .replace(/\s+/g, ' ')
    .toLocaleUpperCase(TR);

const codeAlt = (n) => {
  const k = codeNorm(n);
  if (!k) return '';
  if (!/^[0-9]+$/.test(k)) return '';
  return k.replace(/^0+(?=\d)/, '');
};

/* ✅ brand chip */
const updateBrandChip = () => {
  const el = $('brandStatus');
  if (!el) return;
  if (ACTIVE_SUPPLIER === SUPPLIERS.AKALIN) return;

  const total = BRANDS?.length ?? 0;
  const sel = SELECTED?.size ?? 0;
  el.textContent = `${brandPrefix} • Marka: ${total}/${sel}`;
  el.title = el.textContent;
};

/* =========================
   Liste başlığı
   ========================= */
let listTitleEl = null;
let listSepEl = null;
let lastListedTitle = '';
let hasEverListed = false;

const joinTrList = (arr) => {
  const a = (arr || []).filter(Boolean);
  if (!a.length) return '';
  if (a.length === 1) return a[0];
  if (a.length === 2) return `${a[0]} ve ${a[1]}`;
  return `${a.slice(0, -1).join(', ')} ve ${a[a.length - 1]}`;
};

const getSupplierName = () => {
  const t = ($('supplierLabel')?.textContent || $('supplierBtn')?.textContent || '').trim();
  const m = t.match(/:\s*(.+)\s*$/);
  if (m) return (m[1] || '').trim() || '—';
  return t.replace(/^1\)\s*/i, '').replace(/^Tedarikçi\s*/i, '').trim() || '—';
};

const getSelectedBrandNames = () => {
  const out = [];
  for (const id of SELECTED) {
    const b = BRANDS.find(x => x.id === id);
    if (b?.name) out.push(String(b.name));
  }
  out.sort((a, b) => a.localeCompare(b, 'tr', { sensitivity: 'base' }));
  return out;
};

const buildListTitle = () => {
  const sup = getSupplierName();
  const brands = getSelectedBrandNames();
  if (!brands.length) return `Tedarikçi ${sup} için marka seçilmedi.`;

  const brTxt = joinTrList(brands);
  const suffix = brands.length === 1 ? 'markasında' : 'markalarında';
  return `Tedarikçi ${sup} için ${brTxt} ${suffix} yapılan T-Soft ve Aide karşılaştırma listesi`;
};

const ensureListHeader = () => {
  const maincol = document.querySelector('section.maincol');
  if (!maincol || listTitleEl) return;

  const sep = document.createElement('div');
  sep.className = 'rowSep';
  sep.setAttribute('aria-hidden', 'true');

  listTitleEl = document.createElement('div');
  listTitleEl.id = 'listTitle';
  listTitleEl.className = 'listTitleBar';

  const first = maincol.firstElementChild;
  maincol.insertBefore(sep, first);
  maincol.insertBefore(listTitleEl, first);

  listSepEl = sep;

  listTitleEl.style.display = 'none';
  listSepEl.style.display = 'none';
};

const setListTitleVisible = (show) => {
  ensureListHeader();
  if (listTitleEl) listTitleEl.style.display = show ? '' : 'none';
  if (listSepEl) listSepEl.style.display = show ? '' : 'none';
};

const lockListTitleFromCurrentSelection = () => {
  ensureListHeader();
  lastListedTitle = buildListTitle();
  if (listTitleEl) listTitleEl.textContent = lastListedTitle;
};

/* =========================
   Supplier UI
   ========================= */
let goMode = 'list'; // 'list' | 'clear'

const setGoMode = (mode) => {
  goMode = mode;
  const goBtn = $('go');
  if (!goBtn) return;
  if (mode === 'clear') {
    goBtn.textContent = 'Temizle';
    goBtn.title = 'Temizle';
  } else {
    goBtn.textContent = 'Listele';
    goBtn.title = 'Listele';
  }
};

const clearOnlyLists = () => {
  const t1 = $('t1'), t2 = $('t2');
  if (t1) t1.innerHTML = '';
  if (t2) t2.innerHTML = '';
  const sec = $('unmatchedSection');
  if (sec) sec.style.display = 'none';

  setListTitleVisible(false);

  const dl1 = $('dl1');
  if (dl1) dl1.disabled = true;

  setChip('sum', '✓0 • ✕0', 'muted');
};

const applySupplierUi = () => {
  const goBtn = $('go');
  if (goBtn) {
    if (ACTIVE_SUPPLIER === SUPPLIERS.AKALIN) {
      goBtn.classList.add('wip');
      goBtn.title = 'Yapım Aşamasında';
    } else {
      goBtn.classList.remove('wip');
    }
  }

  if (ACTIVE_SUPPLIER === SUPPLIERS.AKALIN) {
    for (const id of INFO_HIDE_IDS) {
      const el = $(id);
      if (el) el.style.display = 'none';
    }
    setStatus('Tedarikçi Akalın entegre edilmedi. Lütfen farklı bir tedarikçi seçin.', 'bad');
  } else {
    for (const id of INFO_HIDE_IDS) {
      const el = $(id);
      if (el) el.style.display = '';
    }
    setStatus('Hazır', 'ok');
    updateBrandChip();
  }

  updateGuideUI();
};

/* =========================
   T-Soft popover
   ========================= */
(() => {
  const box = $('sescBox');
  const inp = $('f2');
  const modal = $('tsoftModal');
  const inner = $('tsoftInner');
  const pickBtn = $('tsoftClose');
  const dismissBtn = $('tsoftDismiss');
  if (!box || !inp || !modal || !inner || !pickBtn || !dismissBtn) return;

  let allowPickerOnce = false;
  const isOpen = () => modal.style.display === 'block';

  const placePopover = () => {
    inner.style.position = 'fixed';
    inner.style.left = '12px';
    inner.style.top = '12px';
    inner.style.visibility = 'hidden';

    requestAnimationFrame(() => {
      const a = box.getBoundingClientRect();
      const r = inner.getBoundingClientRect();
      const root = getComputedStyle(document.documentElement);
      const M = parseFloat(root.getPropertyValue('--popM')) || 12;
      const G = parseFloat(root.getPropertyValue('--popGap')) || 10;

      let left = a.left;
      left = Math.max(M, Math.min(left, window.innerWidth - r.width - M));

      let top = a.top - r.height - G;
      if (top < M) top = a.bottom + G;
      top = Math.max(M, Math.min(top, window.innerHeight - r.height - M));

      inner.style.left = left + 'px';
      inner.style.top = top + 'px';
      inner.style.visibility = 'visible';
    });
  };

  const show = () => {
    modal.style.display = 'block';
    modal.setAttribute('aria-hidden', 'false');
    placePopover();
    setTimeout(() => pickBtn.focus(), 0);
  };

  const hide = () => {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    inner.style.position = '';
    inner.style.left = '';
    inner.style.top = '';
    inner.style.visibility = '';
  };

  const openPicker = () => {
    allowPickerOnce = true;
    hide();
    requestAnimationFrame(() => {
      try { inp.click(); }
      finally { setTimeout(() => { allowPickerOnce = false; }, 0); }
    });
  };

  box.addEventListener('click', (e) => {
    if (inp.disabled) return;
    if (allowPickerOnce) { allowPickerOnce = false; return; }
    e.preventDefault();
    e.stopPropagation();
    show();
  }, true);

  pickBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    openPicker();
  });

  dismissBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    hide();
  });

  addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    if (!isOpen()) return;
    e.preventDefault();
    e.stopPropagation();
    openPicker();
  });

  addEventListener('resize', () => { if (isOpen()) placePopover(); });
  addEventListener('scroll', () => { if (isOpen()) placePopover(); }, true);
})();

/* =========================
   Supplier Dropdown
   ========================= */
(() => {
  const wrap = $('supplierWrap');
  const btn = $('supplierBtn');
  const menu = $('supplierMenu');
  const addBtn = $('supplierAddBtn');
  const itemCompel = $('supplierCompelItem');
  const itemAkalin = $('supplierAkalinItem');

  if (!wrap || !btn || !menu || !itemCompel || !itemAkalin) return;

  const open = () => {
    menu.classList.add('show');
    menu.setAttribute('aria-hidden', 'false');
    btn.setAttribute('aria-expanded', 'true');
  };
  const close = () => {
    menu.classList.remove('show');
    menu.setAttribute('aria-hidden', 'true');
    btn.setAttribute('aria-expanded', 'false');
  };
  const toggle = () => (menu.classList.contains('show') ? close() : open());

  const paintMenu = () => {
    const mk = (el, name) => {
      const sel = (ACTIVE_SUPPLIER === name);
      el.setAttribute('aria-disabled', sel ? 'true' : 'false');
      el.textContent = sel ? `${name} (seçili)` : name;
    };
    mk(itemCompel, SUPPLIERS.COMPEL);
    mk(itemAkalin, SUPPLIERS.AKALIN);
  };

  const setSupplier = async (name) => {
    if (!name || name === ACTIVE_SUPPLIER) { close(); return; }

    ACTIVE_SUPPLIER = name;
    const lab = $('supplierLabel');
    if (lab) lab.textContent = `1) Tedarikçi: ${name}`;

    if (name === SUPPLIERS.AKALIN) {
      brandPrefix = 'Akalın';
      BRANDS = AKALIN_BRAND_NAMES.map((nm, i) => ({
        id: i + 1,
        slug: String(nm).toLocaleLowerCase(TR).replace(/\s+/g, '-'),
        name: nm,
        count: '—'
      }));
    } else {
      brandPrefix = 'Hazır';
      if (COMPEL_BRANDS_CACHE?.length) {
        BRANDS = COMPEL_BRANDS_CACHE;
      } else {
        await initBrands();
      }
    }

    resetAll();
    paintMenu();
    close();
  };

  btn.addEventListener('click', (e) => {
    e.preventDefault();
    paintMenu();
    toggle();
  });

  itemCompel.addEventListener('click', (e) => {
    e.preventDefault();
    if (itemCompel.getAttribute('aria-disabled') === 'true') return;
    void setSupplier(SUPPLIERS.COMPEL);
  });

  itemAkalin.addEventListener('click', (e) => {
    e.preventDefault();
    if (itemAkalin.getAttribute('aria-disabled') === 'true') return;
    void setSupplier(SUPPLIERS.AKALIN);
  });

  addBtn?.addEventListener('click', (e) => { e.preventDefault(); close(); });

  document.addEventListener('click', (e) => { if (!wrap.contains(e.target)) close(); });
  addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });

  paintMenu();
})();

/* =========================
   Marka seçimi UI
   ========================= */
const renderBrands = () => {
  const list = $('brandList');
  if (!list) return;
  list.innerHTML = '';

  const sorted = [...BRANDS].sort((a, b) =>
    String(a.name || '').localeCompare(String(b.name || ''), 'tr', { sensitivity: 'base' })
  );

  sorted.forEach((b) => {
    const d = document.createElement('div');
    d.className = 'brand' + (SELECTED.has(b.id) ? ' sel' : '');
    d.tabIndex = 0;
    d.dataset.id = String(b.id);

    d.innerHTML = `
      <div class="bRow">
        <span class="bNm" title="${esc(b.name)}">${esc(b.name)}</span>
        <span class="bCt">(${esc(b.count)})</span>
      </div>
    `;
    list.appendChild(d);
  });

  updateBrandChip();

  if (!hasEverListed) {
    if (SELECTED.size > 0) setGuideStep('tsoft');
    else setGuideStep('brand');
  }

  applySupplierUi();
};

const toggleBrand = (id, el) => {
  if (SELECTED.has(id)) { SELECTED.delete(id); el.classList.remove('sel'); }
  else { SELECTED.add(id); el.classList.add('sel'); }

  updateBrandChip();

  if (!hasEverListed) {
    if (SELECTED.size > 0) setGuideStep('tsoft');
    else setGuideStep('brand');
  }

  applySupplierUi();
};

$('brandList')?.addEventListener('click', (e) => {
  const el = e.target.closest('.brand');
  if (!el) return;
  const id = Number(el.dataset.id);
  if (!Number.isFinite(id)) return;
  toggleBrand(id, el);
});

$('brandList')?.addEventListener('keydown', (e) => {
  if (e.key !== 'Enter' && e.key !== ' ') return;
  const el = e.target.closest('.brand');
  if (!el) return;
  e.preventDefault();
  const id = Number(el.dataset.id);
  if (!Number.isFinite(id)) return;
  toggleBrand(id, el);
});

const pulseBrands = () => {
  const list = $('brandList');
  if (!list) return;
  list.classList.remove('glow');
  void list.offsetWidth;
  list.classList.add('glow');
  setTimeout(() => list.classList.remove('glow'), 950);
};
$('brandHintBtn')?.addEventListener('click', pulseBrands);

async function initBrands() {
  brandPrefix = 'Hazır';
  const brandEl = $('brandStatus');
  if (brandEl) {
    brandEl.textContent = 'Markalar yükleniyor…';
    brandEl.title = brandEl.textContent;
  }

  try {
    const data = await loadBrands(API_BASE);
    COMPEL_BRANDS_CACHE = data;

    if (ACTIVE_SUPPLIER === SUPPLIERS.COMPEL) {
      BRANDS = data;
    }
  } catch (e) {
    console.error(e);
    if (ACTIVE_SUPPLIER === SUPPLIERS.COMPEL) {
      const brandEl2 = $('brandStatus');
      if (brandEl2) {
        brandEl2.textContent = 'Markalar yüklenemedi (API).';
        brandEl2.title = brandEl2.textContent;
      }
    }
  } finally {
    renderBrands();
    applySupplierUi();
  }
}

/* =========================
   Depo + Matcher + Renderer
   ========================= */
const depot = createDepot({
  ui,
  normBrand,
  onDepotLoaded: () => {
    if (matcher.hasData()) {
      matcher.runMatch();
      refresh();
    }

    if (!hasEverListed) {
      if (guideStep === 'aide' && depot.isReady()) setGuideStep('list');
    }

    applySupplierUi();
  }
});

const matcher = createMatcher({
  getDepotAgg: () => depot.agg,
  isDepotReady: () => depot.isReady()
});

const renderer = createRenderer({ ui });

/* ✅ REVİZE:
   Depo karşılaştırması için T-Soft CSV’deki TÜM "Tedarikçi Ürün Kodu" (sup) setini (marka bazlı) kur */
function rebuildTsoftSupByBrandAll() {
  TSOFT_SUP_BY_BRAND = new Map();

  const L2 = Array.isArray(TSOFT_L2) ? TSOFT_L2 : [];
  const C2 = TSOFT_C2 || null;

  if (!L2.length || !C2?.sup || !C2?.marka) return;

  for (const r of L2) {
    const br = normBrand(r[C2.marka] || '');
    const sup = T(r[C2.sup] || '');
    if (!br || !sup) continue;

    if (!TSOFT_SUP_BY_BRAND.has(br)) TSOFT_SUP_BY_BRAND.set(br, new Set());
    const set = TSOFT_SUP_BY_BRAND.get(br);

    const k = codeNorm(sup);
    if (k) set.add(k);
    const a = codeAlt(k);
    if (a && a !== k) set.add(a);
  }
}

/* ✅ Eşleşmeyenler tablosu:
   aynı MARKA içinde (Compel / T-Soft / Depo) sütunlarını satır satır "zip"le */
function buildUnifiedUnmatched({ Uc, Ut, Ud }) {
  const g = new Map(); // brNorm -> { brandDisp, c:[], t:[], d:[] }

  const getGrp = (brNorm, brandDisp) => {
    const k = String(brNorm || '').trim();
    if (!k) return null;
    if (!g.has(k)) g.set(k, { brNorm: k, brandDisp: brandDisp || k, c: [], t: [], d: [] });
    const grp = g.get(k);
    if (brandDisp && (!grp.brandDisp || grp.brandDisp === grp.brNorm)) grp.brandDisp = brandDisp;
    return grp;
  };

  // 1) Compel unmatched
  for (const r of (Uc || [])) {
    const bDisp = String(r["Marka"] || '').trim();
    const bNorm = normBrand(bDisp || r._bn || '');
    const grp = getGrp(bNorm, bDisp);
    if (!grp) continue;
    const nm = String(r["Ürün Adı (Compel)"] || '').trim();
    if (!nm) continue;
    grp.c.push({
      name: nm,
      link: r._clink || ''
    });
  }

  // 2) T-Soft unmatched
  for (const r of (Ut || [])) {
    const bDisp = String(r["Marka"] || '').trim();
    const bNorm = normBrand(r._bn || bDisp || '');
    const grp = getGrp(bNorm, bDisp);
    if (!grp) continue;
    const nm = String(r["T-Soft Ürün Adı"] || '').trim();
    if (!nm) continue;
    grp.t.push({
      name: nm,
      link: r._seo || ''
    });
  }

  // 3) Depo unmatched
  for (const r of (Ud || [])) {
    const bDisp = String(r["Marka"] || '').trim();
    const bNorm = normBrand(r._bn || bDisp || '');
    const grp = getGrp(bNorm, bDisp);
    if (!grp) continue;
    const nm = String(r["Depo Ürün Adı"] || '').trim();
    if (!nm) continue;
    grp.d.push({ name: nm });
  }

  // Sort brands (alphabetic) + each list
  const brandArr = [...g.values()].sort((a, b) =>
    String(a.brandDisp || '').localeCompare(String(b.brandDisp || ''), 'tr', { sensitivity: 'base' })
  );

  for (const grp of brandArr) {
    grp.c.sort((a, b) => String(a.name).localeCompare(String(b.name), 'tr', { sensitivity: 'base' }));
    grp.t.sort((a, b) => String(a.name).localeCompare(String(b.name), 'tr', { sensitivity: 'base' }));
    grp.d.sort((a, b) => String(a.name).localeCompare(String(b.name), 'tr', { sensitivity: 'base' }));
  }

  // Zip rows
  const out = [];
  for (const grp of brandArr) {
    const n = Math.max(grp.c.length, grp.t.length, grp.d.length);
    for (let i = 0; i < n; i++) {
      const c = grp.c[i] || null;
      const t = grp.t[i] || null;
      const d = grp.d[i] || null;

      out.push({
        "Sıra": "", // aşağıda 1..N doldurulacak
        "Marka": grp.brandDisp || grp.brNorm,
        "Compel Ürün Adı": c ? c.name : "",
        "T-Soft Ürün Adı": t ? t.name : "",
        "Depo Ürün Adı": d ? d.name : "",
        _clink: c?.link || "",
        _seo: t?.link || ""
      });
    }
  }

  // Sıra 1..N
  for (let i = 0; i < out.length; i++) out[i]["Sıra"] = String(i + 1);
  return out;
}

function refresh() {
  rebuildTsoftSupByBrandAll();

  const { R, U, UT } = matcher.getResults();

  const Ud = depot.isReady()
    ? depot.unmatchedRows({
        brandsNormSet: COMPEL_BRANDS_NORM,
        // ✅ revize: T-Soft CSV’deki TÜM sup seti ile kıyasla
        tsoftSupByBrand: TSOFT_SUP_BY_BRAND
      })
    : [];

  const Ux = buildUnifiedUnmatched({ Uc: U, Ut: UT, Ud });

  renderer.render(R, Ux, depot.isReady());
  applySupplierUi();
}

/* =========================
   T-Soft file label
   ========================= */
const bind = (inId, outId, empty) => {
  const inp = $(inId), out = $(outId); if (!inp || !out) return;
  const upd = () => {
    const f = inp.files?.[0];
    if (!f) { out.textContent = empty; out.title = empty; }
    else { out.textContent = 'Seçildi'; out.title = f.name; }

    if (!hasEverListed) {
      if (SELECTED.size === 0) setGuideStep('brand');
      else if (!f) setGuideStep('tsoft');
      else if (guideStep === 'tsoft') setGuideStep('aide');
      else if (guideStep === 'brand') setGuideStep('tsoft');
    }

    applySupplierUi();
  };
  inp.addEventListener('change', upd); upd();
};
bind('f2', 'n2', 'Yükle');

/* =========================
   Scan state
   ========================= */
let abortCtrl = null;
const goBtn = $('go');

const setScanState = (on) => {
  if (goBtn) goBtn.disabled = on;
  $('f2') && ($('f2').disabled = on);
  $('depoBtn') && ($('depoBtn').disabled = on);
};

/* =========================
   Generate (Listele)
   ========================= */
async function generate() {
  const file = $('f2')?.files?.[0];
  if (!file) { alert('Lütfen T-Soft Stok CSV seç.'); return false; }

  setStatus('Okunuyor…', 'unk');
  setChip('l1Chip', 'Compel:—');
  setChip('l2Chip', 'T-Soft:—');

  abortCtrl = new AbortController();
  setScanState(true);

  try {
    clearOnlyLists();
    matcher.resetAll();

    // reset maps/sets
    TSOFT_SUP_BY_BRAND = new Map();
    TSOFT_L2 = [];
    TSOFT_C2 = null;
    COMPEL_BRANDS_NORM = new Set();

    const selectedBrands = BRANDS.filter(x => SELECTED.has(x.id));

    if (selectedBrands.length === BRANDS.length) {
      const ok = confirm('Tüm markaları taramak üzeresiniz. Emin misiniz?');
      if (!ok) throw new Error('İptal edildi.');
    }

    const t2Promise = readFileText(file);

    let seq = 0;
    const chosen = selectedBrands.map(b => ({ id: b.id, slug: b.slug, name: b.name, count: b.count }));

    const scanPromise = (async () => {
      const rows = [];
      await scanCompel(API_BASE, chosen, {
        signal: abortCtrl.signal,
        onMessage: (m) => {
          if (!m) return;

          if (m.type === 'brandStart' || m.type === 'page') {
            setStatus(`Taranıyor: ${m.brand || ''} (${m.page || 0}/${m.pages || 0})`, 'unk');
          } else if (m.type === 'product') {
            const p = m.data || {};
            seq++;
            rows.push({
              "Sıra No": String(seq),
              "Marka": String(p.brand || ''),
              "Ürün Adı": String(p.title || 'Ürün'),
              "Ürün Kodu": String(p.productCode || ''),
              "Stok": String(p.stock || ''),
              "EAN": String(p.ean || ''),
              "Link": String(p.url || '')
            });

            if (seq % 250 === 0) setChip('l1Chip', `Compel:${rows.length}`);
          }
        }
      });
      return rows;
    })();

    const [t2txt, L1] = await Promise.all([t2Promise, scanPromise]);
    setChip('l1Chip', `Compel:${L1.length}`);

    const p2 = parseDelimited(t2txt);
    if (!p2.rows.length) { alert('T-Soft CSV boş görünüyor.'); return false; }

    const s2 = p2.rows[0];

    const C1 = {
      siraNo: "Sıra No",
      marka: "Marka",
      urunAdi: "Ürün Adı",
      urunKodu: "Ürün Kodu",
      stok: "Stok",
      ean: "EAN",
      link: "Link"
    };

    const C2 = {
      ws: pickColumn(s2, ['Web Servis Kodu', 'WebServis Kodu', 'WebServisKodu']),
      urunAdi: pickColumn(s2, ['Ürün Adı', 'Urun Adi', 'Ürün Adi']),
      sup: pickColumn(s2, ['Tedarikçi Ürün Kodu', 'Tedarikci Urun Kodu', 'Tedarikçi Urun Kodu']),
      barkod: pickColumn(s2, ['Barkod', 'BARKOD']),
      stok: pickColumn(s2, ['Stok']),
      marka: pickColumn(s2, ['Marka']),
      seo: pickColumn(s2, ['SEO Link', 'Seo Link', 'SEO', 'Seo'])
    };

    const miss = ['ws','sup','barkod','stok','marka','urunAdi','seo'].filter(k => !C2[k]);
    if (miss.length) {
      setStatus('Sütun eksik', 'bad');
      console.warn('L2 missing', miss);
      alert('T-Soft CSV sütunları eksik. Konsola bak.');
      return false;
    }

    const L2all = p2.rows;

    // ✅ Compel markaları (normalize set)
    COMPEL_BRANDS_NORM = new Set(L1.map(r => normBrand(r[C1.marka] || '')).filter(Boolean));

    // ✅ L2: sadece Compel markalarıyla eşleşen markalar
    const L2 = L2all.filter(r => COMPEL_BRANDS_NORM.has(normBrand(r[C2.marka] || '')));

    // ✅ Depo filtresi için: T-Soft’un (marka bazlı) TÜM sup kodları
    TSOFT_L2 = L2;
    TSOFT_C2 = C2;

    matcher.loadData({ l1: L1, c1: C1, l2: L2, c2: C2, l2All: L2all });
    matcher.runMatch();
    refresh();

    setStatus('Hazır', 'ok');
    setChip('l2Chip', `T-Soft:${L2.length}/${L2all.length}`);

    lockListTitleFromCurrentSelection();
    setListTitleVisible(true);

    return true;
  } catch (e) {
    console.error(e);
    setStatus(String(e?.message || 'Hata (konsol)'), 'bad');
    alert(e?.message || String(e));
    return false;
  } finally {
    abortCtrl = null;
    setScanState(false);
    applySupplierUi();
  }
}

/* =========================
   CSV output
   ========================= */
$('dl1')?.addEventListener('click', () => {
  const { R } = matcher.getResults();
  const clean = (R || []).map(r => Object.fromEntries(COLS.map(c => [c, r[c]])));
  downloadBlob('sonuc-eslestirme.csv', new Blob([toCSV(clean, COLS)], { type: 'text/csv;charset=utf-8' }));
});

/* =========================
   Tam reset
   ========================= */
function resetAll() {
  try { abortCtrl?.abort?.(); } catch {}
  abortCtrl = null;
  setScanState(false);

  hasEverListed = false;
  setGoMode('list');

  lastListedTitle = '';
  setListTitleVisible(false);

  SELECTED.clear();
  renderBrands();

  const f2 = $('f2');
  if (f2) f2.value = '';
  const n2 = $('n2');
  if (n2) { n2.textContent = 'Yükle'; n2.title = 'Yükle'; }

  const wsDl = $('wsCodes'), supDl = $('supCodes');
  if (wsDl) wsDl.innerHTML = '';
  if (supDl) supDl.innerHTML = '';

  TSOFT_SUP_BY_BRAND = new Map();
  TSOFT_L2 = [];
  TSOFT_C2 = null;

  COMPEL_BRANDS_NORM = new Set();

  depot.reset();
  matcher.resetAll();

  clearOnlyLists();

  setChip('l1Chip', 'Compel:-');
  setChip('l2Chip', 'T-Soft:-');
  setChip('l4Chip', 'Aide:-');
  setChip('sum', '✓0 • ✕0', 'muted');

  setGuideStep('brand');
  applySupplierUi();
}

/* =========================
   Listele / Temizle davranışı
   ========================= */
async function handleGo() {
  if (ACTIVE_SUPPLIER === SUPPLIERS.AKALIN) { applySupplierUi(); return; }

  if (goMode === 'clear') {
    resetAll();
    return;
  }

  if (!hasEverListed && guideStep === 'list') setGuideStep('done');

  if (!hasEverListed && !SELECTED.size) {
    alert('Lütfen bir marka seçin');
    return;
  }

  const file = $('f2')?.files?.[0];
  if (!file) {
    alert('Lütfen T-Soft Stok CSV seç.');
    return;
  }

  if (!SELECTED.size) {
    clearOnlyLists();
    setGoMode('clear');
    return;
  }

  const ok = await generate();
  if (ok) {
    hasEverListed = true;
    setGoMode('list');
    setGuideStep('done');
  }
}

if (goBtn) goBtn.onclick = handleGo;

/* =========================
   İlk yük
   ========================= */
ensureListHeader();
setGoMode('list');
setGuideStep('brand');
initBrands();
applySupplierUi();
Bu iki dosyayı bu şekilde güncellediğinde, “Depo Ürün Adı” tam olarak tarif ettiğin kurala göre (marka eşleşmesi + T-Soft sup’ta hiç yok) Aide Model isimlerini listeler.


Şunu dedin:
çalışmamasnın sebepleri ne olabilir listeler misini kısaca çok uzun yazma

ChatGPT:

49s boyunca düşündüm
Kısaca “çalışmıyor” gibi görünmesinin en yaygın sebepleri şunlar:

Depo verisi hiç yüklenmemiş / parse edilememiştir (Aide yapıştırması tab’lı değilse veya sütunlar bulunamazsa).

Aide’de Marka “- / — / N/A / boş” olan satırlar bilerek ignore ediliyor → örneğindeki ilk 2 ürün bu yüzden listelenmez.

Compel’de seçtiğin marka ile Aide’deki marka yazımı normalize olamıyordur (yazım farkı/alias yoksa) → marka eşleşmez, hiç gelmez.

T-Soft CSV’de “Tedarikçi Ürün Kodu (sup)” sütunu boş/yanlış sütun okunuyor → sup seti yanlış oluşur, filtre doğru çalışmaz.

Stok Kodu ↔ sup aynı değil (boşluk, farklı format, farklı karakter, alfanumerik baştaki 0’lar vs.). Not: “0 kırpma” sadece tamamen sayısal kodlarda devreye girer.

Sayfada eski JS cache’i kalmıştır (hard refresh yapmadan yeni kod çalışmaz).

Console’da bir runtime hata vardır (değişiklik sonrası bir isim/variable kaçtıysa) → fonksiyonlar hiç çalışmaz.

İstersen “ABLETON Live V12…” neden gelmiyor diye bakacaksak: önce Aide’de marka ABLETON, Compel’de seçili marka tarafında bunun tam aynı normalize hali var mı + T-Soft’ta sup’larda ABL0021 geçiyor mu kontrol etmek yeter.


Şunu dedin:
bu taramayı yapan belgenin içine bi logcu koysak bize hangi aşamada olduğunu tespit edemez mi ben de sana söylerim çözeriz ?

ChatGPT:

1m 17s boyunca düşündüm
Evet, koyarsak hangi aşamada kırıldığını çok net görürüz. Console’a ek olarak sayfanın altına küçük bir debug panel de basarız; sen de bana son satırları atarsın.

Aşağıdaki 2 dosyaya küçük ekleme yeter:

1) js/app.js (debug logger ekle)
const API_BASE = ... satırının hemen altına şunu yapıştır:

// ✅ Debug logger (URL'ye ?debug=1 ekleyince çalışır)
const DEBUG = /(?:\?|&)debug(?:=1|=true|&|$)/i.test(location.search);

const TDLOG = (() => {
  if (!DEBUG) return (msg, data) => console.log('[TDG]', msg, data ?? '');

  const box = document.createElement('div');
  box.id = 'tdgLog';
  box.style.cssText = `
    position:fixed; left:10px; right:10px; bottom:10px; z-index:9999;
    max-height:30vh; overflow:auto; padding:8px 10px;
    border:1px solid #2a3140; border-radius:12px; background:rgba(15,19,32,.92);
    font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    color:#eaeef7; box-shadow:0 12px 40px rgba(0,0,0,.55);
  `;
  const head = document.createElement('div');
  head.textContent = 'TDG DEBUG (kapatmak için URL’den ?debug=1 kaldır)';
  head.style.cssText = 'font-weight:800; opacity:.9; margin-bottom:6px;';
  box.appendChild(head);

  const pre = document.createElement('pre');
  pre.style.cssText = 'margin:0; white-space:pre-wrap;';
  box.appendChild(pre);

  document.addEventListener('DOMContentLoaded', () => document.body.appendChild(box));

  const safe = (x) => {
    try { return JSON.stringify(x); } catch { return String(x); }
  };

  return (msg, data) => {
    const ts = new Date().toLocaleTimeString('tr-TR');
    const line = `[${ts}] ${msg}` + (data !== undefined ? `  ${safe(data)}` : '');
    pre.textContent = (pre.textContent + line + '\n').slice(-8000);
    box.scrollTop = box.scrollHeight;
    console.log('%c[TDG]', 'color:#93c5fd', msg, data ?? '');
  };
})();

window.__TDLOG = TDLOG;
TDLOG('app:boot', { debug: DEBUG });
Sonra aşağıdaki log çağrılarını bu fonksiyonların içine ekle:

generate() başına (ilk satırlara)
TDLOG('generate:start', {
  supplier: ACTIVE_SUPPLIER,
  selectedBrands: SELECTED.size
});
T-Soft CSV parse edip C2’yi kurduktan sonra (miss kontrolünden önce/sonra)
TDLOG('tsoft:columns', { C2, miss });
L2all ve L2 hazır olunca
TDLOG('tsoft:rows', { L2: L2.length, L2all: L2all.length });
Compel marka seti oluşunca
TDLOG('compel:brandsNorm', { size: COMPEL_BRANDS_NORM.size });
refresh() içine en başa
TDLOG('refresh:begin');
renderer.render(...) çağırmadan hemen önce
TDLOG('refresh:counts', { R: R?.length, U: U?.length, UT: UT?.length, Ud: Ud?.length });
Kullanım: Sayfayı ...?debug=1 ile aç → Listele → panelde en son nerede kaldığını görürsün.

2) js/depot.js (depo tarafına log)
loadDepotFromText(text) fonksiyonunun en sonunda, depotReady = true; sonrasına şunu ekle:

window.__TDLOG?.('depo:loaded', {
  rows: L4.length,
  C4,
  brandsIndexed: idxBR.size
});
Ve unmatchedRows(...) fonksiyonunun başına (depoReady kontrolünden hemen sonra) küçük sayaç ekleyip en sona log bas:

let skippedBrand = 0, skippedHit = 0, pushed = 0;
Döngüde:

if (bnSet && !bnSet.has(brNorm)) { skippedBrand++; continue; }

if (hit) { skippedHit++; continue; }

out.push(...) sonrasında pushed++

Fonksiyon bitmeden önce:

window.__TDLOG?.('depo:unmatchedRows', {
  out: out.length,
  pushed,
  skippedBrand,
  skippedHit,
  bnSet: bnSet ? bnSet.size : null
});
Sonraki adım
Sen ?debug=1 ile çalıştırıp paneldeki son 10 satırı buraya yapıştır; ben direkt hangi adımda neden bozulduğunu nokta atışı söylerim.


Şunu dedin:
ben coder değilim. kdoun içinde düzenleme yapamıyorum

ChatGPT:

1m 19s boyunca düşündüm
Anladım. Kod düzenleyemiyorsan yine de log gibi teşhis yapabiliriz; en pratik yol UI üzerinden ve birkaç “kontrol”le nerede takıldığını bulmak.

Kod yazmadan en hızlı teşhis (3 kontrol)
Aide’de “Marka” değeri “- / boş / N/A” ise o satır zaten tamamen yok sayılıyor.
Senin örneğinde ilk 2 satır bu yüzden asla listelenmez (Marka = “-”).

Seçili marka gerçekten Compel taramasına girmiş mi?
Yani Compel’den o markaya ait ürün gelmediyse, Aide’de o markayı eşleştirecek “marka seti” oluşmaz → depo eşleşmeyenler de çıkmaz.

Aide “Stok Kodu”, T-Soft CSV’de “Tedarikçi Ürün Kodu (sup)” içinde geçiyorsa listelenmez.
Örn: Aide’de ABL0021 varsa, T-Soft CSV’de “Tedarikçi Ürün Kodu” sütununda ABL0021 arat. Varsa, “Depo Ürün Adı”na düşmez.

Kodsuz “test” yöntemi (1 dakikalık)
Aide yapıştırma kutusunda Marka’sı “-” olan satırların başındaki - yerine gerçek marka yaz (örn. ABLETON) ve tekrar “Yükle”.

Aynı satırın Stok Kodu’nu geçici olarak TEST123 gibi T-Soft’ta olmayacak bir şey yap → listede görünüyorsa sorun sup eşleşmesi demektir.

Bana yazarsan hemen nokta atışı söylerim
Seçtiğin marka ne?

Aide’de listelenmesini beklediğin satırın Marka ve Stok Kodu değeri ne?

T-Soft CSV’de o Stok Kodu “Tedarikçi Ürün Kodu” sütununda var mı? (evet/hayır)

İstersen sadece bu 3 cevabı ver, ben direkt “neden çıkmıyor”u söylerim.


Şunu dedin:
YAPTIM Bulamadı

ChatGPT:

Düşünme durduruldu

Şunu dedin:
bak şimdi kodu çok şişirmemek için bana içine csv yüklenen bir kutu olan ve aide yapıştırma kutusu olan basic bi html kodu yarat bunun içinde bunların eşleştirme mantığını çalışıp merkez koda gömeriz olur mu

ChatGPT:

30s boyunca düşündüm
Olur. Aşağıdaki tek dosyalık (tek HTML) “mini debug” sayfası var:

T-Soft products.csv: dosya seçiyorsun (CSV/TSV fark etmez)

Aide: tabloyu kopyalayıp yapıştırıyorsun

(İsteğe bağlı) Marka filtresi: örn ABLETON ya da Arturia, Ableton

“Çalıştır” deyince: Aide’deki Stok Kodu, T-Soft’taki Tedarikçi Ürün Kodu (sup) içinde yoksa, o satırın Model’i “Depo Ürün Adı” listesine düşer.

Ayrıca küçük bir log ve “bulunan markalar” alanı var; marka eşleşmiyor mu hemen görürsün.

Kaydet: debug.html → çift tıkla aç → T-Soft dosyasını seç → Aide’yi yapıştır → Çalıştır



Senin örneğine özel önemli not
Örneğinde ilk iki satırın markası - olduğu için (gerçek marka yok), bu araçta da ana kodundaki gibi markası “-” olan satırlar yok sayılır. Eğer bu satırların dahil olmasını istiyorsan, onların “Marka” hücresine gerçek marka yazman gerekir.

İstersen burada çıktının ekran görüntüsünü (özellikle “Bulunan Markalar” kısmını) at; marka eşleşmiyor mu, sup seti mi boş, hemen nokta atışı söylerim.


Şunu dedin:
[20:15:35] start
[20:15:35] tsoft:meta  {"rows":9856,"ok":true,"miss":[],"C2":{"marka":"Marka","sup":"Tedarikçi Ürün Kodu"},"brands":195}
[20:15:35] aide:parse  {"mode":"noisy","rows":2901,"C":{"stokKodu":"Stok Kodu","marka":"Marka","model":"Model"}}
[20:15:35] done  {"scanned":0,"matched":0,"unmatched":0,"skippedBadBrand":2,"skippedBrandFilter":2899}

ChatGPT:

1m 15s boyunca düşündüm
Logun çok net söylüyor:

scanned: 0

skippedBrandFilter: 2899

Yani hiç satır “marka filtresinden” geçememiş. Bu yüzden sonuç da 0.

Bunun en olası sebepleri (kısaca):

Marka filtresi kutusuna ABLETON dışında ekstra karakter girmiş (örn. ABLETON;, ABLETON sorun değil ama ;/:/parantez vs. sorun).

Marka filtresini virgül yerine noktalı virgül ile ayırdın (benim mini sayfa sadece , ile ayırıyor).

Filtreye “Ableton markası” gibi kelime ekledin (eşleşme “tam marka” bekliyor).

Ne yap:

Marka filtresi kutusunu tamamen boş bırak (Ctrl+A → Delete) ve tekrar Çalıştır.
Bu sefer logda scanned 0 olmayacak.

Filtre kullanacaksan kutuya sadece şu formatta yaz:
ABLETON veya ARTURIA, ABLETON (virgül ile, başka karakter yok)

Not: skippedBadBrand: 2 demek, Aide’de markası - olan 2 satır zaten bilerek yok sayıldı (ana kodundaki gibi).

Boş filtreyle tekrar çalıştırıp çıkan yeni logu atarsan, bu kez “sup eşleşmesi mi / marka normalize mı” kısmını da net çözeriz.


Şunu dedin:
Arturia diye aratmıştım ben şimdi "ABLETON" aratınca "[20:19:33] start
[20:19:33] tsoft:meta  {"rows":9856,"ok":true,"miss":[],"C2":{"marka":"Marka","sup":"Tedarikçi Ürün Kodu"},"brands":195}
[20:19:33] aide:parse  {"mode":"noisy","rows":2901,"C":{"stokKodu":"Stok Kodu","marka":"Marka","model":"Model"}}
[20:19:33] done  {"scanned":1,"matched":0,"unmatched":1,"skippedBadBrand":2,"skippedBrandFilter":2898}" böyle sonuç verdi buradan ne anlıyoruz ?

ChatGPT:
Şunu anlıyoruz (net):

Aide verinde ABLETON markalı sadece 1 satır doğru yakalanmış → scanned: 1

Bu satırın Stok Kodu (muhtemelen ABL0021), T-Soft CSV’deki “Tedarikçi Ürün Kodu” sütununda yok → matched: 0, unmatched: 1

Yani senin istediğin kurala göre bu ürün listelenmeli (Depo Ürün Adı = Aide “Model”: Live V12 Standart (89152))

Ek bilgi:

skippedBadBrand: 2 → markası - olan iki satır zaten bilerek atlanmış.

skippedBrandFilter: 2898 → diğer tüm satırlar ABLETON olmadığı için filtreyle elenmiş.

Eğer ana projende aynı ürün yine de görünmüyorsa, sorun büyük ihtimalle şunlardan biri:

Marka normalize uyuşmuyor (T-Soft’ta marka “Ableton” farklı yazılıyorsa),

Ana kodda depo tarafına gönderdiğin tsoftSupByBrand seti yanlış/boş oluşuyor,

Aide tarafında o satırın markası projede “-” gibi okunuyor (noisy parse farkı).

İstersen bu mini sayfada çıkan tabloda satırın Marka + Stok Kodu değerini aynen yaz, ben ana projede hangi noktayı düzeltmen gerektiğini tek cümleyle söyleyeyim.


Şunu dedin:
mini sayfada çıkan tabloda satırın Marka + Stok Kodu değeri nerede ?

ChatGPT:
Mini sayfada en alttaki sonuç tablosunda görünüyor:

2. sütun: Marka

en sağdaki (4.) sütun: Stok Kodu

Yani “Depo Ürün Adı (Model) – sonucu” başlığının altındaki tabloda, çıkan satırın Marka + Stok Kodu değerleri aynı satırda bu iki sütunda yazıyor.

Bulamazsan:

“Çalıştır”a bastıktan sonra sayfayı biraz aşağı kaydır.

Tablo satırını gördüğünde Marka hücresi ve Stok Kodu hücresini işaretleyip kopyalayabilirsin.


Şunu dedin:
bu olabilir mi "Sıra	Marka	Depo Ürün Adı (Model)	Stok Kodu
1	ABLETON	Live V12 Standart (89152)	ABL0021"

ChatGPT:

33s boyunca düşündüm
Evet, tam olarak bu satır:

Marka: ABLETON

Stok Kodu: ABL0021

Model (Depo Ürün Adı): Live V12 Standart (89152)

Bu sonuç şunu gösteriyor: Aide’de ABLETON / ABL0021 var ama T-Soft CSV’de “Tedarikçi Ürün Kodu” sütununda ABLETON markası altında ABL0021 yok → bu yüzden “Depo Ürün Adı” listesine girmesi gereken bir kayıt.

Ana projende görünmüyorsa en büyük ihtimal:

Sen listeyi Arturia için oluşturuyorsun; ana kod sadece Compel taramasında çıkan/seçilen markaları depo tarafında gösteriyor.
Yani Arturia seçiliyken ABLETON satırı bilerek filtrelenir ve görünmez.

Ayrıca örneğindeki Marka = "-" olan satırlar da (senin sistemde) yok sayıldığı için yine listelenmez.


Şunu dedin:
ben anlamadım ya

ChatGPT:

33s boyunca düşündüm
Şöyle düşün:

Mini sayfada olan ne?
Senin yapıştırdığın Aide örneğinde gerçek marka olarak sadece 1 satır var:

ABLETON / ABL0021 / Live V12 Standart (89152)

Diğer 2 satırın markası “-” olduğu için (bizim mantıkta) yok sayılıyor.

Bu yüzden:

Arturia yazınca → Aide içinde ARTURIA markalı satır yok → scanned:0 çıkıyor.

ABLETON yazınca → o tek satırı yakalıyor → scanned:1 çıkıyor.

Peki ana projede neden görmüyorsun?
Ana projede “Depo Ürün Adı” listesi seçtiğin/Compel’den gelen marka(lar)a göre filtreleniyor.

Yani sen Arturia seçip liste aldığında:

Sistem sadece Aide’de “Marka = ARTURIA” olan satırlara bakar.

Senin Aide örneğinde ARTURIA olmadığı için doğal olarak boş kalır.

ABLETON satırı Arturia listesinde görünmez (bu normal).

Ne yapman lazım?
Bu satırı görmek istiyorsan: Compel’de ABLETON’u seçip Listele (veya marka filtresini ABLETON yap).

Arturia için sonuç istiyorsan: Aide’de ilgili satırların Marka hücresine ARTURIA yazılı olmalı ( “-” olanlar da dahil).


Şunu dedin:
onu anladım canım ya. genel anlamda sorunu tespit edebildik mi yani 

ChatGPT:
Evet, genel sorunu tespit ettik:

Sen Arturia için “Depo Ürün Adı” bekliyordun ama Aide verinde (yapıştırdığın örnekte) Arturia markalı satır yok.

Aide’deki bazı satırlar Marka = “-” olduğu için sistem onları bilerek yok sayıyor (o yüzden “markası belli olmayan” ürünler hiçbir listede çıkmıyor).

Mini testte de bu netleşti: Arturia filtresinde scanned=0, Ableton filtresinde scanned=1.

Yani problem “eşleştirme algoritması bozuk” değil; problem girdi verisi / marka alanı:
Aide tarafında marka doğru dolu değilse (veya Arturia yoksa) listede bir şey çıkmaz.

İstersen bir sonraki adım olarak şunu da netleştirebiliriz:

Gerçek Aide datasında ARTURIA markalı satır var mı yok mu? (mini sayfada marka filtresini boş bırakınca “Bulunan Markalar” kısmında Arturia görünüyor mu?)


Şunu dedin:
benim aide veri örneğim toplam satırların %5'i bile değil bir sürü markalar var içinde "ARTURIA" da var

ChatGPT:

Düşünme durduruldu

Şunu dedin:
ben kararımı verdim bunu 2 aşamaya bölücez. 1.aşama burayaide kodunu yapıştır olcak yapıştırınca csvye dönüştürüp çok küçük bi kutucukta çok küçük fontlarla csv ızgarasındaki datayı biraz göstericek ve sonrasında yükle olucak eğer csv ye dönüştüremezse yüklenme butonu aktif olmicak.
bunun için küçük bir html yaz ve içinden compel marka dataları workerdan gelsin. kodu sadece işimizi görecek kadar basit tut log ekranı vs hiç birşey ekleme markalar gelsin workerdan en basit haliyle seçilebilir durumda yanında tsoft csv yükleme yanında aide yapıştırma yanında csv dönüştürme ve sonuçta istediğimiz liste sütunu  ennn basit haliyle komple bir html oluştur tek başına çalışsın 

ChatGPT:

52s boyunca düşündüm
Aşağıdaki tek dosyalık HTML’i kaydet (mini.html) ve aç.
İçinde:

Worker’dan Compel markaları gelir (checkbox ile seçilir)

T-Soft CSV yüklenir

Aide yapıştır → otomatik CSV’ye çevrilir ve küçük grid preview gösterir

Çevrilemezse “Aide Yükle” pasif kalır

Sonuçta en basit haliyle: Seçili marka(lar) için Aide’deki Stok Kodu, T-Soft’ta aynı markanın Tedarikçi Ürün Kodu içinde yoksa → Aide Model “Depo Ürün Adı” listesine düşer.

Not: Aide’de Marka değeri - / — / N/A / boş ise o satırlar yok sayılır.

<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini: T-Soft ↔ Aide</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0d12;color:#eaeef7}
    .wrap{display:flex;gap:12px;padding:12px;flex-wrap:wrap}
    .card{border:1px solid #2a3140;background:#0f1320;border-radius:12px;padding:12px;flex:1 1 360px;min-width:320px}
    h3{margin:0 0 10px;font-size:16px}
    label{display:block;font-weight:800;margin:10px 0 6px}
    input[type="file"], input[type="text"], textarea{
      width:100%;box-sizing:border-box;background:#0b0d12;color:#eaeef7;border:1px solid #2a3140;border-radius:10px;padding:10px
    }
    textarea{min-height:150px;resize:vertical}
    button{
      background:#111827;color:#eaeef7;border:1px solid #2a3140;border-radius:10px;
      padding:9px 12px;font-weight:900;cursor:pointer
    }
    button:disabled{opacity:.55;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .muted{opacity:.85;font-size:12px}
    .ok{color:#86efac}
    .bad{color:#fca5a5}
    .brands{max-height:240px;overflow:auto;border:1px solid #2a3140;border-radius:10px;padding:8px;background:#0b0d12}
    .brandItem{display:flex;gap:8px;align-items:center;padding:4px 2px}
    .brandItem small{opacity:.8}
    .gridWrap{max-height:160px;overflow:auto;border:1px solid #2a3140;border-radius:10px;background:#0b0d12}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2430;padding:4px 6px;text-align:left;font-size:10.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    th{position:sticky;top:0;background:#0f1320;font-size:10.5px}
    .results{max-height:360px}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <h3>1) Compel Markalar (Worker’dan)</h3>
      <div class="row">
        <input id="brandSearch" type="text" placeholder="Marka ara..." />
        <button id="brandClear" type="button">Seçimi Temizle</button>
      </div>
      <div class="muted" id="brandInfo" style="margin:8px 0 8px">Yükleniyor…</div>
      <div class="brands" id="brandList"></div>
    </div>

    <div class="card">
      <h3>2) T-Soft + Aide</h3>

      <label>T-Soft products.csv yükle</label>
      <input id="tsoftFile" type="file" accept=".csv,text/csv,.txt,text/plain" />
      <div class="muted" id="tsoftInfo">—</div>

      <label style="margin-top:14px">Aide verisini yapıştır</label>
      <textarea id="aidePaste" placeholder="Aide stok listesini kopyalayıp buraya yapıştır..."></textarea>

      <div class="row" style="margin-top:10px">
        <button id="aideLoad" type="button" disabled>Aide Yükle</button>
        <span class="muted" id="aideInfo">—</span>
      </div>

      <label style="margin-top:14px">Aide CSV Önizleme (küçük)</label>
      <div class="gridWrap">
        <table id="aidePreview">
          <thead><tr id="aidePrevHead"></tr></thead>
          <tbody id="aidePrevBody"></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:14px">
        <button id="run" type="button" disabled>Sonucu Üret</button>
        <span class="muted" id="runInfo">—</span>
      </div>
    </div>

    <div class="card">
      <h3>3) Sonuç: Depo Ürün Adı</h3>
      <div class="muted" id="outInfo">—</div>
      <div class="gridWrap results" style="margin-top:10px">
        <table id="outTable">
          <thead>
            <tr>
              <th style="width:60px">Sıra</th>
              <th style="width:160px">Marka</th>
              <th>Depo Ürün Adı (Model)</th>
              <th style="width:140px">Stok Kodu</th>
            </tr>
          </thead>
          <tbody id="outBody"></tbody>
        </table>
      </div>
    </div>

  </div>

<script>
(() => {
  const API_BASE = "https://robot-workstation.tvkapora.workers.dev";
  const TR = "tr-TR";
  const $ = (id) => document.getElementById(id);

  const T = (s) => (s ?? "").toString().trim();
  const bNorm = (s) => (s ?? "").toString().replace(/\u00A0/g," ").trim().toLocaleUpperCase(TR).replace(/\s+/g," ");
  const isBadBrand = (raw) => {
    const s = T(raw);
    return !s || s === "-" || s === "—" || s.toLocaleUpperCase(TR) === "N/A";
  };

  const codeNorm = (s) => (s ?? "").toString().replace(/\u00A0/g," ").trim().replace(/\s+/g," ").toLocaleUpperCase(TR);
  const codeAlt = (n) => {
    const k = codeNorm(n);
    if (!k) return "";
    if (!/^[0-9]+$/.test(k)) return "";
    return k.replace(/^0+(?=\d)/, "");
  };

  function detectDelimiter(h){
    const c = ["\t",";",",","|"];
    let best = c[0], m = -1;
    for (const d of c){
      const k = h.split(d).length - 1;
      if (k > m){ m = k; best = d; }
    }
    return best;
  }

  function parseDelimited(text){
    const lines = (text ?? "").toString().replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n");
    const first = lines.find(x => x.trim()) || "";
    const delim = detectDelimiter(first);

    const split = (line) => {
      const out=[]; let cur="", q=false;
      for (let i=0;i<line.length;i++){
        const ch=line[i];
        if (ch === '"'){
          if (q && line[i+1] === '"'){ cur+='"'; i++; }
          else q = !q;
        } else if (!q && ch === delim){
          out.push(cur); cur="";
        } else cur += ch;
      }
      out.push(cur);
      return out.map(v => v.trim());
    };

    let hdr=null, rows=[];
    for (const line of lines){
      if (!line || !line.trim()) continue;
      if (!hdr){ hdr = split(line); continue; }
      const vals = split(line), obj = {};
      for (let i=0;i<hdr.length;i++) obj[hdr[i]] = vals[i] ?? "";
      rows.push(obj);
    }
    return { hdr: hdr || [], rows };
  }

  const normHeader = (h) => (h ?? "").toString().trim().toLocaleUpperCase(TR).replace(/\s+/g," ");
  const pickColumn = (rowObj, wanted) => {
    const map = new Map(Object.keys(rowObj).map(k => [normHeader(k), k]));
    for (const w of wanted){ const k = map.get(normHeader(w)); if (k) return k; }
    return null;
  };

  async function readFileText(file){
    return new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onload = () => res(fr.result);
      fr.onerror = () => rej(fr.error);
      fr.readAsText(file, "UTF-8");
    });
  }

  // Aide noisy paste (senin formatına uygun)
  function depotFromNoisyPaste(text){
    const FirmaDefault = "Sescibaba";
    const N = s => !s || /^(Tümü|Sesçibaba Logo|Şirketler|Siparişler|Onay Bekleyen|Sipariş Listesi|İade Listesi|Sesçibaba Stokları|Stok Listesi|Ara|Previous|Next|E-Commerce Management.*|Showing\b.*|Marka\s+Model\s+Stok\s+Kodu.*|\d+)$/.test(s);

    const out=[];
    const lines = (text || "").split(/\r\n|\r|\n/);

    for (let l of lines){
      l = (l || "").replace(/\u00A0/g," ").trim();
      if (N(l)) continue;
      if (!l.includes("\t")) continue;

      const a = l.split("\t").map(x => x.trim()).filter(x => x !== "");
      if (a.length < 6) continue;

      let m="", mo="", k="", ac="", s="", w="", f=FirmaDefault;

      if (a.length === 6){
        m=a[0]; mo=a[1]; k=a[2]; ac=a[3]; s=a[4]; w=a[5];
      } else {
        m = a[0];
        f = a.at(-1) || FirmaDefault;
        w = a.at(-2) || "";
        s = a.at(-3) || "";
        const mid = a.slice(1, -3);
        if (mid.length < 3) continue;
        mo = mid.slice(0, -2).join(" ");
        k = mid.at(-2) || "";
        ac = mid.at(-1) || "";
      }

      if (!k || !mo) continue;

      out.push({
        "Marka": m,
        "Model": mo,
        "Stok Kodu": k,
        "Açıklama": ac,
        "Stok": s,
        "Ambar": w,
        "Firma": f
      });
    }
    return out;
  }

  function parseAide(text){
    const raw = (text ?? "").toString();
    if (!raw.trim()) return { ok:false, rows:[], C:null, mode:"empty" };

    // 1) delimited dene
    try{
      const p = parseDelimited(raw);
      if (p.rows?.length){
        const s = p.rows[0];
        const stokKodu = pickColumn(s, ["Stok Kodu","STOK KODU","Stock Code","StokKodu"]);
        const marka = pickColumn(s, ["Marka","MARKA","Brand"]);
        const model = pickColumn(s, ["Model","MODEL"]);
        if (stokKodu && marka && model){
          return { ok:true, rows:p.rows, C:{stokKodu, marka, model}, mode:"delimited" };
        }
      }
    } catch {}

    // 2) noisy fallback
    const rows2 = depotFromNoisyPaste(raw);
    if (!rows2.length) return { ok:false, rows:[], C:null, mode:"fail" };
    return { ok:true, rows:rows2, C:{stokKodu:"Stok Kodu", marka:"Marka", model:"Model"}, mode:"noisy" };
  }

  // ---------- UI State ----------
  let BRANDS = [];
  let SELECTED = new Set(); // brand names normalized
  let TSOFT = { ok:false, rows:[], C:null };
  let AIDE = { ok:false, rows:[], C:null, csvRows:[] };

  function updateRunEnabled(){
    const can = (TSOFT.ok && AIDE.ok && SELECTED.size > 0);
    $("run").disabled = !can;
    $("runInfo").textContent = can ? "Hazır" : "T-Soft + Aide + en az 1 marka seç";
  }

  // ---------- Brands ----------
  async function loadBrands(){
    $("brandInfo").textContent = "Yükleniyor…";
    try{
      const res = await fetch(`${API_BASE}/api/brands`, { cache:"no-store" });
      if (!res.ok) throw new Error("brands api " + res.status);
      BRANDS = await res.json();
      renderBrandList();
      $("brandInfo").innerHTML = `<span class="ok">Yüklendi</span> • ${BRANDS.length} marka`;
    } catch (e){
      $("brandInfo").innerHTML = `<span class="bad">Markalar gelmedi</span>`;
      BRANDS = [];
      renderBrandList();
    }
  }

  function renderBrandList(){
    const q = bNorm($("brandSearch").value || "");
    const box = $("brandList");
    box.innerHTML = "";

    const list = (BRANDS || [])
      .filter(b => b?.name)
      .filter(b => !q || bNorm(b.name).includes(q))
      .sort((a,b) => String(a.name).localeCompare(String(b.name), "tr", {sensitivity:"base"}));

    for (const b of list){
      const bn = bNorm(b.name);
      const row = document.createElement("div");
      row.className = "brandItem";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = SELECTED.has(bn);
      cb.addEventListener("change", () => {
        if (cb.checked) SELECTED.add(bn);
        else SELECTED.delete(bn);
        updateRunEnabled();
      });

      const lab = document.createElement("div");
      lab.style.minWidth = "0";
      lab.innerHTML = `<div style="font-weight:800">${b.name}</div>
                       <small>${b.count ?? ""}</small>`;

      row.appendChild(cb);
      row.appendChild(lab);
      box.appendChild(row);
    }

    updateRunEnabled();
  }

  $("brandSearch").addEventListener("input", renderBrandList);
  $("brandClear").addEventListener("click", () => { SELECTED.clear(); renderBrandList(); });

  // ---------- T-Soft ----------
  $("tsoftFile").addEventListener("change", async () => {
    TSOFT = { ok:false, rows:[], C:null };
    $("tsoftInfo").textContent = "—";
    updateRunEnabled();

    const f = $("tsoftFile").files?.[0];
    if (!f) return;

    try{
      const txt = await readFileText(f);
      const p = parseDelimited(txt);
      if (!p.rows?.length) throw new Error("CSV boş");
      const s = p.rows[0];
      const C2 = {
        marka: pickColumn(s, ["Marka","MARKA","Brand"]),
        sup: pickColumn(s, ["Tedarikçi Ürün Kodu","Tedarikci Urun Kodu","Tedarikçi Urun Kodu","Supplier Product Code"])
      };
      if (!C2.marka || !C2.sup) throw new Error("Sütun bulunamadı (Marka / Tedarikçi Ürün Kodu)");

      TSOFT = { ok:true, rows:p.rows, C:C2 };
      $("tsoftInfo").innerHTML = `<span class="ok">Yüklendi</span> • ${p.rows.length} satır`;
    } catch (e){
      $("tsoftInfo").innerHTML = `<span class="bad">Hata:</span> ${String(e.message || e)}`;
    }
    updateRunEnabled();
  });

  // ---------- Aide Convert + Preview ----------
  let aideParsedTmp = null;

  function renderAidePreview(rows, cols){
    const head = $("aidePrevHead");
    const body = $("aidePrevBody");
    head.innerHTML = "";
    body.innerHTML = "";

    for (const c of cols){
      const th = document.createElement("th");
      th.textContent = c;
      head.appendChild(th);
    }

    const show = (rows || []).slice(0, 12);
    for (const r of show){
      const tr = document.createElement("tr");
      for (const c of cols){
        const td = document.createElement("td");
        td.textContent = (r[c] ?? "").toString();
        tr.appendChild(td);
      }
      body.appendChild(tr);
    }
  }

  $("aidePaste").addEventListener("input", () => {
    aideParsedTmp = null;
    $("aideLoad").disabled = true;
    $("aideInfo").textContent = "—";
    renderAidePreview([], ["Marka","Model","Stok Kodu"]);

    const raw = $("aidePaste").value || "";
    const p = parseAide(raw);

    if (!p.ok || !p.rows.length){
      $("aideInfo").innerHTML = `<span class="bad">Dönüştürülemedi</span>`;
      return;
    }

    // Normalize to a simple CSV-like row shape we will use
    const out = [];
    for (const r of p.rows){
      const marka = T(r[p.C.marka] ?? r["Marka"] ?? "");
      const model = T(r[p.C.model] ?? r["Model"] ?? "");
      const stokKodu = T(r[p.C.stokKodu] ?? r["Stok Kodu"] ?? "");
      if (!marka && !model && !stokKodu) continue;
      out.push({ "Marka": marka, "Model": model, "Stok Kodu": stokKodu });
    }

    aideParsedTmp = { rows: out, C: p.C, mode: p.mode };
    $("aideLoad").disabled = false;
    $("aideInfo").innerHTML = `<span class="ok">Dönüştürüldü</span> • ${out.length} satır (${p.mode})`;
    renderAidePreview(out, ["Marka","Model","Stok Kodu"]);
  });

  $("aideLoad").addEventListener("click", () => {
    if (!aideParsedTmp?.rows?.length){
      $("aideLoad").disabled = true;
      return;
    }
    AIDE = { ok:true, rows: aideParsedTmp.rows, C: { marka:"Marka", model:"Model", stokKodu:"Stok Kodu" } };
    $("aideInfo").innerHTML = `<span class="ok">Yüklendi</span> • ${AIDE.rows.length} satır`;
    updateRunEnabled();
  });

  // ---------- Result ----------
  function buildTsoftSupSetsForSelectedBrands(){
    // brandNorm -> Set(supNorm + alt)
    const map = new Map();
    const C = TSOFT.C;
    for (const r of TSOFT.rows){
      const br = bNorm(r[C.marka] || "");
      if (!br || !SELECTED.has(br)) continue;

      const sup = T(r[C.sup] || "");
      if (!sup) continue;

      if (!map.has(br)) map.set(br, new Set());
      const set = map.get(br);
      const k = codeNorm(sup);
      if (k) set.add(k);
      const a = codeAlt(k);
      if (a && a !== k) set.add(a);
    }
    return map;
  }

  $("run").addEventListener("click", () => {
    const outBody = $("outBody");
    outBody.innerHTML = "";

    if (!TSOFT.ok || !AIDE.ok || !SELECTED.size){
      $("outInfo").innerHTML = `<span class="bad">Eksik veri</span>`;
      return;
    }

    const tsoftSupByBrand = buildTsoftSupSetsForSelectedBrands();

    const out = [];
    const seen = new Set(); // brand||model||code
    for (const r of AIDE.rows){
      const brRaw = r["Marka"] ?? "";
      if (isBadBrand(brRaw)) continue;

      const br = bNorm(brRaw);
      if (!br || !SELECTED.has(br)) continue;

      const model = T(r["Model"] || "");
      const codeRaw = T(r["Stok Kodu"] || "");
      if (!model || !codeRaw) continue;

      const code = codeNorm(codeRaw);
      const alt = codeAlt(code);

      const supSet = tsoftSupByBrand.get(br);
      const hit = supSet ? (supSet.has(code) || (alt ? supSet.has(alt) : false)) : false;

      if (hit) continue; // T-Soft sup ile eşleşiyorsa listelenmez

      const key = (br + "||" + model + "||" + code).toLocaleLowerCase(TR);
      if (seen.has(key)) continue;
      seen.add(key);

      out.push({ brand: br, model, code });
    }

    out.sort((a,b) => {
      const x = a.brand.localeCompare(b.brand, "tr", {sensitivity:"base"});
      if (x) return x;
      return a.model.localeCompare(b.model, "tr", {sensitivity:"base"});
    });

    for (let i=0;i<out.length;i++){
      const tr = document.createElement("tr");

      const td1 = document.createElement("td"); td1.textContent = String(i+1);
      const td2 = document.createElement("td"); td2.textContent = out[i].brand;
      const td3 = document.createElement("td"); td3.textContent = out[i].model;
      const td4 = document.createElement("td"); td4.textContent = out[i].code;

      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
      outBody.appendChild(tr);
    }

    $("outInfo").innerHTML = `<span class="ok">Bitti</span> • ${out.length} kayıt`;
  });

  // init
  renderAidePreview([], ["Marka","Model","Stok Kodu"]);
  updateRunEnabled();
  loadBrands();
})();
</script>
</body>
</html>
İstersen 2. aşamada (senin ana projeye gömme) bunu modülleyip sadece gerekli fonksiyonları ayırırız.


Şunu dedin:
listenin başlarındaki markaları tarayıp ürün adlarını çıkarttı, fakat listenin ilerisinde aynı markadaki ürünleri bulamadı csv deküçük ekranda olduğu için csv den önce mi sorun var csv den sonra mı bilmiyorum dilersen aşağı slide'lı tam aide converted listeyi gösteren bir html olarak komple revize et bana bunu veya daha iyi bi fikrin var mı ? benim var. aide listesini komple kopyalayıp bir linkin içine yapıştırıp sana atayım sen de bak listede mi bi sorun var  a mı b mi hep sen soruyorsun bir kez de ben sorayım bana bir c seçeneği ile de gelebilirsin

ChatGPT:

47s boyunca düşündüm
Evet, bu davranış genelde Aide kopyasında “sonlara doğru satırlar düzgün parse edilemediği için” olur (örn: bazı satırlar tab yerine boşlukla geliyor, satır içi satır-sonu kırılıyor, hücre içinde enter/tab var vs.). Bu durumda sen “marka başlarda çıktı ama ileride aynı marka yok” sanırsın; aslında o satırlar convert aşamasında listeye hiç girmemiştir.

Senin “Aide’yi linkin içine koyup atayım” fikri pratikte kötü çalışır çünkü URL uzunluk limitleri var (çok kısa bir noktada kesilir). Daha iyi 2 seçenek:

A seçeneği (en iyi): Convert edilen Aide listesini tam ekranda sayfalı/scroll’lu göstereyim + marka bazında sayım + arama + “convert edilen CSV indir”.

C seçeneği: Convert sonrası “Marka sayımları”ndan ARTURIA kaç satır parse edilmiş net görüp, sorun convert öncesi mi sonrası mı kesinleşsin.

Aşağıdaki tek HTML dosyası, senin mini sayfayı tam liste görüntüleme + sayfalama + arama + CSV indirme ile komple revize ediyor (log yok).

Kaydet: mini2.html → aç → T-Soft seç → Aide yapıştır → “Aide’yi Dönüştür” → “Tam Listeyi Aç”.



Bu revizede “sonlarda aynı marka ürünleri yok” sorununu ayırt etmek kolaylaşıyor:

Tam Listeyi Aç → marka dropdown’dan ARTURIA seç → gerçekten kaç satır var görürsün.

Eğer burada da azsa/sıfırsa: problem Aide convert aşaması (parse).

Burada varsa ama sonuçta yoksa: problem T-Soft sup eşleşmesi tarafı (ABL0021 gibi kodlar sup’ta var sayılıyor).

İstersen “benim var” dediğin fikrini de söyle—ben de buna alternatif C seçeneği olarak en pratik yolu öneririm.


Şunu dedin:
BU KOD ÇALIŞIYOR AMA RØDE gibi markaları çağırmıyor özellikle kodun içinde bi atama yoksa normal gibi

ChatGPT:

1m 2s boyunca düşündüm
Evet bu normal: Bizim “mini” kodda marka eşleşmesi tam metin (normalize edilmiş uppercase) üzerinden gidiyor.
RØDE ≠ RODE olduğu için:

Worker’dan marka RØDE geliyor (seçiyorsun)

Ama Aide/T-Soft içinde marka çoğu zaman RODE yazıyor

Sonuç: aynı marka sanıyorsun ama kod farklı marka görüyor → o markayı “bulamıyor” gibi oluyor.

Çözüm: match.js’deki gibi ALIAS/normBrand ekleyip her yerde onu kullanmak.

Aşağıdaki patch’i HTML içindeki <script> bölümünde, en üstlerde const TR = ... civarına ekle; sonra bNorm(...) kullandığın yerleri normBrand(...) ile değiştir.

// ✅ Marka normalize + alias (RØDE gibi)
const _fold = (s) => (s ?? "")
  .toString()
  .replace(/\u00A0/g, " ")
  .trim()
  .toLocaleUpperCase(TR)
  .replace(/\s+/g, " ");

// İstersen daha agresif: Ø -> O
const _fold2 = (s) => _fold(s).replace(/Ø/g, "O");

const ALIAS = new Map([
  ["RØDE", "RODE"],
  ["RØDE X", "RODE"],
  ["ALLEN & HEATH", "ALLEN HEATH"],
  ["MARANTZ PROFESSIONAL", "MARANTZ"],
  ["RUPERT NEVE DESIGNS", "RUPERT NEVE"],
]);

const normBrand = (s) => ALIAS.get(_fold(s)) || _fold2(s);
Sonra şu değişiklikler:

Marka listesi render’ında:

const bn = bNorm(b.name) → const bn = normBrand(b.name)

arama filtresi:

const q = bNorm(input) → const q = normBrand(input)

bNorm(b.name).includes(q) → normBrand(b.name).includes(q)

Aide convert ederken:

_bn = bNorm(markaRaw) → _bn = normBrand(markaRaw)

T-Soft sup setini kurarken:

const br = bNorm(r[C.marka]) → const br = normBrand(r[C.marka])

Bu kadar. Böylece RØDE/RODE aynı anahtara (RODE) düşer ve marka filtreleme + sonuç üretimi düzgün çalışır.


Şunu dedin:
tamam ben sana bi genel eşleştirme listesi vereyim komple düzelt olur mu

ChatGPT:
Olur. Listeyi gönder—ben de mini HTML’e tek bir ALIAS/NORM katmanı olarak gömüp her yerde (marka seçimi, Aide convert, T-Soft okuma, sonuç) aynı normalizasyonu kullanacak şekilde komple düzelteceğim.

Gönderirken şu format en iyi:

Her satır: GELEN -> HEDEF

Örn:

RØDE -> RODE

RØDE X -> RODE

ALLEN & HEATH -> ALLEN HEATH

İstersen bir de “şunlar tamamen yok sayılacak” gibi markalar varsa ayrı başlıkla yaz.


Şunu dedin:
peki compelden gelen marka datasının tam listesine nerden erişebilirim

ChatGPT:

19s boyunca düşündüm
Compel’den gelen marka listesinin tamamı, senin projende zaten çağırdığın Worker endpoint’inden geliyor:

https://robot-workstation.tvkapora.workers.dev/api/brands
En kolay erişim:

Bu adresi tarayıcıda yeni sekmede aç (JSON olarak tüm liste gelir).

İstersen Chrome’da sağ tık → “Farklı kaydet” ile .json olarak kaydet.

Alternatif (sayfandayken):

F12 → Console açıp şunu çalıştırabilirsin:

fetch("https://robot-workstation.tvkapora.workers.dev/api/brands")
  .then(r => r.json())
  .then(data => console.log(data));

Şunu dedin:
linke tıkladığımda çıkanlar bunlar

[{"id":1,"slug":"ableton","name":"Ableton","count":10},{"id":48,"slug":"allen-heath","name":"Allen & Heath","count":8},{"id":4,"slug":"arturia","name":"Arturia","count":61},{"id":6,"slug":"avalon","name":"Avalon","count":4},{"id":7,"slug":"avid","name":"Avid","count":16},{"id":49,"slug":"compel","name":"Compel","count":3},{"id":41,"slug":"cranborne-audio","name":"Cranborne Audio","count":9},{"id":9,"slug":"crane-song","name":"Crane Song","count":6},{"id":10,"slug":"denon-dj","name":"Denon DJ","count":10},{"id":50,"slug":"fender-studio","name":"Fender Studio","count":8},{"id":11,"slug":"genelec","name":"Genelec","count":25},{"id":12,"slug":"headrush","name":"HeadRush","count":8},{"id":13,"slug":"hosa","name":"Hosa","count":296},{"id":16,"slug":"m-audio","name":"M-Audio","count":50},{"id":44,"slug":"m-game","name":"M-Game","count":2},{"id":17,"slug":"marantz-professional","name":"Marantz Professional","count":9},{"id":20,"slug":"numark","name":"Numark","count":33},{"id":21,"slug":"presonus","name":"PreSonus","count":97},{"id":23,"slug":"rane","name":"Rane","count":10},{"id":25,"slug":"rupert-neve-designs","name":"Rupert Neve Designs","count":8},{"id":24,"slug":"rode","name":"RØDE","count":245},{"id":45,"slug":"rode-x","name":"RØDE X","count":3},{"id":47,"slug":"sheeran-loopers","name":"Sheeran Loopers","count":2},{"id":26,"slug":"sibelius","name":"Sibelius","count":6},{"id":28,"slug":"sonarworks","name":"Sonarworks","count":12},{"id":43,"slug":"soundswitch","name":"SoundSwitch","count":1},{"id":42,"slug":"stanton","name":"Stanton","count":3},{"id":36,"slug":"universal-audio","name":"Universal Audio","count":73},{"id":38,"slug":"warm-audio","name":"Warm Audio","count":79}]

ChatGPT:

32s boyunca düşündüm
Evet — bu JSON Compel marka listesinin tamamı ve her kayıtta:

id: marka id

slug: en sağlam eşleştirme anahtarı (diakritik/özel karakter derdi yok)

name: görünen ad (RØDE gibi özel karakter içerebilir)

count: ürün sayısı

RØDE meselesini “çağırmıyor” gibi yapan şey genelde şu: başka kaynaklarda marka RODE yazıyor, burada RØDE. En temiz çözüm: eşleştirmeyi name ile değil slug ile yapmak.

Mini HTML’de bunu yapmak için mantık şu olmalı:

Checkbox’ta seçimi name yerine slug olarak tut

Aide/T-Soft’tan gelen marka metnini bir “slug”a çevir (küçük bir toSlug() ile)

Karşılaştırmayı slug üzerinden yap

Basit toSlug() (RØDE → rode üretir):

const toSlug = (s) => (s ?? "")
  .toString()
  .trim()
  .toLocaleLowerCase("tr-TR")
  .normalize("NFKD").replace(/[\u0300-\u036f]/g, "") // aksanları at
  .replace(/ø/g, "o")                               // RØDE
  .replace(/&/g, "-")                               // Allen & Heath
  .replace(/[^a-z0-9]+/g, "-")
  .replace(/^-+|-+$/g, "");
Not: Bazı markalarda slug’lar “özel” olabilir (örn Allen & Heath slug’ı sende allen-heath). O durumda küçük bir alias eklenir:

toSlug("Allen & Heath") → allen-heath yapmak için & dönüşümünü "" gibi ayarlayabiliriz veya alias map koyarız.

İstersen “genel eşleştirme listesi”ni gönder; ben bu mini HTML’i slug-temelli + alias’lı hale getirip RØDE dahil hepsini tam oturtayım.


Şunu dedin:
tamam şimdi bana aide listesini yapıştıracağım ve sadece marka sütunundaki hücreleri tarayan ve aynı hücreleri sadece bir defa gösteren ve  bir liste çıktı verebilen basic bir html istiyorum 

ChatGPT:
Aşağıdaki tek dosyayı aide_marka_liste.html diye kaydet → aç → Aide tablosunu yapıştır → Markaları Çıkar → liste oluşur.
Sadece “Marka” sütununu tarar, tekilleştirir (aynı marka 1 kez) ve istersen CSV indir.

<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aide Marka Liste</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0d12;color:#eaeef7}
    .wrap{padding:14px;display:flex;gap:12px;flex-wrap:wrap}
    .card{border:1px solid #2a3140;background:#0f1320;border-radius:12px;padding:12px;flex:1 1 420px;min-width:320px}
    h3{margin:0 0 10px;font-size:16px}
    textarea,input{width:100%;box-sizing:border-box;background:#0b0d12;color:#eaeef7;border:1px solid #2a3140;border-radius:10px;padding:10px}
    textarea{min-height:260px;resize:vertical}
    button{
      background:#111827;color:#eaeef7;border:1px solid #2a3140;border-radius:10px;
      padding:9px 12px;font-weight:900;cursor:pointer
    }
    button:hover{background:#1f2a44;border-color:#6b7da6}
    button:disabled{opacity:.55;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .muted{opacity:.85;font-size:12px}
    .ok{color:#86efac}
    .bad{color:#fca5a5}
    .listBox{max-height:520px;overflow:auto;border:1px solid #2a3140;border-radius:10px;background:#0b0d12}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2430;padding:8px 8px;text-align:left;font-size:13px}
    th{position:sticky;top:0;background:#0f1320}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #2a3140;border-radius:999px;background:#0b0d12;font-size:12px;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3>Aide verisini yapıştır</h3>
      <textarea id="paste" placeholder="Aide stok listesini (tablo) kopyalayıp buraya yapıştır..."></textarea>
      <div class="row" style="margin-top:10px">
        <button id="run" type="button">Markaları Çıkar</button>
        <button id="dl" type="button" disabled>CSV indir</button>
        <button id="clr" type="button">Temizle</button>
      </div>
      <div class="muted" id="info" style="margin-top:8px">Sadece “Marka” sütunu taranır. Aynı marka 1 kez listelenir.</div>
      <div class="muted" style="margin-top:8px">
        <span class="pill">İpucu</span> Eğer tablo kopyasında “Marka” başlığı yoksa, satırların ilk hücresini marka kabul eder.
      </div>
    </div>

    <div class="card">
      <h3>Tekil Marka Listesi</h3>
      <div class="muted" id="outInfo">—</div>
      <div class="listBox" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th style="width:70px">Sıra</th>
              <th>Marka</th>
            </tr>
          </thead>
          <tbody id="out"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(() => {
  const TR = "tr-TR";
  const $ = (id) => document.getElementById(id);

  const T = (s) => (s ?? "").toString().trim();
  const norm = (s) => (s ?? "")
    .toString()
    .replace(/\u00A0/g," ")
    .trim()
    .toLocaleUpperCase(TR)
    .replace(/\s+/g," ");

  const isBad = (s) => {
    const x = T(s);
    if (!x) return true;
    const u = x.toLocaleUpperCase(TR).trim();
    return u === "-" || u === "—" || u === "N/A";
  };

  function detectDelimiter(h){
    const c = ["\t",";",",","|"];
    let best = c[0], m = -1;
    for (const d of c){
      const k = h.split(d).length - 1;
      if (k > m){ m = k; best = d; }
    }
    return best;
  }

  function parseDelimited(text){
    const lines = (text ?? "").toString().replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n");
    const first = lines.find(x => x.trim()) || "";
    const delim = detectDelimiter(first);

    const split = (line) => {
      const out=[]; let cur="", q=false;
      for (let i=0;i<line.length;i++){
        const ch=line[i];
        if (ch === '"'){
          if (q && line[i+1] === '"'){ cur+='"'; i++; }
          else q = !q;
        } else if (!q && ch === delim){
          out.push(cur); cur="";
        } else cur += ch;
      }
      out.push(cur);
      return out.map(v => v.trim());
    };

    let hdr=null, rows=[];
    for (const line of lines){
      if (!line || !line.trim()) continue;
      if (!hdr){ hdr = split(line); continue; }
      const vals = split(line), obj = {};
      for (let i=0;i<hdr.length;i++) obj[hdr[i]] = vals[i] ?? "";
      rows.push(obj);
    }
    return { hdr: hdr || [], rows };
  }

  const normHeader = (h) => (h ?? "").toString().trim().toLocaleUpperCase(TR).replace(/\s+/g," ");
  function pickBrandColumn(sampleObj){
    const map = new Map(Object.keys(sampleObj).map(k => [normHeader(k), k]));
    const direct = map.get("MARKA");
    if (direct) return direct;
    // bazı tablolarda Brand geçebilir
    return map.get("BRAND") || null;
  }

  // fallback: noisy tab paste, 1. kolon = Marka
  function extractBrandsFromNoisy(text){
    const lines = (text || "").split(/\r\n|\r|\n/);
    const out = [];
    for (let l of lines){
      l = (l || "").replace(/\u00A0/g," ").trim();
      if (!l) continue;
      if (!l.includes("\t")) continue;
      const a = l.split("\t").map(x => x.trim());
      if (!a.length) continue;
      // header satırını atla
      if (norm(a[0]) === "MARKA") continue;
      out.push(a[0]);
    }
    return out;
  }

  function toCSV(rows){
    const q = (v) => {
      v = (v ?? "").toString();
      return (v.includes('"')||v.includes("\n")||v.includes("\r")||v.includes(","))
        ? ('"' + v.replace(/"/g,'""') + '"') : v;
    };
    return "Sıra,Marka\n" + rows.map(r => `${q(r.no)},${q(r.brand)}`).join("\n");
  }

  function download(filename, text){
    const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1200);
  }

  let last = [];

  $("run").addEventListener("click", () => {
    const raw = $("paste").value || "";
    last = [];
    $("out").innerHTML = "";
    $("dl").disabled = true;

    if (!raw.trim()){
      $("info").innerHTML = `<span class="bad">Metin boş.</span>`;
      return;
    }

    let brands = [];

    // 1) delimited parse dene (Marka sütunu varsa en iyi)
    try{
      const p = parseDelimited(raw);
      if (p.rows?.length){
        const col = pickBrandColumn(p.rows[0]);
        if (col){
          brands = p.rows.map(r => r[col]).filter(Boolean);
        }
      }
    } catch {}

    // 2) olmadıysa noisy fallback
    if (!brands.length){
      brands = extractBrandsFromNoisy(raw);
    }

    // uniq
    const seen = new Map(); // norm -> display
    for (const b of brands){
      if (isBad(b)) continue;
      const n = norm(b);
      if (!n) continue;
      if (!seen.has(n)) seen.set(n, T(b)); // ilk gördüğünü display olarak tut
    }

    const arr = [...seen.entries()]
      .map(([n,disp]) => ({ n, disp }))
      .sort((a,b) => a.disp.localeCompare(b.disp, "tr", {sensitivity:"base"}));

    last = arr.map((x,i) => ({ no: String(i+1), brand: x.disp }));

    // render
    const tb = $("out");
    tb.innerHTML = last.map(r => `<tr><td>${r.no}</td><td>${r.brand}</td></tr>`).join("");

    $("outInfo").innerHTML = `<span class="ok">Bulunan tekil marka:</span> ${last.length}`;
    $("info").innerHTML = `<span class="ok">Bitti.</span> Toplam satırdan tekilleştirildi.`;
    $("dl").disabled = !last.length;
  });

  $("dl").addEventListener("click", () => {
    if (!last.length) return;
    download("aide_markalar.csv", toCSV(last));
  });

  $("clr").addEventListener("click", () => {
    $("paste").value = "";
    $("out").innerHTML = "";
    $("outInfo").textContent = "—";
    $("info").textContent = "Sadece “Marka” sütunu taranır. Aynı marka 1 kez listelenir.";
    $("dl").disabled = true;
    last = [];
  });
})();
</script>
</body>
</html>




