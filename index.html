<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tedarik Stok Karar Robotu</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0d12;color:#eaeef7}
    header{padding:12px 14px;border-bottom:1px solid #1f2430;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{font-size:12px;padding:4px 8px;border:1px solid #2a3140;border-radius:999px;color:#cbd5e1}
    main{display:grid;grid-template-columns:420px 1fr;gap:0;min-height:calc(100vh - 54px)}
    aside{border-right:1px solid #1f2430;padding:14px;min-height:0}
    section{padding:14px;min-height:0}
    h2{margin:0 0 10px 0;font-size:14px;color:#cbd5e1}
    .card{border:1px solid #1f2430;border-radius:14px;background:#0f1320;padding:12px;margin-bottom:12px}
    label{display:block;font-size:12px;color:#9aa7bd;margin-bottom:6px}
    input[type="file"]{width:100%}
    textarea{width:100%;min-height:120px;resize:vertical;background:#0b0d12;color:#eaeef7;border:1px solid #2a3140;border-radius:10px;padding:10px}
    button{background:#111827;color:#eaeef7;border:1px solid #2a3140;padding:9px 10px;border-radius:10px;cursor:pointer;font-weight:700;font-size:13px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .status{white-space:pre-wrap;font-size:12px;color:#9aa7bd;margin-top:8px}
    .bar{height:10px;border-radius:999px;background:#0b0d12;border:1px solid #1f2430;overflow:hidden}
    .bar > div{height:100%;background:#2a3140;width:0%}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .tabbtn{padding:7px 9px;border-radius:10px;border:1px solid #2a3140;background:#0f1320;font-weight:800}
    .tabbtn.active{border-color:#3a465f}
    .tableWrap{border-top:1px solid #1f2430;overflow:auto;max-height:calc(100vh - 170px)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2430;padding:9px 8px;text-align:left;vertical-align:top}
    th{position:sticky;top:0;background:#0b0d12;font-size:12px;color:#cbd5e1}
    td{font-size:13px}
    a{color:#93c5fd;text-decoration:none}
    a:hover{text-decoration:underline}
    .small{font-size:12px;color:#9aa7bd}
    .warn{color:#fcd34d}
    .ok{color:#86efac}
    .bad{color:#fca5a5}
    .inp{width:100%;background:#0b0d12;color:#eaeef7;border:1px solid #2a3140;border-radius:10px;padding:8px}
    @media (max-width: 980px){ main{grid-template-columns:1fr} aside{border-right:0;border-bottom:1px solid #1f2430} th{position:static} .tableWrap{max-height:50vh}}
  </style>
</head>
<body>
<header>
  <strong>Tedarik Stok Karar Robotu</strong>
  <span class="pill" id="brandPill">Compel markaları: …</span>
  <span class="pill" id="scopePill">Kapsam: …</span>
</header>

<main>
  <aside>
    <div class="card">
      <h2>1) Dosyalar</h2>

      <label>products.csv (Sescibaba)</label>
      <input id="fProducts" type="file" accept=".csv,text/csv" />

      <div style="height:10px"></div>

      <label>aide.xlsx (Depo) (opsiyonel)</label>
      <input id="fAide" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />

      <div style="height:10px"></div>

      <label>Depo verisi yapıştır (opsiyonel) — stok ekranındaki tabloyu kopyalayıp buraya yapıştır</label>
      <textarea id="taDepot" placeholder="Tabloyu kopyala → buraya yapıştır (başlık satırı varsa daha iyi)."></textarea>
      <div class="small">Not: aide.xlsx yüklersen bu alanı boş bırakabilirsin.</div>

      <div style="height:10px"></div>

      <label>compel-sonuc.txt (opsiyonel) — yüklenirse Worker taraması yapılmaz</label>
      <input id="fCompel" type="file" accept=".txt,text/plain" />

      <div style="height:10px"></div>

      <label>mapping.json (opsiyonel)</label>
      <input id="fMapping" type="file" accept=".json,application/json" />

      <div style="height:12px"></div>

      <div class="row">
        <button id="btnGenerate" disabled>Generate</button>
        <button id="btnExportMapping" disabled>mapping.json indir</button>
        <button id="btnClearMapping">mapping sıfırla</button>
      </div>

      <div style="height:10px"></div>
      <div class="bar"><div id="barFill"></div></div>
      <div class="status" id="status">Hazır.</div>
    </div>

    <div class="card">
      <h2>Notlar</h2>
      <div class="small">
        • Depo↔Sescibaba eşleşmesi: <b>Tedarikçi Ürün Kodu</b> ↔ <b>Stok Kodu</b><br/>
        • Compel↔Sescibaba eşleşmesi: <b>Barkod (EAN)</b> ↔ <b>ean</b><br/>
        • Marka filtresi: products.csv’de Marka yoksa, ürün adından marka tahmini yapılır (tam tutmayabilir).<br/>
      </div>
    </div>
  </aside>

  <section>
    <div class="tabs">
      <button class="tabbtn active" data-tab="close">Kapatılabilir (<span id="cntClose">0</span>)</button>
      <button class="tabbtn" data-tab="keep">Açık kalsın/Aç (<span id="cntKeep">0</span>)</button>
      <button class="tabbtn" data-tab="manual">Manuel (<span id="cntManual">0</span>)</button>
      <span style="flex:1"></span>
      <button id="btnExportList" disabled>Listeyi CSV indir</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- XLSX parser (SheetJS) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // ✅ Worker URL
  const API_BASE = "https://tedarick.tvkapora.workers.dev";

  const els = {
    brandPill: document.getElementById('brandPill'),
    scopePill: document.getElementById('scopePill'),
    fProducts: document.getElementById('fProducts'),
    fAide: document.getElementById('fAide'),
    taDepot: document.getElementById('taDepot'),
    fCompel: document.getElementById('fCompel'),
    fMapping: document.getElementById('fMapping'),
    btnGenerate: document.getElementById('btnGenerate'),
    btnExportMapping: document.getElementById('btnExportMapping'),
    btnClearMapping: document.getElementById('btnClearMapping'),
    barFill: document.getElementById('barFill'),
    status: document.getElementById('status'),
    tabs: [...document.querySelectorAll('.tabbtn')],
    thead: document.getElementById('thead'),
    tbody: document.getElementById('tbody'),
    btnExportList: document.getElementById('btnExportList'),
    cntClose: document.getElementById('cntClose'),
    cntKeep: document.getElementById('cntKeep'),
    cntManual: document.getElementById('cntManual'),
  };

  const LS_KEY = "stokbot_mapping_v1";

  let BRANDS = [];
  let brandNormList = []; // {id,name,slug,normName,normSlug,normWords}
  let mapping = loadMapping();
  let currentTab = "close";
  let lists = { close: [], keep: [], manual: [] };

  function setStatus(msg){ els.status.textContent = msg; }
  function setProgress(p){ els.barFill.style.width = Math.max(0, Math.min(100, p)) + "%"; }

  function trNorm(s){
    s = String(s ?? "").toLowerCase().trim();
    const map = { "ı":"i","İ":"i","ş":"s","Ş":"s","ğ":"g","Ğ":"g","ü":"u","Ü":"u","ö":"o","Ö":"o","ç":"c","Ç":"c","â":"a","î":"i","û":"u","ø":"o" };
    s = s.replace(/[ıİşŞğĞüÜöÖçÇâîûø]/g, ch => map[ch] ?? ch);
    s = s.replace(/&/g," and ");
    s = s.replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim();
    return s;
  }

  function digitsOnly(s){ return String(s ?? "").replace(/\D+/g, ""); }
  function normCode(s){ return String(s ?? "").trim().toUpperCase().replace(/\s+/g, ""); }

  function truthyActive(v){
    const t = String(v ?? "").trim().toLowerCase();
    return ["1","true","evet","yes","aktif","on"].includes(t);
  }

  function toInt(v){
    const t = String(v ?? "").replace(",", ".").replace(/[^\d.-]/g,"").trim();
    const n = Number(t);
    if (!Number.isFinite(n)) return 0;
    return n < 0 ? 0 : Math.floor(n);
  }

  function parseCompelStockText(stockText){
    const t = String(stockText ?? "");
    if (/bilinmiyor/i.test(t)) return null;
    if (/yok/i.test(t)) return 0;
    const m = t.match(/(\d+)/);
    if (m) return Math.max(0, Number(m[1]));
    if (/var/i.test(t)) return 1;
    return null;
  }

  function loadMapping(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return { version: 1, mapDepot: {}, mapCompel: {} };
      const j = JSON.parse(raw);
      return {
        version: 1,
        mapDepot: j.mapDepot || {},
        mapCompel: j.mapCompel || {},
      };
    } catch {
      return { version: 1, mapDepot: {}, mapCompel: {} };
    }
  }

  function saveMapping(){
    localStorage.setItem(LS_KEY, JSON.stringify(mapping));
    els.btnExportMapping.disabled = false;
  }

  function resetMapping(){
    mapping = { version: 1, mapDepot: {}, mapCompel: {} };
    localStorage.removeItem(LS_KEY);
    els.btnExportMapping.disabled = true;
    setStatus("mapping sıfırlandı.");
    // listeler varsa yeniden hesaplamak istersen sonraki adımda ekleriz
  }

  function downloadJson(obj, filename){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  function downloadCsv(rows, filename){
    const esc = (s) => {
      const v = String(s ?? "");
      if (/[",\n]/.test(v)) return `"${v.replace(/"/g,'""')}"`;
      return v;
    };
    if (!rows.length){
      downloadText("","empty.csv");
      return;
    }
    const cols = Object.keys(rows[0]);
    const lines = [cols.join(","), ...rows.map(r => cols.map(c => esc(r[c])).join(","))];
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  function downloadText(text, filename){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  // Basit CSV parser (quotes destekli)
  function parseCsvText(text){
    const rows = [];
    let i=0, field="", row=[], inQuotes=false;
    const pushField = ()=>{ row.push(field); field=""; };
    const pushRow = ()=>{ rows.push(row); row=[]; };
    while (i < text.length){
      const c = text[i];
      if (inQuotes){
        if (c === '"'){
          if (text[i+1] === '"'){ field += '"'; i+=2; continue; }
          inQuotes = false; i++; continue;
        } else { field += c; i++; continue; }
      } else {
        if (c === '"'){ inQuotes = true; i++; continue; }
        if (c === ','){ pushField(); i++; continue; }
        if (c === '\n'){ pushField(); pushRow(); i++; continue; }
        if (c === '\r'){ i++; continue; }
        field += c; i++; continue;
      }
    }
    pushField(); pushRow();
    // boş trailing satır temizle
    return rows.filter(r => r.some(x => String(x ?? "").trim() !== ""));
  }

  function rowsToObjects(grid){
    const headers = grid[0].map(h => String(h ?? "").trim());
    const out = [];
    for (let r=1; r<grid.length; r++){
      const obj = {};
      for (let c=0; c<headers.length; c++){
        obj[headers[c]] = grid[r][c] ?? "";
      }
      out.push(obj);
    }
    return out;
  }

  async function readFileText(file){
    return await file.text();
  }

  async function loadBrands(){
    setStatus("Compel markaları yükleniyor…");
    setProgress(5);
    const res = await fetch(`${API_BASE}/api/brands`, { cache: "no-store" });
    if (!res.ok) throw new Error("brands alınamadı: " + res.status);
    BRANDS = await res.json();
    brandNormList = BRANDS.map(b => {
      const name = b.name || "";
      const slug = b.slug || "";
      const words = slug.replace(/-/g," ");
      return {
        ...b,
        normName: trNorm(name),
        normSlug: trNorm(slug),
        normWords: trNorm(words),
      };
    }).sort((a,b)=> b.normName.length - a.normName.length);
    els.brandPill.textContent = `Compel markaları: ${BRANDS.length}`;
    setProgress(10);
    setStatus("Hazır. products.csv seç.");
  }

  function inferBrandFromTitle(title){
    const t = trNorm(title);
    if (!t) return "";
    for (const b of brandNormList){
      // kelime sınırı gibi davranması için boşlukla çevrele
      const pad = " " + t + " ";
      const key1 = " " + b.normName + " ";
      const key2 = b.normWords ? (" " + b.normWords + " ") : "";
      if (b.normName && pad.includes(key1)) return b.name;
      if (key2 && pad.includes(key2)) return b.name;
    }
    // başta yakalama (bazı adlar birleşik gelebilir)
    for (const b of brandNormList){
      if (b.normName && t.startsWith(b.normName + " ")) return b.name;
      if (b.normWords && t.startsWith(b.normWords + " ")) return b.name;
    }
    return "";
  }

  function sbKeyOf(row){
    const supplier = normCode(row["Tedarikçi Ürün Kodu"] ?? "");
    const ean = digitsOnly(row["Barkod"] ?? "");
    const title = String(row["Ürün Adı"] ?? "").trim();
    if (supplier) return "SUP:" + supplier;
    if (ean) return "EAN:" + ean;
    return "NAME:" + trNorm(title);
  }

  function pickBrandObj(brandName){
    const bn = trNorm(brandName);
    return brandNormList.find(b => b.normName === bn) || null;
  }

  function allowlistHas(brandName){
    const bn = trNorm(brandName);
    return brandNormList.some(b => b.normName === bn);
  }

  async function parseDepotFromPaste(text){
    const t = String(text ?? "").trim();
    if (!t) return new Map();
    // TSV / clipboard tablo
    const lines = t.split(/\r?\n/).filter(x => x.trim() !== "");
    const grid = lines.map(l => l.split("\t"));
    // header bul
    const hdr = grid[0].map(x => String(x ?? "").trim());
    let idxCode = hdr.findIndex(h => trNorm(h) === trNorm("Stok Kodu") || trNorm(h).includes("stok kodu"));
    let idxStock = hdr.findIndex(h => trNorm(h) === trNorm("Stok") || trNorm(h) === trNorm("Stok Adedi") || trNorm(h).includes("stok"));
    // başlık yoksa varsayım: 3. sütun stok kodu, 5. stok (senin xlsx düzenin)
    const startRow = (idxCode >= 0 && idxStock >= 0) ? 1 : 0;
    if (startRow === 0){
      idxCode = 2;
      idxStock = 4;
    }
    const map = new Map();
    for (let r=startRow; r<grid.length; r++){
      const row = grid[r];
      const code = normCode(row[idxCode] ?? "");
      if (!code) continue;
      const stock = toInt(row[idxStock] ?? 0);
      map.set(code, (map.get(code) || 0) + stock);
    }
    return map;
  }

  async function parseDepotFromXlsx(file){
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type: "array" });
    const first = wb.SheetNames[0];
    const ws = wb.Sheets[first];
    const json = XLSX.utils.sheet_to_json(ws, { defval: "" }); // header satırı otomatik
    const map = new Map();
    for (const r of json){
      const code = normCode(r["Stok Kodu"] ?? r["StokKodu"] ?? "");
      if (!code) continue;
      const stock = toInt(r["Stok"] ?? 0);
      map.set(code, (map.get(code) || 0) + stock);
    }
    return map;
  }

  async function parseCompelFromTxt(file){
    const text = await readFileText(file);
    const lines = text.split(/\r?\n/).filter(x => x.trim() !== "");
    if (!lines.length) return new Map();
    const hdr = lines[0].split("\t").map(h => String(h ?? "").trim());
    const idxEan = hdr.findIndex(h => trNorm(h) === trNorm("EAN"));
    const idxStock = hdr.findIndex(h => trNorm(h) === trNorm("Stok"));
    const idxTitle = hdr.findIndex(h => trNorm(h).includes("urun adi"));
    const idxBrand = hdr.findIndex(h => trNorm(h) === trNorm("Marka"));
    const map = new Map();
    for (let i=1; i<lines.length; i++){
      const cols = lines[i].split("\t");
      const ean = digitsOnly(cols[idxEan] ?? "");
      if (ean.length !== 13) continue;
      const stock = toInt(cols[idxStock] ?? 0);
      map.set(ean, { stock, title: cols[idxTitle] ?? "", brand: cols[idxBrand] ?? "", url: "" });
    }
    return map;
  }

  async function scanCompelFromWorker(brandsToScan){
    // brandsToScan: array of brand objects expected by worker
    const res = await fetch(`${API_BASE}/api/scan`, {
      method: "POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify({ brands: brandsToScan }),
    });
    if (!res.ok) {
      const t = await res.text().catch(()=> "");
      throw new Error(`Compel scan hata: ${res.status}\n${t}`);
    }
    const reader = res.body?.getReader?.();
    if (!reader) throw new Error("Stream yok.");
    const decoder = new TextDecoder();
    let buf = "";

    const map = new Map(); // ean -> {stock,title,brand,url}
    let doneBrands = 0;
    const totalBrands = brandsToScan.length;
    let currentBrand = "";
    let currentPage = 0, currentPages = 1;

    while (true){
      const { value, done } = await reader.read();
      if (done) break;
      buf += decoder.decode(value, {stream:true});

      let idx;
      while ((idx = buf.indexOf("\n")) >= 0){
        const line = buf.slice(0, idx).trim();
        buf = buf.slice(idx+1);
        if (!line) continue;

        const msg = JSON.parse(line);

        if (msg.type === "brandStart"){
          currentBrand = msg.brand;
          currentPage = msg.page;
          currentPages = msg.pages || 1;
          const p = 40 + Math.floor(50 * ((doneBrands + (currentPage-1)/currentPages) / Math.max(1,totalBrands)));
          setProgress(p);
          setStatus(`Compel taranıyor: ${currentBrand} (${currentPage}/${currentPages})`);
        } else if (msg.type === "page"){
          currentBrand = msg.brand;
          currentPage = msg.page;
          currentPages = msg.pages || 1;
          const p = 40 + Math.floor(50 * ((doneBrands + (currentPage-1)/currentPages) / Math.max(1,totalBrands)));
          setProgress(p);
          setStatus(`Compel taranıyor: ${currentBrand} (${currentPage}/${currentPages})`);
        } else if (msg.type === "product"){
          const p = msg.data || {};
          const ean = digitsOnly(p.ean || "");
          if (ean.length !== 13) continue;
          const stock = parseCompelStockText(p.stock);
          // Aynı EAN gelirse: stok varsa güncelle, url/title boşsa doldur
          const prev = map.get(ean) || { stock: 0, title:"", brand:"", url:"" };
          map.set(ean, {
            stock: (stock === null ? prev.stock : stock),
            title: p.title || prev.title,
            brand: p.brand || prev.brand,
            url: p.url || prev.url,
          });
        } else if (msg.type === "done"){
          doneBrands = totalBrands;
          setProgress(90);
          setStatus("Compel taraması bitti.");
        } else if (msg.type === "error"){
          setStatus("Compel hata: " + msg.message);
        }
      }
      // UI nefes
      await new Promise(r => setTimeout(r, 0));
    }

    setProgress(90);
    return map;
  }

  function renderTable(tab){
    currentTab = tab;
    els.tabs.forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
    const rows = lists[tab] || [];
    els.btnExportList.disabled = rows.length === 0;

    els.thead.innerHTML = "";
    els.tbody.innerHTML = "";

    if (tab === "manual"){
      els.thead.innerHTML = `
        <tr>
          <th>Ürün</th>
          <th>Tedarikçi Ürün Kodu</th>
          <th>Barkod</th>
          <th>Aktif</th>
          <th>Depo eşle</th>
          <th>Compel EAN eşle</th>
          <th></th>
        </tr>`;
      for (const r of rows){
        const tr = document.createElement("tr");

        const tdTitle = document.createElement("td");
        const link = r.compelUrl || r.seoLink || "";
        if (link){
          const a = document.createElement("a");
          a.href = link;
          a.target = "_blank";
          a.rel = "noopener";
          a.textContent = r.title;
          tdTitle.appendChild(a);
        } else tdTitle.textContent = r.title;

        const tdSup = document.createElement("td"); tdSup.textContent = r.supplierCode;
        const tdEan = document.createElement("td"); tdEan.textContent = r.ean;
        const tdAct = document.createElement("td"); tdAct.textContent = r.active ? "1" : "0";

        const tdDep = document.createElement("td");
        const inpDep = document.createElement("input");
        inpDep.className = "inp";
        inpDep.placeholder = "Stok Kodu";
        inpDep.value = (mapping.mapDepot[r.sbKey] || "");
        tdDep.appendChild(inpDep);

        const tdCom = document.createElement("td");
        const inpCom = document.createElement("input");
        inpCom.className = "inp";
        inpCom.placeholder = "13 hane EAN";
        inpCom.value = (mapping.mapCompel[r.sbKey] || "");
        tdCom.appendChild(inpCom);

        const tdBtn = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "Kaydet";
        btn.addEventListener("click", () => {
          const dep = normCode(inpDep.value);
          const com = digitsOnly(inpCom.value);
          if (dep) mapping.mapDepot[r.sbKey] = dep; else delete mapping.mapDepot[r.sbKey];
          if (com.length === 13) mapping.mapCompel[r.sbKey] = com; else delete mapping.mapCompel[r.sbKey];
          saveMapping();
          setStatus("Kaydedildi. Generate'e tekrar bas (şimdilik).");
        });
        tdBtn.appendChild(btn);

        tr.appendChild(tdTitle);
        tr.appendChild(tdSup);
        tr.appendChild(tdEan);
        tr.appendChild(tdAct);
        tr.appendChild(tdDep);
        tr.appendChild(tdCom);
        tr.appendChild(tdBtn);

        els.tbody.appendChild(tr);
      }
      return;
    }

    // close / keep
    els.thead.innerHTML = `
      <tr>
        <th>Ürün</th>
        <th>Tedarikçi Ürün Kodu</th>
        <th>Barkod</th>
        <th>Depo</th>
        <th>Compel</th>
        <th>Aktif</th>
      </tr>`;

    for (const r of rows){
      const tr = document.createElement("tr");

      const tdTitle = document.createElement("td");
      const link = r.compelUrl || r.seoLink || "";
      if (link){
        const a = document.createElement("a");
        a.href = link;
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = r.title;
        tdTitle.appendChild(a);
      } else tdTitle.textContent = r.title;

      const tdSup = document.createElement("td"); tdSup.textContent = r.supplierCode;
      const tdEan = document.createElement("td"); tdEan.textContent = r.ean;

      const tdDep = document.createElement("td");
      tdDep.textContent = String(r.depotStock);
      tdDep.className = r.depotStock > 0 ? "ok" : "bad";

      const tdCom = document.createElement("td");
      tdCom.textContent = (r.compelStock === null ? "?" : String(r.compelStock));
      tdCom.className = (r.compelStock === null ? "warn" : (r.compelStock > 0 ? "ok" : "bad"));

      const tdAct = document.createElement("td"); tdAct.textContent = r.active ? "1" : "0";

      tr.appendChild(tdTitle);
      tr.appendChild(tdSup);
      tr.appendChild(tdEan);
      tr.appendChild(tdDep);
      tr.appendChild(tdCom);
      tr.appendChild(tdAct);

      els.tbody.appendChild(tr);
    }
  }

  function buildDecisionLists(sbRows, depotMap, compelMap){
    const close = [];
    const keep = [];
    const manual = [];

    let inScope = 0;

    for (const row of sbRows){
      const title = String(row["Ürün Adı"] ?? "").trim();
      const supplierCode = normCode(row["Tedarikçi Ürün Kodu"] ?? "");
      const ean = digitsOnly(row["Barkod"] ?? "");
      const active = truthyActive(row["Aktif"]);

      // Marka filtresi: Marka sütunu yoksa ürün adından tahmin
      const brand = String(row["Marka"] ?? "").trim() || inferBrandFromTitle(title);
      const inAllow = brand ? allowlistHas(brand) : false;

      if (!inAllow) continue; // ✅ Compel’de olmayan markalar ignore
      inScope++;

      const sbKey = sbKeyOf(row);

      // manual overrides
      const depotCode = mapping.mapDepot[sbKey] ? normCode(mapping.mapDepot[sbKey]) : supplierCode;
      const compelEan = mapping.mapCompel[sbKey] ? digitsOnly(mapping.mapCompel[sbKey]) : ean;

      const depotStock = depotCode ? (depotMap.get(depotCode) || 0) : 0;

      const compelRec = (compelEan && compelEan.length === 13) ? (compelMap.get(compelEan) || null) : null;
      const compelStock = compelRec ? (compelRec.stock ?? 0) : 0;
      const compelUrl = compelRec ? (compelRec.url || "") : "";

      const seo = String(row["SEO Link"] ?? "").trim();

      const out = {
        sbKey,
        title,
        supplierCode,
        ean,
        active,
        depotStock,
        compelStock: (compelRec && (compelRec.stock === null)) ? null : compelStock,
        compelUrl,
        seoLink: seo,
      };

      const depotMatched = depotCode && depotMap.has(depotCode);
      const compelMatched = compelEan && compelEan.length === 13 && compelMap.has(compelEan);

      // Manuel list: herhangi bir taraf eşleşmediyse (veya anahtar eksikse)
      if (!supplierCode || !ean || !depotMatched || !compelMatched){
        manual.push(out);
      }

      // Karar: "Bilinmiyor" (null) varsa güvenli tarafta: açık kalsın
      const cStock = out.compelStock;
      const closeable = active && depotStock === 0 && cStock === 0; // null değilse 0
      if (closeable) close.push(out);
      else {
        const keepIt = (depotStock > 0) || (cStock === null) || (cStock > 0);
        if (keepIt) keep.push(out);
      }
    }

    return { close, keep, manual, inScope };
  }

  async function generate(){
    const fProducts = els.fProducts.files?.[0] || null;
    if (!fProducts){ setStatus("products.csv seç."); return; }

    setProgress(12);
    setStatus("products.csv okunuyor…");

    // mapping.json yüklenmişse içeri al
    const fMap = els.fMapping.files?.[0] || null;
    if (fMap){
      try{
        const j = JSON.parse(await readFileText(fMap));
        mapping = { version: 1, mapDepot: j.mapDepot || {}, mapCompel: j.mapCompel || {} };
        saveMapping();
      } catch {
        setStatus("mapping.json okunamadı (devam ediyorum).");
      }
    }

    // products.csv parse
    const csvText = await readFileText(fProducts);
    const grid = parseCsvText(csvText);
    const sbRows = rowsToObjects(grid);

    setProgress(20);
    setStatus(`products.csv satır: ${sbRows.length}. Depo verisi hazırlanıyor…`);

    // Depo
    let depotMap = new Map();
    const fAide = els.fAide.files?.[0] || null;
    const paste = els.taDepot.value || "";

    if (fAide){
      depotMap = await parseDepotFromXlsx(fAide);
    } else if (paste.trim()){
      depotMap = await parseDepotFromPaste(paste);
    } else {
      depotMap = new Map(); // depo yoksa her şey 0 sayılır
    }

    setProgress(35);
    setStatus(`Depo satırları (unique Stok Kodu): ${depotMap.size}. Compel verisi hazırlanıyor…`);

    // Compel: TXT varsa onu kullan, yoksa Worker scan
    let compelMap = new Map();
    const fCompel = els.fCompel.files?.[0] || null;

    if (fCompel){
      compelMap = await parseCompelFromTxt(fCompel);
      setProgress(55);
      setStatus(`Compel TXT alındı. EAN sayısı: ${compelMap.size}`);
    } else {
      // products içinden allowlist brand set çıkar
      const brandSet = new Map(); // norm -> brandObj
      for (const r of sbRows){
        const title = String(r["Ürün Adı"] ?? "").trim();
        const brand = String(r["Marka"] ?? "").trim() || inferBrandFromTitle(title);
        if (!brand) continue;
        const bObj = pickBrandObj(brand);
        if (bObj) brandSet.set(bObj.normName, bObj);
      }
      const brandsToScan = [...brandSet.values()];
      els.scopePill.textContent = `Kapsam markası: ${brandsToScan.length}`;

      if (!brandsToScan.length){
        setStatus("Marka tespit edemedim. (products.csv'de Marka yoksa ürün adında marka geçmeli.)");
        setProgress(40);
        // Compel boş kalır, ama yine de karar üretelim
        compelMap = new Map();
      } else {
        setProgress(40);
        setStatus(`Compel taraması başlıyor. Marka: ${brandsToScan.length}`);
        compelMap = await scanCompelFromWorker(brandsToScan);
        setStatus(`Compel bitti. EAN: ${compelMap.size}`);
      }
    }

    // Karar listeleri
    setProgress(92);
    setStatus("Eşleştirme + listeler…");

    const { close, keep, manual, inScope } = buildDecisionLists(sbRows, depotMap, compelMap);
    lists = { close, keep, manual };

    els.cntClose.textContent = String(close.length);
    els.cntKeep.textContent = String(keep.length);
    els.cntManual.textContent = String(manual.length);
    els.scopePill.textContent = `Kapsam ürün: ${inScope}`;

    setProgress(100);
    setStatus(`Bitti.\nKapatılabilir: ${close.length}\nAçık kalsın: ${keep.length}\nManuel: ${manual.length}`);

    renderTable(currentTab);
  }

  // Events
  els.btnGenerate.addEventListener("click", () => generate().catch(e => {
    setStatus("Hata:\n" + (e?.message || e));
  }));

  els.btnExportMapping.addEventListener("click", () => downloadJson(mapping, "mapping.json"));
  els.btnClearMapping.addEventListener("click", resetMapping);

  els.btnExportList.addEventListener("click", () => {
    const rows = lists[currentTab] || [];
    const out = rows.map(r => ({
      "Ürün": r.title,
      "Tedarikçi Ürün Kodu": r.supplierCode,
      "Barkod": r.ean,
      "Depo Stok": r.depotStock,
      "Compel Stok": (r.compelStock === null ? "" : r.compelStock),
      "Aktif": r.active ? 1 : 0,
      "Compel URL": r.compelUrl || "",
      "SEO Link": r.seoLink || "",
    }));
    downloadCsv(out, `stok-${currentTab}.csv`);
  });

  els.tabs.forEach(btn => btn.addEventListener("click", () => renderTable(btn.dataset.tab)));

  function updateGenerateEnabled(){
    els.btnGenerate.disabled = !(els.fProducts.files?.[0]);
    els.btnExportMapping.disabled = !localStorage.getItem(LS_KEY);
  }
  els.fProducts.addEventListener("change", updateGenerateEnabled);
  els.fAide.addEventListener("change", updateGenerateEnabled);
  els.fCompel.addEventListener("change", updateGenerateEnabled);
  els.fMapping.addEventListener("change", updateGenerateEnabled);
  updateGenerateEnabled();

  // Boot
  loadBrands().then(() => {
    updateGenerateEnabled();
  }).catch(e => {
    setStatus("Worker erişilemedi:\n" + (e?.message || e));
  });
</script>
</body>
</html>
