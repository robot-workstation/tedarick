<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Stok Karşılaştırma</title>
<style>
body{font-family:system-ui;margin:16px}
button{cursor:pointer}
.brand{padding:4px;border:1px solid #ddd;margin:2px 0}
.brand.sel{background:#eef}
table{border-collapse:collapse;width:100%;margin-top:10px}
td,th{border:1px solid #ccc;padding:4px;font-size:13px}
</style>
</head>
<body>

<h3>Stok Karşılaştırma</h3>

<div>
<button id="loadBrands">Markaları Yükle</button>
<div id="brandList"></div>
</div>

<br>

<input type="file" id="csv">
<button id="go">Listele</button>

<div id="status"></div>

<table id="result"></table>

<script>
const API="https://robot-workstation.tvkapora.workers.dev"
const TR='tr-TR'
const norm=s=>(s||'').toString().trim().toLocaleUpperCase(TR)
const esc=s=>(s||'').toString()
.replaceAll('&','&amp;')
.replaceAll('<','&lt;')
.replaceAll('>','&gt;')

let BRANDS=[]
let SELECTED=new Set()
let L1=[],L2=[]

async function loadBrands(){
const r=await fetch(API+"/api/brands",{cache:'no-store'})
BRANDS=await r.json()
renderBrands()
}

function renderBrands(){
const el=document.getElementById("brandList")
el.innerHTML=''
BRANDS.sort((a,b)=>a.name.localeCompare(b.name,'tr'))
.forEach(b=>{
const d=document.createElement("div")
d.className='brand'
d.textContent=b.name
d.onclick=()=>{
if(SELECTED.has(b.id)){SELECTED.delete(b.id);d.classList.remove('sel')}
else{SELECTED.add(b.id);d.classList.add('sel')}
}
el.appendChild(d)
})
}

async function scanCompel(brands){
L1=[]
const r=await fetch(API+"/api/scan",{
method:'POST',
headers:{'content-type':'application/json'},
body:JSON.stringify({brands})
})
const rd=r.body.getReader()
const dec=new TextDecoder()
let buf=''
while(1){
const {value,done}=await rd.read()
if(done)break
buf+=dec.decode(value,{stream:true})
let i
while((i=buf.indexOf('\n'))>=0){
const line=buf.slice(0,i).trim()
buf=buf.slice(i+1)
if(!line)continue
const m=JSON.parse(line)
if(m.type==='product'){
L1.push({
marka:m.data.brand,
ad:m.data.title,
kod:m.data.productCode,
ean:m.data.ean,
stok:m.data.stock
})
}
}
}
}

function parseCSV(t){
const l=t.replace(/\r/g,'').split('\n')
const h=l[0].split(',')
return l.slice(1).filter(x=>x).map(x=>{
const o={}
x.split(',').forEach((v,i)=>o[h[i]]=v)
return o
})
}

function match(){
const map=new Map()
L2.forEach(r=>{
map.set(norm(r.EAN),r)
})
const out=[]
L1.forEach(r=>{
const m=map.get(norm(r.ean))
out.push({
marka:r.marka,
urun:r.ad,
compel:r.stok,
tsoft:m?m.Stok:'—',
durum:m?'✓':'✕'
})
})
return out
}

function render(rows){
const t=document.getElementById("result")
t.innerHTML='<tr><th>Marka</th><th>Ürün</th><th>Compel</th><th>TSoft</th><th>Durum</th></tr>'
rows.forEach(r=>{
t.innerHTML+=`<tr>
<td>${esc(r.marka)}</td>
<td>${esc(r.urun)}</td>
<td>${esc(r.compel)}</td>
<td>${esc(r.tsoft)}</td>
<td>${r.durum}</td>
</tr>`
})
}

document.getElementById("loadBrands").onclick=loadBrands

document.getElementById("go").onclick=async()=>{
if(!SELECTED.size)return alert("Marka seç")
const f=document.getElementById("csv").files[0]
if(!f)return alert("CSV seç")
document.getElementById("status").textContent="Taranıyor..."
await scanCompel(BRANDS.filter(b=>SELECTED.has(b.id)))
const txt=await f.text()
L2=parseCSV(txt)
const rows=match()
render(rows)
document.getElementById("status").textContent="Hazır"
}
</script>

</body>
</html>
