<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aide Marka Liste</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0d12;color:#eaeef7}
    .wrap{padding:14px;display:flex;gap:12px;flex-wrap:wrap}
    .card{border:1px solid #2a3140;background:#0f1320;border-radius:12px;padding:12px;flex:1 1 420px;min-width:320px}
    h3{margin:0 0 10px;font-size:16px}
    textarea,input{width:100%;box-sizing:border-box;background:#0b0d12;color:#eaeef7;border:1px solid #2a3140;border-radius:10px;padding:10px}
    textarea{min-height:260px;resize:vertical}
    button{
      background:#111827;color:#eaeef7;border:1px solid #2a3140;border-radius:10px;
      padding:9px 12px;font-weight:900;cursor:pointer
    }
    button:hover{background:#1f2a44;border-color:#6b7da6}
    button:disabled{opacity:.55;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .muted{opacity:.85;font-size:12px}
    .ok{color:#86efac}
    .bad{color:#fca5a5}
    .listBox{max-height:520px;overflow:auto;border:1px solid #2a3140;border-radius:10px;background:#0b0d12}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2430;padding:8px 8px;text-align:left;font-size:13px}
    th{position:sticky;top:0;background:#0f1320}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #2a3140;border-radius:999px;background:#0b0d12;font-size:12px;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3>Aide verisini yapıştır</h3>
      <textarea id="paste" placeholder="Aide stok listesini (tablo) kopyalayıp buraya yapıştır..."></textarea>
      <div class="row" style="margin-top:10px">
        <button id="run" type="button">Markaları Çıkar</button>
        <button id="dl" type="button" disabled>CSV indir</button>
        <button id="clr" type="button">Temizle</button>
      </div>
      <div class="muted" id="info" style="margin-top:8px">Sadece “Marka” sütunu taranır. Aynı marka 1 kez listelenir.</div>
      <div class="muted" style="margin-top:8px">
        <span class="pill">İpucu</span> Eğer tablo kopyasında “Marka” başlığı yoksa, satırların ilk hücresini marka kabul eder.
      </div>
    </div>

    <div class="card">
      <h3>Tekil Marka Listesi</h3>
      <div class="muted" id="outInfo">—</div>
      <div class="listBox" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th style="width:70px">Sıra</th>
              <th>Marka</th>
            </tr>
          </thead>
          <tbody id="out"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(() => {
  const TR = "tr-TR";
  const $ = (id) => document.getElementById(id);

  const T = (s) => (s ?? "").toString().trim();
  const norm = (s) => (s ?? "")
    .toString()
    .replace(/\u00A0/g," ")
    .trim()
    .toLocaleUpperCase(TR)
    .replace(/\s+/g," ");

  const isBad = (s) => {
    const x = T(s);
    if (!x) return true;
    const u = x.toLocaleUpperCase(TR).trim();
    return u === "-" || u === "—" || u === "N/A";
  };

  function detectDelimiter(h){
    const c = ["\t",";",",","|"];
    let best = c[0], m = -1;
    for (const d of c){
      const k = h.split(d).length - 1;
      if (k > m){ m = k; best = d; }
    }
    return best;
  }

  function parseDelimited(text){
    const lines = (text ?? "").toString().replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n");
    const first = lines.find(x => x.trim()) || "";
    const delim = detectDelimiter(first);

    const split = (line) => {
      const out=[]; let cur="", q=false;
      for (let i=0;i<line.length;i++){
        const ch=line[i];
        if (ch === '"'){
          if (q && line[i+1] === '"'){ cur+='"'; i++; }
          else q = !q;
        } else if (!q && ch === delim){
          out.push(cur); cur="";
        } else cur += ch;
      }
      out.push(cur);
      return out.map(v => v.trim());
    };

    let hdr=null, rows=[];
    for (const line of lines){
      if (!line || !line.trim()) continue;
      if (!hdr){ hdr = split(line); continue; }
      const vals = split(line), obj = {};
      for (let i=0;i<hdr.length;i++) obj[hdr[i]] = vals[i] ?? "";
      rows.push(obj);
    }
    return { hdr: hdr || [], rows };
  }

  const normHeader = (h) => (h ?? "").toString().trim().toLocaleUpperCase(TR).replace(/\s+/g," ");
  function pickBrandColumn(sampleObj){
    const map = new Map(Object.keys(sampleObj).map(k => [normHeader(k), k]));
    const direct = map.get("MARKA");
    if (direct) return direct;
    // bazı tablolarda Brand geçebilir
    return map.get("BRAND") || null;
  }

  // fallback: noisy tab paste, 1. kolon = Marka
  function extractBrandsFromNoisy(text){
    const lines = (text || "").split(/\r\n|\r|\n/);
    const out = [];
    for (let l of lines){
      l = (l || "").replace(/\u00A0/g," ").trim();
      if (!l) continue;
      if (!l.includes("\t")) continue;
      const a = l.split("\t").map(x => x.trim());
      if (!a.length) continue;
      // header satırını atla
      if (norm(a[0]) === "MARKA") continue;
      out.push(a[0]);
    }
    return out;
  }

  function toCSV(rows){
    const q = (v) => {
      v = (v ?? "").toString();
      return (v.includes('"')||v.includes("\n")||v.includes("\r")||v.includes(","))
        ? ('"' + v.replace(/"/g,'""') + '"') : v;
    };
    return "Sıra,Marka\n" + rows.map(r => `${q(r.no)},${q(r.brand)}`).join("\n");
  }

  function download(filename, text){
    const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1200);
  }

  let last = [];

  $("run").addEventListener("click", () => {
    const raw = $("paste").value || "";
    last = [];
    $("out").innerHTML = "";
    $("dl").disabled = true;

    if (!raw.trim()){
      $("info").innerHTML = `<span class="bad">Metin boş.</span>`;
      return;
    }

    let brands = [];

    // 1) delimited parse dene (Marka sütunu varsa en iyi)
    try{
      const p = parseDelimited(raw);
      if (p.rows?.length){
        const col = pickBrandColumn(p.rows[0]);
        if (col){
          brands = p.rows.map(r => r[col]).filter(Boolean);
        }
      }
    } catch {}

    // 2) olmadıysa noisy fallback
    if (!brands.length){
      brands = extractBrandsFromNoisy(raw);
    }

    // uniq
    const seen = new Map(); // norm -> display
    for (const b of brands){
      if (isBad(b)) continue;
      const n = norm(b);
      if (!n) continue;
      if (!seen.has(n)) seen.set(n, T(b)); // ilk gördüğünü display olarak tut
    }

    const arr = [...seen.entries()]
      .map(([n,disp]) => ({ n, disp }))
      .sort((a,b) => a.disp.localeCompare(b.disp, "tr", {sensitivity:"base"}));

    last = arr.map((x,i) => ({ no: String(i+1), brand: x.disp }));

    // render
    const tb = $("out");
    tb.innerHTML = last.map(r => `<tr><td>${r.no}</td><td>${r.brand}</td></tr>`).join("");

    $("outInfo").innerHTML = `<span class="ok">Bulunan tekil marka:</span> ${last.length}`;
    $("info").innerHTML = `<span class="ok">Bitti.</span> Toplam satırdan tekilleştirildi.`;
    $("dl").disabled = !last.length;
  });

  $("dl").addEventListener("click", () => {
    if (!last.length) return;
    download("aide_markalar.csv", toCSV(last));
  });

  $("clr").addEventListener("click", () => {
    $("paste").value = "";
    $("out").innerHTML = "";
    $("outInfo").textContent = "—";
    $("info").textContent = "Sadece “Marka” sütunu taranır. Aynı marka 1 kez listelenir.";
    $("dl").disabled = true;
    last = [];
  });
})();
</script>
</body>
</html>
