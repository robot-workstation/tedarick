<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Brand Generator (Seçili Markalar)</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121826; --panel2:#0f1522; --text:#e9eef7; --muted:#9aa7bd;
      --line:#22304a; --accent:#7aa2ff; --ok:#2dd4bf; --warn:#fbbf24; --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    body{ margin:0; background:radial-gradient(1200px 700px at 30% -10%, #1b2a50 0%, transparent 60%), var(--bg); color:var(--text); }
    .wrap{ max-width:1200px; margin:0 auto; padding:22px 18px 46px; }
    .grid{ display:grid; gap:16px; grid-template-columns: 1.15fr .85fr; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card header{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: rgba(0,0,0,.18);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    h1{ font-size:16px; margin:0; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:2px; }
    .body{ padding:14px 16px 16px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex: none; }
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.14);
      background: rgba(122,162,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition: transform .06s ease, background .15s ease, opacity .15s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background: rgba(255,255,255,.06); }
    .btn.danger{ background: rgba(251,113,133,.14); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .pill{
      font-size:12px; padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
    }
    .input, select{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
    }
    select{ padding-right:34px; }
    .hint{ color:var(--muted); font-size:12px; line-height:1.35; }
    .drop{
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .drop strong{ display:block; font-size:13px; margin-bottom:2px; }
    .drop .left{ display:flex; flex-direction:column; gap:2px; }
    .filelist{ margin-top:12px; border-top:1px solid rgba(255,255,255,.06); padding-top:10px; }
    table{ width:100%; border-collapse: collapse; }
    th,td{ text-align:left; padding:8px 8px; font-size:12px; border-bottom:1px solid rgba(255,255,255,.06); }
    th{ color:var(--muted); font-weight:600; }
    .small{ font-size:12px; color:var(--muted); }
    .brand-tools{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    .brands{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:8px 10px;
      padding:10px;
      border-radius:14px;
      background: rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.06);
      max-height: 360px;
      overflow:auto;
    }
    @media (max-width: 980px){ .brands{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .brand{
      display:flex; align-items:center; gap:8px;
      padding:8px 8px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }
    .brand input{ width:16px; height:16px; }
    .brand label{ cursor:pointer; font-size:13px; user-select:none; }
    .kpi{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; margin-top:10px; }
    .kpi .box{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:10px 12px;
    }
    .kpi .n{ font-size:18px; font-weight:800; }
    .kpi .t{ font-size:12px; color:var(--muted); margin-top:4px; }
    .log{
      margin-top:10px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      color:#d7e3ff;
      max-height: 220px;
      overflow:auto;
      white-space: pre-wrap;
    }
    .downloads{ display:flex; flex-direction:column; gap:8px; margin-top:12px; }
    .downloads a{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--text);
      text-decoration:none;
      font-size:13px;
    }
    .downloads a span{ color: var(--muted); font-size:12px; }
    .preview{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      overflow:auto;
      max-height: 420px;
      background: rgba(0,0,0,.10);
    }
    .toggle{ display:flex; align-items:center; gap:8px; }
    .toggle input{ width:16px; height:16px; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="grid">
    <!-- SOL: MARKA CHECKBOX + GENERATE -->
    <section class="card">
      <header>
        <div>
          <h1>Markalar (Checkbox kısmı kalsın) + Seçili Markaları Generate</h1>
          <div class="sub">Dosyaları yükledikten sonra sadece seçtiğin markalar için çıktı üretir (tüm listeyi generate etmez).</div>
        </div>
        <div class="pill" id="statusPill">Hazır</div>
      </header>

      <div class="body">
        <div class="brand-tools">
          <input id="brandSearch" class="input" type="text" placeholder="Marka ara..." />
          <button class="btn secondary" id="selectAllBtn" type="button">Tümünü Seç</button>
          <button class="btn secondary" id="clearAllBtn" type="button">Temizle</button>
          <label class="toggle">
            <input id="partialMatch" type="checkbox" checked />
            <span class="small">Kısmi eşleşme (önerilir)</span>
          </label>
        </div>

        <!-- ✅ Checkboxlu marka listesi (burayı kendi listenle değiştirebilirsin) -->
        <div class="brands" id="brandsBox">
          <!-- JS doldurur -->
        </div>

        <div class="kpi">
          <div class="box">
            <div class="n" id="kpiFiles">0</div>
            <div class="t">Yüklenen dosya</div>
          </div>
          <div class="box">
            <div class="n" id="kpiRows">0</div>
            <div class="t">Toplam satır/kayıt</div>
          </div>
          <div class="box">
            <div class="n" id="kpiSelected">0</div>
            <div class="t">Seçili marka</div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <span class="small">Marka alanı:</span>
          <select id="brandFieldSelect" disabled>
            <option value="">(Önce dosya yükle)</option>
          </select>

          <span class="small">Çıktı formatı:</span>
          <select id="formatSelect">
            <option value="both">JSON + CSV</option>
            <option value="json">Sadece JSON</option>
            <option value="csv">Sadece CSV</option>
          </select>

          <button class="btn" id="generateBtn" type="button" disabled>Seçili Markaları Generate</button>
          <button class="btn danger" id="resetBtn" type="button">Sıfırla</button>
        </div>

        <div class="log" id="log"></div>

        <div class="downloads" id="downloads"></div>

        <div class="preview" id="preview" hidden></div>
      </div>
    </section>

    <!-- SAĞ: DOSYA UPLOAD -->
    <aside class="card">
      <header>
        <div>
          <h1>Dosya Yükle</h1>
          <div class="sub">CSV veya JSON yükle. (Birden çok dosya desteklenir.)</div>
        </div>
        <div class="pill">Yerel (Browser)</div>
      </header>

      <div class="body">
        <div class="drop" id="dropzone">
          <div class="left">
            <strong>Sürükle & bırak</strong>
            <span class="hint">…veya butondan seç. CSV/JSON önerilir.</span>
          </div>
          <div>
            <input id="fileInput" type="file" multiple accept=".csv,.json,.txt" hidden />
            <button class="btn secondary" id="pickBtn" type="button">Dosya Seç</button>
          </div>
        </div>

        <div class="filelist">
          <table>
            <thead>
              <tr>
                <th>Dosya</th>
                <th>Tür</th>
                <th>Boyut</th>
                <th>Durum</th>
              </tr>
            </thead>
            <tbody id="fileTbody">
              <tr><td colspan="4" class="small">Henüz dosya yok.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="hint" style="margin-top:10px;">
          Not: Bu araç, yüklediğin dosyalardan okuduğu kayıtlarda marka alanına göre filtreleyip sadece seçtiğin markaların çıktısını indirilebilir olarak üretir.
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
  // =========================
  // 1) MARKA LİSTESİ (checkbox)
  // =========================
  // Buradaki listeyi "ilk kodlardaki" marka listene birebir yapıştırıp kullan.
  const BRAND_LIST = [
    "Adidas","Nike","Puma","Reebok","New Balance","Under Armour","Asics",
    "Converse","Vans","Skechers","Lacoste","Tommy Hilfiger","Calvin Klein",
    "Hummel","Kappa","Fila","Columbia","The North Face","Jack Wolfskin",
    "Mavi","Levi's","Diesel","Zara","H&M","Bershka","Pull&Bear","Massimo Dutti",
    "LC Waikiki","Koton","DeFacto"
  ];

  // =========================
  // 2) STATE
  // =========================
  const state = {
    files: [],
    parsedRows: [], // unified array of objects
    fields: [],
    brandField: "",
  };

  // =========================
  // 3) DOM
  // =========================
  const brandsBox = document.getElementById("brandsBox");
  const brandSearch = document.getElementById("brandSearch");
  const selectAllBtn = document.getElementById("selectAllBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");
  const partialMatch = document.getElementById("partialMatch");
  const brandFieldSelect = document.getElementById("brandFieldSelect");
  const formatSelect = document.getElementById("formatSelect");
  const generateBtn = document.getElementById("generateBtn");
  const resetBtn = document.getElementById("resetBtn");
  const statusPill = document.getElementById("statusPill");

  const pickBtn = document.getElementById("pickBtn");
  const fileInput = document.getElementById("fileInput");
  const dropzone = document.getElementById("dropzone");
  const fileTbody = document.getElementById("fileTbody");

  const kpiFiles = document.getElementById("kpiFiles");
  const kpiRows = document.getElementById("kpiRows");
  const kpiSelected = document.getElementById("kpiSelected");

  const logEl = document.getElementById("log");
  const downloads = document.getElementById("downloads");
  const preview = document.getElementById("preview");

  // =========================
  // 4) HELPERS
  // =========================
  function setStatus(text, type="neutral"){
    statusPill.textContent = text;
    const map = { neutral:"rgba(255,255,255,.06)", ok:"rgba(45,212,191,.12)", warn:"rgba(251,191,36,.12)", bad:"rgba(251,113,133,.12)" };
    statusPill.style.background = map[type] || map.neutral;
    statusPill.style.borderColor = "rgba(255,255,255,.12)";
    statusPill.style.color = (type==="neutral") ? "var(--muted)" : "var(--text)";
  }

  function log(msg){
    const ts = new Date().toLocaleTimeString("tr-TR");
    logEl.textContent += `[${ts}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function humanSize(bytes){
    if (!Number.isFinite(bytes)) return "-";
    const u = ["B","KB","MB","GB"];
    let i=0; let n=bytes;
    while(n>=1024 && i<u.length-1){ n/=1024; i++; }
    return `${n.toFixed(i===0?0:1)} ${u[i]}`;
  }

  function normalizeTR(s){
    if (s == null) return "";
    let x = String(s).trim().toLocaleLowerCase("tr-TR");
    x = x.replaceAll("ı","i").replaceAll("İ","i");
    x = x.replaceAll("ş","s").replaceAll("ğ","g").replaceAll("ü","u").replaceAll("ö","o").replaceAll("ç","c");
    x = x.normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    x = x.replace(/\s+/g," ").trim();
    return x;
  }

  function nowStamp(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  }

  function downloadBlob(filename, blob){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    downloads.appendChild(a);
    a.innerHTML = `<div>${escapeHtml(filename)}</div><span>İndir</span>`;
    a.addEventListener("click", ()=> setTimeout(()=> URL.revokeObjectURL(url), 5000));
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }

  // CSV parse (delimiter auto-detect, quoted fields)
  function detectDelimiter(line){
    const candidates = [",",";","\t","|"];
    let best = ",";
    let bestCount = -1;
    for (const d of candidates){
      const cnt = (line.split(d).length - 1);
      if (cnt > bestCount){ bestCount = cnt; best = d; }
    }
    return best;
  }

  function parseCSV(text){
    const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim().length>0);
    if (!lines.length) return [];
    const delim = detectDelimiter(lines[0]);
    const rows = [];
    const header = splitCSVLine(lines[0], delim).map(h=>h.trim());
    for (let i=1;i<lines.length;i++){
      const cols = splitCSVLine(lines[i], delim);
      const obj = {};
      for (let j=0;j<header.length;j++){
        obj[header[j]] = (cols[j] ?? "").trim();
      }
      rows.push(obj);
    }
    return rows;
  }

  function splitCSVLine(line, delim){
    const out = [];
    let cur = "";
    let inQuotes = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"'){
        if (inQuotes && line[i+1] === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
      } else if (ch === delim && !inQuotes){
        out.push(cur);
        cur = "";
      } else {
        cur += ch;
      }
    }
    out.push(cur);
    return out;
  }

  function toCSV(rows){
    if (!rows.length) return "";
    const keys = Array.from(new Set(rows.flatMap(r=>Object.keys(r))));
    const esc = (v)=>{
      const s = (v==null) ? "" : String(v);
      if (/[",\n\r;]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    };
    const header = keys.map(esc).join(",");
    const body = rows.map(r => keys.map(k=>esc(r[k])).join(",")).join("\n");
    return header + "\n" + body;
  }

  function uniqueFields(rows){
    const set = new Set();
    for (const r of rows){
      for (const k of Object.keys(r || {})) set.add(k);
    }
    return Array.from(set);
  }

  function guessBrandField(fields){
    const prefs = ["brand","Brand","BRAND","marka","Marka","MARKA","manufacturer","Manufacturer","vendor","Vendor"];
    for (const p of prefs){
      const found = fields.find(f => normalizeTR(f) === normalizeTR(p));
      if (found) return found;
    }
    return fields[0] || "";
  }

  function getSelectedBrands(){
    const checked = Array.from(brandsBox.querySelectorAll('input[type="checkbox"]:checked'));
    return checked.map(i => i.value);
  }

  function matchBrand(rowBrand, selectedBrand, allowPartial){
    const a = normalizeTR(rowBrand);
    const b = normalizeTR(selectedBrand);
    if (!a || !b) return false;
    if (allowPartial) return a === b || a.includes(b) || b.includes(a);
    return a === b;
  }

  // =========================
  // 5) UI: BRAND CHECKBOXES
  // =========================
  function renderBrands(filterText=""){
    const q = normalizeTR(filterText);
    brandsBox.innerHTML = "";
    const frag = document.createDocumentFragment();
    for (const brand of BRAND_LIST){
      if (q && !normalizeTR(brand).includes(q)) continue;
      const id = "b_" + normalizeTR(brand).replace(/[^a-z0-9]+/g,"_");
      const div = document.createElement("div");
      div.className = "brand";
      div.innerHTML = `
        <input id="${escapeHtml(id)}" type="checkbox" value="${escapeHtml(brand)}" />
        <label for="${escapeHtml(id)}">${escapeHtml(brand)}</label>
      `;
      frag.appendChild(div);
    }
    brandsBox.appendChild(frag);
    syncKPIs();
  }

  brandSearch.addEventListener("input", ()=> renderBrands(brandSearch.value));

  selectAllBtn.addEventListener("click", ()=>{
    brandsBox.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    syncKPIs();
  });

  clearAllBtn.addEventListener("click", ()=>{
    brandsBox.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    syncKPIs();
  });

  brandsBox.addEventListener("change", syncKPIs);

  // =========================
  // 6) FILE UPLOAD
  // =========================
  pickBtn.addEventListener("click", ()=> fileInput.click());
  fileInput.addEventListener("change", ()=> handleFiles(fileInput.files));

  ;["dragenter","dragover"].forEach(evt=>{
    dropzone.addEventListener(evt, (e)=>{
      e.preventDefault();
      e.stopPropagation();
      dropzone.style.borderColor = "rgba(122,162,255,.55)";
      dropzone.style.background = "rgba(122,162,255,.10)";
    });
  });
  ;["dragleave","drop"].forEach(evt=>{
    dropzone.addEventListener(evt, (e)=>{
      e.preventDefault();
      e.stopPropagation();
      dropzone.style.borderColor = "rgba(255,255,255,.18)";
      dropzone.style.background = "rgba(255,255,255,.04)";
    });
  });
  dropzone.addEventListener("drop", (e)=>{
    const dt = e.dataTransfer;
    if (dt && dt.files && dt.files.length) handleFiles(dt.files);
  });

  async function handleFiles(fileList){
    downloads.innerHTML = "";
    preview.hidden = true;
    preview.innerHTML = "";
    logEl.textContent = "";

    state.files = Array.from(fileList || []);
    state.parsedRows = [];
    state.fields = [];
    state.brandField = "";

    renderFileTable();
    syncKPIs();

    if (!state.files.length){
      setStatus("Dosya yok", "warn");
      generateBtn.disabled = true;
      brandFieldSelect.disabled = true;
      brandFieldSelect.innerHTML = `<option value="">(Önce dosya yükle)</option>`;
      return;
    }

    setStatus("Okunuyor…", "warn");
    log(`Toplam ${state.files.length} dosya yükleme kuyruğa alındı.`);

    for (const f of state.files){
      await parseOneFile(f);
    }

    state.fields = uniqueFields(state.parsedRows);
    state.brandField = guessBrandField(state.fields);

    // brand field select
    brandFieldSelect.disabled = state.fields.length === 0;
    brandFieldSelect.innerHTML = state.fields.length
      ? state.fields.map(k => `<option value="${escapeHtml(k)}">${escapeHtml(k)}</option>`).join("")
      : `<option value="">(Alan bulunamadı)</option>`;
    if (state.brandField){
      brandFieldSelect.value = state.brandField;
    } else if (state.fields[0]) {
      brandFieldSelect.value = state.fields[0];
      state.brandField = state.fields[0];
    }

    brandFieldSelect.addEventListener("change", ()=>{
      state.brandField = brandFieldSelect.value;
      log(`Marka alanı seçildi: "${state.brandField}"`);
    }, { once:false });

    setStatus("Hazır", "ok");
    log(`Okuma tamamlandı. Toplam kayıt: ${state.parsedRows.length}`);
    syncKPIs();
    generateBtn.disabled = !(state.parsedRows.length && getSelectedBrands().length);
  }

  async function parseOneFile(file){
    const tr = fileTbody.querySelector(`tr[data-name="${CSS.escape(file.name)}"]`);
    const setRowStatus = (txt)=>{ if (tr) tr.querySelector("[data-status]").textContent = txt; };

    try{
      setRowStatus("Okunuyor…");
      const text = await file.text();
      const name = file.name.toLowerCase();

      let rows = [];

      if (name.endsWith(".json")){
        const obj = JSON.parse(text);
        if (Array.isArray(obj)) rows = obj;
        else if (obj && Array.isArray(obj.items)) rows = obj.items;
        else if (obj && Array.isArray(obj.data)) rows = obj.data;
        else rows = [obj];
        // ensure objects
        rows = rows.map(x => (x && typeof x === "object") ? x : ({ value: x }));
      } else if (name.endsWith(".csv")){
        rows = parseCSV(text);
      } else if (name.endsWith(".txt")){
        // basit: her satırı bir kayıt olarak al
        const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim().length>0);
        rows = lines.map(l => ({ line: l }));
      } else {
        // fallback: try CSV then JSON
        try { rows = parseCSV(text); }
        catch { rows = [JSON.parse(text)]; }
      }

      state.parsedRows.push(...rows);
      setRowStatus(`OK (${rows.length})`);
      log(`"${file.name}" okundu: ${rows.length} kayıt.`);
      renderFileTable(); // refresh counts
    }catch(err){
      console.error(err);
      setRowStatus("HATA");
      log(`"${file.name}" okunamadı: ${err?.message || err}`);
    }
  }

  function renderFileTable(){
    if (!state.files.length){
      fileTbody.innerHTML = `<tr><td colspan="4" class="small">Henüz dosya yok.</td></tr>`;
      return;
    }
    fileTbody.innerHTML = state.files.map(f => `
      <tr data-name="${escapeHtml(f.name)}">
        <td>${escapeHtml(f.name)}</td>
        <td>${escapeHtml((f.name.split(".").pop() || "").toUpperCase())}</td>
        <td>${escapeHtml(humanSize(f.size))}</td>
        <td data-status>Bekliyor…</td>
      </tr>
    `).join("");
  }

  // =========================
  // 7) GENERATE (ONLY SELECTED BRANDS)
  // =========================
  function syncKPIs(){
    kpiFiles.textContent = String(state.files.length);
    kpiRows.textContent = String(state.parsedRows.length);
    kpiSelected.textContent = String(getSelectedBrands().length);
    if (state.parsedRows.length){
      generateBtn.disabled = !(getSelectedBrands().length && state.brandField);
    }
  }

  generateBtn.addEventListener("click", ()=>{
    downloads.innerHTML = "";
    preview.hidden = true;
    preview.innerHTML = "";

    const selected = getSelectedBrands();
    const allowPartial = partialMatch.checked;

    if (!state.parsedRows.length){
      setStatus("Kayıt yok", "warn");
      log("Generate iptal: önce dosya yükle.");
      return;
    }
    if (!selected.length){
      setStatus("Marka seç", "warn");
      log("Generate iptal: en az 1 marka seç.");
      return;
    }
    if (!state.brandField){
      setStatus("Marka alanı yok", "warn");
      log("Generate iptal: marka alanı seçilemedi.");
      return;
    }

    setStatus("Generate…", "warn");
    log(`Generate başlıyor. Seçili marka sayısı: ${selected.length}. Marka alanı: "${state.brandField}".`);

    // Filter only selected brands (do NOT generate all)
    const perBrand = new Map();
    for (const b of selected) perBrand.set(b, []);

    for (const row of state.parsedRows){
      const val = row?.[state.brandField];
      for (const b of selected){
        if (matchBrand(val, b, allowPartial)){
          perBrand.get(b).push(row);
          break;
        }
      }
    }

    // merged filtered
    const merged = [];
    for (const b of selected) merged.push(...perBrand.get(b));

    const fmt = formatSelect.value; // both/json/csv
    const stamp = nowStamp();

    // downloads: merged
    if (fmt === "both" || fmt === "json"){
      const blob = new Blob([JSON.stringify(merged, null, 2)], { type:"application/json;charset=utf-8" });
      downloadBlob(`filtered_selected_brands_${stamp}.json`, blob);
      log(`Birleşik JSON hazır: ${merged.length} kayıt.`);
    }
    if (fmt === "both" || fmt === "csv"){
      const csv = toCSV(merged);
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
      downloadBlob(`filtered_selected_brands_${stamp}.csv`, blob);
      log(`Birleşik CSV hazır: ${merged.length} kayıt.`);
    }

    // downloads: per brand
    for (const b of selected){
      const rows = perBrand.get(b) || [];
      const safe = normalizeTR(b).replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");
      if (fmt === "both" || fmt === "json"){
        const blob = new Blob([JSON.stringify(rows, null, 2)], { type:"application/json;charset=utf-8" });
        downloadBlob(`brand_${safe}_${stamp}.json`, blob);
      }
      if (fmt === "both" || fmt === "csv"){
        const csv = toCSV(rows);
        const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
        downloadBlob(`brand_${safe}_${stamp}.csv`, blob);
      }
      log(`Marka "${b}": ${rows.length} kayıt.`);
    }

    // preview table (first 200 merged)
    const keys = uniqueFields(merged).slice(0, 18);
    const head = `<thead><tr>${keys.map(k=>`<th>${escapeHtml(k)}</th>`).join("")}</tr></thead>`;
    const body = `<tbody>${
      merged.slice(0, 200).map(r => `<tr>${
        keys.map(k => `<td>${escapeHtml(r?.[k] ?? "")}</td>`).join("")
      }</tr>`).join("")
    }</tbody>`;
    preview.innerHTML = `<table>${head}${body}</table>`;
    preview.hidden = false;

    setStatus("Bitti", "ok");
    log("Generate tamamlandı (sadece seçili markalar).");
  });

  // =========================
  // 8) RESET
  // =========================
  resetBtn.addEventListener("click", ()=>{
    state.files = [];
    state.parsedRows = [];
    state.fields = [];
    state.brandField = "";

    fileInput.value = "";
    downloads.innerHTML = "";
    preview.hidden = true;
    preview.innerHTML = "";
    logEl.textContent = "";

    renderFileTable();
    renderBrands(brandSearch.value);
    brandFieldSelect.disabled = true;
    brandFieldSelect.innerHTML = `<option value="">(Önce dosya yükle)</option>`;
    generateBtn.disabled = true;

    setStatus("Sıfırlandı", "neutral");
    syncKPIs();
  });

  // enable generate when brand selection changes and data exists
  brandsBox.addEventListener("change", ()=>{
    if (state.parsedRows.length){
      generateBtn.disabled = !(getSelectedBrands().length && brandFieldSelect.value);
    }
  });

  // =========================
  // INIT
  // =========================
  setStatus("Hazır", "neutral");
  renderBrands("");
  syncKPIs();
  log("Hazır. Dosya yükle, marka seç, sonra sadece seçili markaları generate et.");
</script>
</body>
</html>
